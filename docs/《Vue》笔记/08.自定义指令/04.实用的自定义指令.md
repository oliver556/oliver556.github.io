---
title: å®ç”¨çš„è‡ªå®šä¹‰æŒ‡ä»¤
date: 2022-07-08 16:31:01
permalink: /pages/382978/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Vue.js2
---

# å®ç”¨çš„è‡ªå®šä¹‰æŒ‡ä»¤

## ğŸ“–. å‰è¨€

ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤å¯ä»¥æ»¡è¶³æˆ‘ä»¬æ—¥å¸¸ä¸€äº›åœºæ™¯ï¼Œè¿™é‡Œç»™å‡ºå‡ ä¸ªè‡ªå®šä¹‰æŒ‡ä»¤çš„æ¡ˆä¾‹ï¼š

## ä¸€. æ‰¹é‡æ³¨å†ŒæŒ‡ä»¤

æ–°å»º `directives/index.js` æ–‡ä»¶

```js
import copy from './copy';
import emoji from './emoji';

// è‡ªå®šä¹‰æŒ‡ä»¤
const directives = {
  copy,
  emoji
}
// è¿™ç§å†™æ³•å¯ä»¥æ‰¹é‡æ³¨å†ŒæŒ‡ä»¤
export default {
  install (Vue) {
    Object.keys(directives).forEach((key) => {
      Vue.directive(key, directives[key]);
    })
  }
}
```

åœ¨ `main.js` å¼•å…¥å¹¶è°ƒç”¨

```js
import Vue from 'vue';
import Directives from './JS/directives';
Vue.use(Directives);
```

## å®ç”¨æŒ‡ä»¤åˆ†äº«

### 1. ä¸€é”® Copy

- **éœ€æ±‚**ï¼š  
å®ç°ä¸€é”®å¤åˆ¶æ–‡æœ¬å†…å®¹ï¼Œç”¨äºé¼ æ ‡å³é”®ç²˜è´´ã€‚

- **æ€è·¯**ï¼š      
1.åŠ¨æ€åˆ›å»º `textarea` æ ‡ç­¾ï¼Œå¹¶è®¾ç½® `readOnly` å±æ€§åŠç§»å‡ºå¯è§†åŒºåŸŸ  
2.å°†è¦å¤åˆ¶çš„å€¼èµ‹ç»™ `textarea` æ ‡ç­¾çš„ `value` å±æ€§ï¼Œå¹¶æ’å…¥åˆ° `body`  
3.é€‰ä¸­å€¼ `textarea` å¹¶å¤åˆ¶  
4.å°† `body` ä¸­æ’å…¥çš„ `textarea` ç§»é™¤  
5.åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ç»‘å®šäº‹ä»¶ï¼Œåœ¨è§£ç»‘æ—¶ç§»é™¤äº‹ä»¶  

```js
import { Message } from 'element-ui';

const copy = {
  /*
    bind é’©å­å‡½æ•°ï¼Œç¬¬ä¸€æ¬¡ç»‘å®šæ—¶è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œåšåˆå§‹åŒ–è®¾ç½®
    el: ä½œç”¨çš„ dom å¯¹è±¡
    value: ä¼ ç»™æŒ‡ä»¤çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ copy çš„å€¼
  */
  bind (el, { value }) {
    el.$value = value // ç”¨ä¸€ä¸ªå…¨å±€å±æ€§æ¥å­˜ä¼ è¿›æ¥çš„å€¼ï¼Œå› ä¸ºè¿™ä¸ªå€¼åœ¨åˆ«çš„é’©å­å‡½æ•°é‡Œè¿˜ä¼šç”¨åˆ°
    el.handler = () => {
      // å€¼ä¸ºç©ºçš„æ—¶å€™ï¼Œç»™å‡ºæç¤ºã€‚
      if (!el.$value) {
        // å¯æ ¹æ®é¡¹ç›® UI ä»”ç»†è®¾è®¡
        Message.warning('æ— å¤åˆ¶å†…å®¹');
        console.log('æ— å¤åˆ¶å†…å®¹');
        return
      }
      // åŠ¨æ€åˆ›å»º textarea æ ‡ç­¾
      const textarea = document.createElement('textarea')
      // å°†è¯¥ textarea è®¾ä¸º readonly é˜²æ­¢ iOS ä¸‹è‡ªåŠ¨å”¤èµ·é”®ç›˜ï¼ŒåŒæ—¶å°† textarea ç§»å‡ºå¯è§†åŒºåŸŸ
      textarea.readOnly = 'readonly'
      textarea.style.position = 'absolute'
      textarea.style.left = '-9999px'
      // å°†è¦ copy çš„å€¼èµ‹ç»™ textarea æ ‡ç­¾çš„ value å±æ€§
      textarea.value = el.$value
      // å°† textarea æ’å…¥åˆ° body ä¸­
      document.body.appendChild(textarea)
      // é€‰ä¸­å€¼å¹¶å¤åˆ¶
      textarea.select()
      const result = document.execCommand('Copy')
      if (result) {
        // å¯æ ¹æ®é¡¹ç›® UI ä»”ç»†è®¾è®¡
        Message.success('å¤åˆ¶æˆåŠŸ');
        console.log('å¤åˆ¶æˆåŠŸ');
      }
      document.body.removeChild(textarea)
    }
    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå°±æ˜¯æ‰€è°“çš„ä¸€é”® copy å•¦
    el.addEventListener('click', el.handler)
  },
  // å½“ä¼ è¿›æ¥çš„å€¼æ›´æ–°çš„æ—¶å€™è§¦å‘
  componentUpdated (el, { value }) {
    el.$value = value
  },
  // æŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘çš„æ—¶å€™ï¼Œç§»é™¤äº‹ä»¶ç»‘å®š
  unbind (el) {
    el.removeEventListener('click', el.handler)
  }
}

export default copy
```

### 2. æ‡’åŠ è½½

- **èƒŒæ™¯**ï¼š  
åœ¨ç±»ç”µå•†ç±»é¡¹ç›®ï¼Œå¾€å¾€å­˜åœ¨å¤§é‡çš„å›¾ç‰‡ï¼Œå¦‚ banner å¹¿å‘Šå›¾ï¼Œèœå•å¯¼èˆªå›¾ï¼Œç¾å›¢ç­‰å•†å®¶åˆ—è¡¨å¤´å›¾ç­‰ã€‚å›¾ç‰‡ä¼—å¤šä»¥åŠå›¾ç‰‡ä½“ç§¯è¿‡å¤§å¾€å¾€ä¼šå½±å“é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œé€ æˆä¸è‰¯çš„ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥è¿›è¡Œå›¾ç‰‡æ‡’åŠ è½½ä¼˜åŒ–åŠ¿åœ¨å¿…è¡Œã€‚

- **éœ€æ±‚**ï¼š  
å®ç°ä¸€ä¸ªå›¾ç‰‡æ‡’åŠ è½½æŒ‡ä»¤ï¼ŒåªåŠ è½½æµè§ˆå™¨å¯è§åŒºåŸŸçš„å›¾ç‰‡ã€‚

- **æ€è·¯**ï¼š  
1.å›¾ç‰‡æ‡’åŠ è½½çš„åŸç†ä¸»è¦æ˜¯åˆ¤æ–­å½“å‰å›¾ç‰‡æ˜¯å¦åˆ°äº†å¯è§†åŒºåŸŸè¿™ä¸€æ ¸å¿ƒé€»è¾‘å®ç°çš„  
2.æ‹¿åˆ°æ‰€æœ‰çš„å›¾ç‰‡ `Dom` ï¼Œéå†æ¯ä¸ªå›¾ç‰‡åˆ¤æ–­å½“å‰å›¾ç‰‡æ˜¯å¦åˆ°äº†å¯è§†åŒºèŒƒå›´å†…  
3.å¦‚æœåˆ°äº†å°±è®¾ç½®å›¾ç‰‡çš„ `src` å±æ€§ï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤å›¾ç‰‡  

å›¾ç‰‡æ‡’åŠ è½½æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ï¼Œä¸€æ˜¯ç»‘å®š `srcoll` äº‹ä»¶è¿›è¡Œç›‘å¬ï¼ŒäºŒæ˜¯ä½¿ç”¨ `IntersectionObserver` åˆ¤æ–­å›¾ç‰‡æ˜¯å¦åˆ°äº†å¯è§†åŒºåŸŸï¼Œä½†æ˜¯æœ‰æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ã€‚

ä¸‹é¢å°è£…ä¸€ä¸ªæ‡’åŠ è½½æŒ‡ä»¤å…¼å®¹ä¸¤ç§æ–¹æ³•ï¼Œåˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒ `IntersectionObserver` APIï¼Œå¦‚æœæ”¯æŒå°±ä½¿ç”¨ `IntersectionObserver` å®ç°æ‡’åŠ è½½ï¼Œå¦åˆ™åˆ™ä½¿ç”¨ `srcoll` äº‹ä»¶ç›‘å¬ + èŠ‚æµçš„æ–¹æ³•å®ç°ã€‚

```js
const LazyLoad = {
  // install æ–¹æ³•
  install (Vue, options) {
    let defaultSrc = options.default;
    Vue.directive('lazy', {
      bind (el, binding) {
        LazyLoad.init(el, binding.value, defaultSrc);
      },
      inserted (el) {
        // å…¼å®¹å¤„ç†
        if (IntersectionObserver) {
          LazyLoad.observe(el);
        } else {
          LazyLoad.listenerScroll(el);
        }

      },
    })
  },
  // åˆå§‹åŒ–
  init (el, val, def) {
    // data-src å‚¨å­˜çœŸå® src
    el.setAttribute('data-src', val);
    // è®¾ç½® src ä¸º loading å›¾
    el.setAttribute('src', def);
  },
  // åˆ©ç”¨ IntersectionObserver ç›‘å¬ el
  observe (el) {
    var io = new IntersectionObserver(entries => {
      let realSrc = el.dataset.src;
      if (entries[0].isIntersecting) {
        if (realSrc) {
          el.src = realSrc;
          el.removeAttribute('data-src');
        }
      }
    });
    io.observe(el);
  },
  // ç›‘å¬ scroll äº‹ä»¶
  listenerScroll (el) {
    let handler = LazyLoad.throttle(LazyLoad.load, 300);
    LazyLoad.load(el);
    window.addEventListener('scroll', () => {
      handler(el);
    });
  },
  // åŠ è½½çœŸå®å›¾ç‰‡
  load (el) {
    let windowHeight = document.documentElement.clientHeight
    let elTop = el.getBoundingClientRect().top;
    let elBtm = el.getBoundingClientRect().bottom;
    let realSrc = el.dataset.src;
    if (elTop - windowHeight < 0 && elBtm > 0) {
      if (realSrc) {
        el.src = realSrc;
        el.removeAttribute('data-src');
      }
    }
  },
  // èŠ‚æµ
  throttle (fn, delay) {
    let timer;
    let prevTime;
    return function (...args) {
      let currTime = Date.now();
      let context = this;
      if (!prevTime) prevTime = currTime;
      clearTimeout(timer);

      if (currTime - prevTime > delay) {
        prevTime = currTime;
        fn.apply(context, args);
        clearTimeout(timer);
        return;
      }

      timer = setTimeout(function () {
        prevTime = Date.now();
        timer = null;
        fn.apply(context, args);
      }, delay);
    }
  }

}

export default LazyLoad;
```

### 3. è¡¨å•é˜²æ­¢é‡å¤æäº¤

- **éœ€æ±‚**ï¼š  
å®ç°ä¸€ä¸ªé‡å¤æäº¤æŒ‡ä»¤ï¼Œç”¨äºè¡¨å•æäº¤æ—¶ã€‚

```js
Vue.directive('throttle', {
  bind: (el, binding) => {
    let throttleTime = binding.value; // èŠ‚æµæ—¶é—´
    if (!throttleTime) { // ç”¨æˆ·è‹¥ä¸è®¾ç½®èŠ‚æµæ—¶é—´ï¼Œåˆ™é»˜è®¤2s
      throttleTime = 2000;
    }
    let cbFun;
    el.addEventListener('click', event => {
      if (!cbFun) { // ç¬¬ä¸€æ¬¡æ‰§è¡Œ
        cbFun = setTimeout(() => {
          cbFun = null;
        }, throttleTime);
      } else {
        event && event.stopImmediatePropagation();
      }
    }, true);
  },
});
```

```html
<!-- ä¸º button æ ‡ç­¾è®¾ç½® v-throttle è‡ªå®šä¹‰æŒ‡ä»¤ -->
<button @click="sayHello" v-throttle>æäº¤</button>
```

> å…³äºè‡ªå®šä¹‰æŒ‡ä»¤è¿˜æœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ï¼Œå¦‚ï¼šæ‹–æ‹½æŒ‡ä»¤ã€é¡µé¢æ°´å°ã€æƒé™æ ¡éªŒç­‰ç­‰åº”ç”¨åœºæ™¯
