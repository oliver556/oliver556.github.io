---
title: Jest å•å…ƒæµ‹è¯•ç¯å¢ƒæ­å»º
date: 2022-07-09 21:32:44
permalink: /pages/343eae/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - å•å…ƒæµ‹è¯•
---

# Jest å•å…ƒæµ‹è¯•ç¯å¢ƒæ­å»º

## ä¸€. ä¾èµ–è¯´æ˜

ä¸‹é¢åˆ—å‡ºäº†ä¸€äº›ä½¿ç”¨ Jest æµ‹è¯•ç›¸å…³çš„ä¾èµ–è¯´æ˜åŠé…ç½®ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„éœ€æ±‚è¿›è¡Œå®‰è£…ã€‚å¦‚æœä½ æƒ³å¿«é€Ÿå®‰è£…è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ° [å¿«é€Ÿå¼€å§‹](#ä¸ƒ-å¿«é€Ÿå¼€å§‹)ã€‚

### 1. æµ‹è¯•è¿è¡Œå™¨ â€” Jest

å®˜æ–¹æ¨èçš„å…¶ä¸­ä¸€ç§é…ç½®ç®€å•ã€é›†æˆå®Œå–„çš„æµ‹è¯•æœºè¿è¡Œå™¨ã€‚

```bash
npm i --save-dev jest
```

é…ç½® `package.json` è®¾ç½® `scripts` å¯åŠ¨ï¼Œæ›´å¤šå¸¸ç”¨é…ç½®è¯·è·³è½¬åˆ° [Jest çš„è„šæœ¬](#å››-jest-çš„è„šæœ¬)

```json
{
  ...
  "scripts": {
    "test": "jest",
    "test:init": "jest --init",
    "test:coverage": "jest --coverage"
  },
  ...
}
```

### 2. æ”¯æŒ TS

```bash
npm i ts-jest @types/jest
```

é…ç½® `jest.config.js`

```js
...
transform: {
  transform: {
    '^.+\\.(t|j)sx?$': [
      'babel-jest', {
        presets: [
          '@babel/preset-typescript',
        ],
      },
    ],
  },
},
...
```

### 3. Babel è½¬è¯‘

è™½ç„¶æœ€æ–°ç‰ˆæœ¬çš„ `Node` å·²ç»æ”¯æŒç»å¤§å¤šæ•°çš„ `ES2015` ç‰¹æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æƒ³åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ `ES modules` è¯­æ³•ã€‚æ‰€ä»¥éœ€è¦éœ€è¦å®‰è£… `babel-jest` è¿›è¡Œè¯­æ³•è½¬ä¹‰ã€‚

```bash
npm i --save-dev babel-jest       @babel/core @babel/preset-env
```

é…ç½® `babel.config.json`

```js
{
  "presets": [
    [
      "@babel/preset-env", {
      "targets": {
        "node": "current"
      }
    }
    ]
  ]
}
```

### 4. å•å…ƒæµ‹è¯•å®ç”¨å·¥å…·åº“â€”vue-test-utils

`Vue Test Utils` æ˜¯ `Vue.js` å®˜æ–¹çš„å•å…ƒæµ‹è¯•å®ç”¨å·¥å…·åº“ï¼Œé€šè¿‡ä¸¤è€…ç»“åˆæ¥æµ‹è¯•éªŒè¯ç ç»„ä»¶ï¼Œè¦†ç›–å„åŠŸèƒ½æµ‹è¯•

```bash
npm i --save-dev @vue/test-utils
```

### 5. å¤„ç†å•æ–‡ä»¶ç»„ä»¶

å‘Šè¯‰ `Jest` å¦‚ä½•å¤„ç† `*.vue` æ–‡ä»¶

```bash
npm i --save-dev vue-jest
```

é…ç½® `jest.config.js` æ–‡ä»¶

```js
...
transform: {
 '^.+\\.vue$': 'vue-jest',
},
...
```

### 6. ä½¿ç”¨ Eslint æ£€æµ‹

```bash
npm i --save-dev eslint-plugin-jest
```

é…ç½® `.eslintrc` æ–‡ä»¶

```js
...
"extends": [
    "plugin:jest/recommended"
  ],
...
```

### 7. å¿«ç…§æ ¼å¼åŒ–

é»˜è®¤å¿«ç…§æµ‹è¯•ï¼Œè¾“å‡ºæ–‡ä»¶åŒ…å«å¤§é‡è½¬ä¹‰ç¬¦å·â€/â€œï¼Œéœ€è¦é€šè¿‡ `jest-serializer-vue` æ’ä»¶å¤„ç†ï¼Œå¯ä»¥è‡ªå®šä¹‰å¿«ç…§è¾“å‡ºç›®å½•ä½ç½®

```bash
npm i --save-dev jest-serializer-vue
```

é…ç½® `jest.config.js` æ–‡ä»¶

```js
...
// å¤„ç†å¿«ç…§æ–‡ä»¶è½¬ä¹‰ç¬¦
snapshotSerializers: ["<rootDir>/node_modules/jest-serializer-vue"],
// ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ç±»å‹
coverageReporters: ['json', 'html'],
// è¦†ç›–ç‡æŠ¥å‘Šçš„ç›®å½•ï¼Œæµ‹è¯•æŠ¥å‘Šæ‰€å­˜æ”¾çš„ä½ç½®
coverageDirectory: './coverage-reports',
...
```

### 8. æµè§ˆå™¨æ˜¾ç¤ºæµ‹è¯•ç»“æœ

æ‰§è¡Œæµ‹è¯•åï¼Œä¼šåœ¨é¡¹ç›®æœ€å¤–å±‚ç”Ÿæˆ `test-report.html`ï¼Œç‚¹å¼€å³å¯æŸ¥çœ‹ç»“æœ

```bash
npm i --save-dev jest-html-reporter
```

é…ç½® `jest.config.js` æ–‡ä»¶

```js
...
reporters: [
 // å¯ä»¥è‡ªå®šä¹‰æŠ¥å‘Š
  ["./node_modules/jest-html-reporter", {
  "pageTitle": "Test Report"
  }]
],
æˆ–è€…
"testResultsProcessor": "./node_modules/jest-html-reporter"
...
```

## äºŒ. Jest åŸºæœ¬é…ç½®

ä»¥ä¸‹åªåˆ—å‡ºå¸¸ç”¨çš„é…ç½®ï¼Œæ›´å¤šé…ç½®è¯·å‚è€ƒ [https://jestjs.io/zh-Hans/docs/configuration](https://jestjs.io/zh-Hans/docs/configuration)ã€‚

å¯ä»¥é€šè¿‡ `npm run test:init` åˆ›å»º `jest.config.json` æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«å…¨éƒ¨é…ç½®çš„è¯´æ˜ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼Œå¹¶é…ç½®ã€‚

```js
const path = require('path');

module.exports = {
  // åŒ¹é…æµ‹è¯•ç”¨ä¾‹çš„æ–‡ä»¶
  testMatch: [
    "**/__tests__/**/*.[jt]s?(x)",
    "**/?(*.)+(spec|test).[tj]s?(x)"
  ],
  reporters: [
    "default",
    // éœ€è¦å®‰è£…ä¾èµ–ï¼šjest-html-reporter
    ["./node_modules/jest-html-reporter", {
      "pageTitle": "Test Report"
    }]
  ],
  // æ¿€æ´»æµ‹è¯•ç»“æœé€šçŸ¥
  notify: true,
  // æ¯æ¬¡æµ‹è¯•å‰æ¸…é™¤æ¨¡æ‹Ÿè°ƒç”¨å’Œå®ä¾‹
  clearMocks: true,
  // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ç±»å‹
  coverageReporters: ['json', 'html'],
  // è¦†ç›–ç‡æŠ¥å‘Šçš„ç›®å½•ï¼Œæµ‹è¯•æŠ¥å‘Šæ‰€å­˜æ”¾çš„ä½ç½®
  coverageDirectory: './coverage-reports',
  // å¤„ç†å¿«ç…§æ–‡ä»¶è½¬ä¹‰ç¬¦
 snapshotSerializers: ["<rootDir>/node_modules/jest-serializer-vue"],
  // è½¬æ¢å™¨ -- tséœ€è¦é…ç½®è¯¥é€‰é¡¹
  transform: {
    '^.+\\.(t|j)sx?$': [
      'babel-jest', {
        presets: [
          '@babel/preset-typescript',
        ],
      },
    ],
  },
};
```

## ä¸‰. ç¤ºä¾‹è¯´æ˜

### 1. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

#### (1). è¦æµ‹è¯•çš„ä»£ç 

```js
// fun.js
function foo(a, b) {
  return a + b;
}
export default foo;
```

#### (2). æµ‹è¯•ç”¨ä¾‹

è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ›´å¤šå¸¸ç”¨æ–¹æ³•ã€åŒ¹é…å™¨ç­‰è·³è½¬ [Vue Test Utils å¸¸ç”¨çš„ API](#å…­-vue-test-utils-å¸¸ç”¨çš„-api) ã€ [Jest å¸¸ç”¨ API](#äº”-jest-å¸¸ç”¨-api) ã€‚

```js
// test.js
import foo from './fun.js';
test('add', () => {
  expect(foo(1, 2)).toBe(3);
});
```

### 2. è¿è¡Œæµ‹è¯•

#### (1). é»˜è®¤æµ‹è¯•å‘½ä»¤

```bash
npm run test
```

æ‰§è¡Œæµ‹è¯•åï¼Œæ ¹ç›®å½•ä¸‹ä¼šç”Ÿæˆç›®å½• `coverage-reports/index.html` æ–‡ä»¶ï¼ˆæ–‡ä»¶ç›®å½•å¯ä»¥è‡ªå®šä¹‰ï¼Œå‚è€ƒ `jest.config.js` ä¸­çš„é…ç½®ï¼‰

- è¯­å¥è¦†ç›–ç‡ï¼ˆstatementsï¼‰æ˜¯å¦æ¯ä¸ªè¯­å¥éƒ½æ‰§è¡Œäº† 
- åˆ†æ”¯è¦†ç›–ç‡ï¼ˆbranchesï¼‰æ˜¯å¦æ¯ä¸ªå‡½æ•°éƒ½è°ƒç”¨äº† 
- å‡½æ•°è¦†ç›–ç‡ï¼ˆfunctionsï¼‰æ˜¯å¦æ¯ä¸ª if ä»£ç å—éƒ½æ‰§è¡Œäº† 
- è¡Œè¦†ç›–ç‡ï¼ˆlines) æ˜¯å¦æ¯ä¸€è¡Œéƒ½æ‰§è¡Œäº†

## å››. Jest çš„è„šæœ¬

- `"test": "jest"`ï¼šå¯¹é¡¹ç›®ç›®å½•ä¸‹æµ‹è¯•æ–‡ä»¶è¿›è¡Œ Jest æµ‹è¯•
- `"test:help": "jest --help"`ï¼šæŸ¥çœ‹ cli å‘½ä»¤
- `"test:debug": "jest --debug"`ï¼šdebug
- `"test:verbose": "jest --verbose"`ï¼šä»¥å±‚çº§æ–¹å¼åœ¨æ§åˆ¶å°å±•ç¤ºæµ‹è¯•ç»“æœ
- `"test:noCache": "jest --no-cache"`ï¼šè®¾ç½®æ˜¯å¦ç¼“å­˜ï¼Œæœ‰ç¼“å­˜ä¼šå¿«
- `"test:init": "jest --init"`ï¼šæ ¹ç›®å½•ä¸‹åˆ›å»ºjest.config.jsæ–‡ä»¶
- `"test:caculator": "jest ./test/caculator.test.js"`ï¼šå•æ–‡ä»¶æµ‹è¯•
- `"test:caculator:watch": "jest ./test/caculator.test.js --watch"`ï¼šå•æ–‡ä»¶ç›‘è§†æµ‹è¯•
- `"test:watchAll": "jest --watchAll"`ï¼šç›‘è§†æ‰€æœ‰æ–‡ä»¶æ”¹åŠ¨å¹¶æµ‹è¯•
- `"test:coverage": "jest --coverage"`ï¼šæµ‹è¯•è¦†ç›–ç‡

## äº”. Jest å¸¸ç”¨ API

### 1. å…¨å±€å‡½æ•°

- `describe(name, fn)` æŠŠç›¸å…³æµ‹è¯•ç»„åˆåœ¨ä¸€èµ· 
- `test(name, fn)` æµ‹è¯•æ–¹æ³• 
- `expect(value)` æ–­è¨€ 
- `beforeEach(fn)` åœ¨æ¯ä¸€ä¸ªæµ‹è¯•ä¹‹å‰éœ€è¦åšçš„äº‹æƒ…ï¼Œæ¯”å¦‚æµ‹è¯•ä¹‹å‰å°†æŸä¸ªæ•°æ®æ¢å¤åˆ°åˆå§‹çŠ¶æ€ 
- `afterEach(fn)` åœ¨æ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œç»“æŸä¹‹åè¿è¡Œ 
- `beforeAll(fn)` åœ¨æ‰€æœ‰çš„æµ‹è¯•ä¹‹å‰éœ€è¦åšä»€ä¹ˆ 
- `afterAll(fn)` åœ¨æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œç»“æŸä¹‹åè¿è¡Œ

### 2. åŒ¹é…å™¨

- `toBe` ä½¿ç”¨ `===` æ¥æµ‹è¯•å®Œå…¨ç›¸ç­‰
- `toEqual` é€’å½’æ£€æŸ¥å¯¹è±¡æˆ–æ•°ç»„çš„æ¯ä¸ªå­—æ®µ
- `toContain` åˆ¤æ–­æ•°ç»„æˆ–å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šå€¼
- `toContainEqual` åˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦åŒ…å«ä¸€ä¸ªç‰¹å®šå¯¹è±¡
- `toBeNull` åªåŒ¹é… `null`
- `toBeUndefined` åªåŒ¹é… `undefined`
- `toBeDefined` ä¸ `toBeUndefined` ç›¸å
- `toBeTruthy` åŒ¹é…ä»»ä½• `if` è¯­å¥ä¸ºçœŸ
- `toBeFalsy` åŒ¹é…ä»»ä½• `if` è¯­å¥ä¸ºå‡
- `toThrow` ç‰¹å®šå‡½æ•°æŠ›å‡ºä¸€ä¸ªé”™è¯¯
- `toMatch` æ­£åˆ™åŒ¹é…
- `toThrow` è¦æµ‹è¯•çš„ç‰¹å®šå‡½æ•°ä¼šåœ¨è°ƒç”¨æ—¶æŠ›å‡ºä¸€ä¸ªé”™è¯¯
- `resolves` å’Œ rejects ç”¨æ¥æµ‹è¯• promise
- `toHaveBeenCalled` åˆ¤æ–­ä¸€ä¸ªå‡½æ•°æ˜¯å¦è¢«è°ƒç”¨è¿‡
- `toHaveBeenCalledTimes` åˆ¤æ–­å‡½æ•°è¢«è°ƒç”¨è¿‡å‡ æ¬¡
- `toBeGreaterThan` å¤§äº
- `toBeGreaterThanOrEqual` å¤§äºç­‰äº
- `toBeLessThan` å°äº
- `toBeLessThanOrEqual` å°äºç­‰äº
- `toBeCloseTo` æµ®ç‚¹æ•°æ¯”è¾ƒ
- `toMatchSnapshot()` è®°å½•å¿«ç…§

> ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šæŠŠ `expect` ä¸­çš„å€¼ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åˆ°ä¸€ä¸ª `.snap` æ–‡ä»¶ä¸­ 
> å¤šæ¬¡è¿è¡Œå¿«ç…§æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šä¸ä¸Šä¸€æ¬¡çš„å¿«ç…§æ–‡ä»¶å†…å®¹å¯¹æ¯”ï¼Œç›¸åŒåˆ™æµ‹è¯•é€šè¿‡ï¼Œä¸åŒåˆ™æµ‹è¯•å¤±è´¥ 
> é‡æ–°ç”Ÿæˆå¿«ç…§æ–‡ä»¶ `npm run test -- -u`

## å…­. Vue Test Utils å¸¸ç”¨çš„ API

### 1. æŒ‚è½½ç»„ä»¶

- `mout(component)` åˆ›å»ºä¸€ä¸ªåŒ…å«è¢«æŒ‚è½½å’Œæ¸²æŸ“çš„ `Vue` ç»„ä»¶çš„ `Wrapper`

```js
const wrapper = mount({
  template: `<div>hello word</div>`,
  components: {
    OtherComponent,
  },
});
const wrapper2 = mount(MyComponent);
```

- `shallowMount` åªæŒ‚è½½ä¸€ä¸ªç»„ä»¶ä¸æ¸²æŸ“å­ç»„ä»¶

```js
const wrapper = shallowMount({
  template: `<div>hello word</div>`,
  components: {
    OtherComponent,
  },
});
const wrapper2 = mount(MyComponent);
```

### 2. å‚æ•°

- `props` ä¼ å…¥ç»„ä»¶çš„å‚æ•°

```js
const mountCom = (template, options) => mount(MyComponent, {
  ...
  props: {
    active: 'default',
  },
  ...
};
```

- `slots` è®¾ç½®ç»„ä»¶çš„æ’æ§½

```js
const mountCom = (template, options) => mount(MyComponent, {
  ...
  slots: {
    default: 'Default',
    customerName: OtherComponent,
  },
  ...
});
```

- `data` ä¼ å…¥ç»„ä»¶æ•°æ®

```js
cconst mountCom = (template, options) => mount(MyComponent, {
  ...
  data() {
    return {
    message: 'world',
  };
  ...
});
```

- `attrs` è®¾ç½®ç»„ä»¶çš„å±æ€§

```js
ccconst mountCom = (template, options) => mount(MyComponent, {
  ...
  attrs: {
    id: 'hello',
    disabled: true,
  },
  ...
});
```

### 3. wrapper çš„æ–¹æ³•

- `attributes` è¿”å› `DOM` èŠ‚ç‚¹å±æ€§å€¼

```js
test('attributes', () => {
  const wrapper = mount(Component);

  expect(wrapper.attributes('id')).toBe('foo');
  expect(wrapper.attributes('class')).toBe('bar');
});
```

- `classes` è¿”å›å…ƒç´ ä¸Š `class` çš„æ•°ç»„ ä¸€èˆ¬ç”¨äºæµ‹è¯•æ ·å¼

```js
test('classes', () => {
  const wrapper = mount(Component);

  expect(wrapper.classes()).toContain('my-span');
  expect(wrapper.classes('my-span')).toBe(true);
  expect(wrapper.classes('not-existing')).toBe(false);
});
```

- `emitted` è¿”å›ç»„ä»¶å‘å‡ºçš„æ‰€æœ‰äº‹ä»¶ ä¸€èˆ¬ç”¨äºæµ‹è¯•æ´¾å‘äº‹ä»¶åŠä¼ è¾“çš„å‚æ•°

```js
test('emitted', () => {
  const wrapper = mount(Component);

  expect(wrapper.emitted()).toHaveProperty('greet');
  expect(wrapper.emitted().greet).toHaveLength(2);
  expect(wrapper.emitted().greet[0]).toEqual(['hello']);
  expect(wrapper.emitted().greet[1]).toEqual(['goodbye']);
});
```

- `exists` è¿”å›å¸ƒå°”å€¼ éªŒè¯å…ƒç´ æ˜¯å¦å­˜åœ¨ ä¸€èˆ¬ç”¨äº `DOM` å…ƒç´ æ˜¯å¦å­˜åœ¨

```js
test('exists', () => {
  const wrapper = mount(Component);

  expect(wrapper.find('span').exists()).toBe(true);
  expect(wrapper.find('p').exists()).toBe(false);
});
```

- `find` é€‰æ‹©å™¨æŸ¥æ‰¾ `DOM` å…ƒç´ ï¼Œè¿”å›D `OMWrapper` å¦‚æœæœªæŸ¥åˆ°ä¸æŠ¥é”™

```js
test('find', () => {
  const wrapper = mount(Component);

  wrapper.find('span'); //=> found; returns DOMWrapper
  wrapper.find('[data-test="span"]'); //=> found; returns DOMWrapper
  wrapper.find('p'); //=> nothing found; returns ErrorWrapper
});
```

- `getComponent` æŸ¥æ‰¾ `Vue Component` å®ä¾‹ï¼Œè¿”å› `VueWrapper` æˆ–æŠ›å‡ºå¼‚å¸¸

```js
test('getComponent', () => {
  const wrapper = mount(Component);

  wrapper.getComponent({ name: 'foo' }); // returns a VueWrapper
  wrapper.getComponent(Foo); // returns a VueWrapper

  expect(() => wrapper.getComponent('.not-there')).toThrowError();
});
```

- `get` é€‰æ‹©å™¨æŸ¥æ‰¾ `DOM` å…ƒç´ ï¼Œè¿”å› `DOMWrapper` æˆ–æŠ›å‡ºå¼‚å¸¸

```js
test('get', () => {
  const wrapper = mount(Component);

  wrapper.get('span'); //=> found; returns DOMWrapper

  expect(() => wrapper.get('.not-there')).toThrowError();
});
```

- `html` è¿”å›å…ƒç´ çš„ `HTML` å­—ç¬¦ä¸² å¿«ç…§æ—¶ä¼šä½¿ç”¨åˆ°

```js
test('html', () => {
  const wrapper = mount(Component);

  expect(wrapper.html()).toBe('<div><p>Hello world</p></div>');
});
```

- `props` è¿”å›ä¼ é€’ç»™ `Vue` ç»„ä»¶çš„å‚æ•°

```js
test('props', () => {
  const wrapper = mount(Component, {
    global: { stubs: ['Foo'] },
  });

  const foo = wrapper.getComponent({ name: 'Foo' });

  expect(foo.props('truthy')).toBe(true);
  expect(foo.props('object')).toEqual({});
  expect(foo.props('notExisting')).toEqual(undefined);
  expect(foo.props()).toEqual({
    truthy: true,
    object: {},
    string: 'string',
  });
});
```

- `setProps` æ›´æ–° `props` ä¼ å‚ ç”¨äºä¿®æ”¹å‚æ•°æµ‹è¯•ç»„ä»¶æ˜¯å¦æœ‰å˜åŒ–

```js
test('updates prop', async () => {
  const wrapper = mount(Component, {
    props: {
      message: 'hello',
    },
  });

  expect(wrapper.html()).toContain('hello');

  await wrapper.setProps({ message: 'goodbye' });

  expect(wrapper.html()).toContain('goodbye');
});
```

- `trigger` è§¦å‘ `DOM` äº‹ä»¶ï¼Œ`click submit keyup`

```js
test('trigger', async () => {
  const wrapper = mount(Component);

  await wrapper.find('button').trigger('click');

  expect(wrapper.find('span').text()).toBe('Count: 1');
});
```

- `unmount` å¸è½½ç»„ä»¶

```js
test('unmount', () => {
  const wrapper = mount(Component);

  wrapper.unmount();
  // Component is removed from DOM.
  // console.log has been called with 'unmounted!'
});
```

### 4. å±æ€§

`vm` Vue å®ä¾‹ï¼Œå¯ä»¥è·å–æ‰€æœ‰å®ä¾‹çš„æ–¹æ³•å’Œå±æ€§ã€‚

```js
test('unmount', () => {
  const wrapper = mount(Component);

  expect(wrapper.vm.$el.style.backgroundColor).toBe('red');
});
```

> æ³¨æ„ï¼švm ä»…åœ¨ VueWrapper ä¸Šå¯ç”¨ï¼Œ å¹¶ä¸”åªèƒ½è·å–åˆ° DOM å…ƒç´ çš„å†…è”æ ·å¼

## ä¸ƒ. å¿«é€Ÿå¼€å§‹

### 1. ä¸»è¦ç›®å½•ç»“æ„

```
â”œâ”€ src
 â””â”€ __tests__
    *.spec.js
â”œâ”€ package.json
â”œâ”€ babel.config.json
â”œâ”€ .eslintrc
â”œâ”€ jest.config.js
```

### 2. æ™®é€š Js é¡¹ç›®

```bash
npm i jest babel-jest @babel/core @babel/preset-env jest-html-reporter vue-template-compiler
```

`package.json`

```json
{
  "name": "test-js",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "jest",
    "test:init": "jest --init",
    "test:coverage": "jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@babel/core": "^7.13.14",
    "@babel/preset-env": "^7.13.12",
    "babel-jest": "^26.6.3",
    "jest": "^26.6.3",
    "jest-html-reporter": "^3.3.0",
    "vue-template-compiler": "^2.6.12"
  }
}
```

`babel.config.js`

```js
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "node": "current"
        }
      }
    ]
  ]
}
```

`jest.config.js`

```js
module.exports = {
  // åŒ¹é…æµ‹è¯•ç”¨ä¾‹çš„æ–‡ä»¶
  testMatch: [
    "**/__tests__/**/*.[jt]s?(x)",
    "**/?(*.)+(spec|test).[tj]s?(x)"
  ],
  reporters: [
    "default",
    // éœ€è¦å®‰è£…ä¾èµ–ï¼šjest-html-reporter
    ["./node_modules/jest-html-reporter", {
      "pageTitle": "Test Report"
    }]
  ],
  // æ¿€æ´»æµ‹è¯•ç»“æœé€šçŸ¥
  notify: true,
  // æ¯æ¬¡æµ‹è¯•å‰æ¸…é™¤æ¨¡æ‹Ÿè°ƒç”¨å’Œå®ä¾‹
  clearMocks: true,
  // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ç±»å‹
  coverageReporters: ['json', 'html'],
  // è¦†ç›–ç‡æŠ¥å‘Šçš„ç›®å½•ï¼Œæµ‹è¯•æŠ¥å‘Šæ‰€å­˜æ”¾çš„ä½ç½®
  coverageDirectory: './coverage-reports',
  snapshotSerializers: ['./node_modules/jest-serializer-vue'],
};
```

### 3. Ts é¡¹ç›®

```bash
npm i jest babel-jest @babel/core @babel/preset-env ts-jest @types/jest jest-html-reporter vue-template-compiler
```

`package.json`

```json
{
  "name": "test-ts",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "jest",
    "test:init": "jest --init",
    "test:coverage": "jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@babel/core": "^7.13.14",
    "@babel/preset-env": "^7.13.12",
    "@types/jest": "^26.0.22",
    "babel-jest": "^26.6.3",
    "jest": "^26.6.3",
    "jest-html-reporter": "^3.3.0",
    "ts-jest": "^26.5.4",
    "vue-template-compiler": "^2.6.12"
  }
}
```

`babel.config.js`

```js
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "node": "current"
        }
      }
    ]
  ]
}
```

`jest.config.js`

```js
module.exports = {
  // åŒ¹é…æµ‹è¯•ç”¨ä¾‹çš„æ–‡ä»¶
  testMatch: [
    "**/__tests__/**/*.[jt]s?(x)",
    "**/?(*.)+(spec|test).[tj]s?(x)"
  ],
  reporters: [
    "default",
    // éœ€è¦å®‰è£…ä¾èµ–ï¼šjest-html-reporter
    ["./node_modules/jest-html-reporter", {
      "pageTitle": "Test Report"
    }]
  ],
  // æ¿€æ´»æµ‹è¯•ç»“æœé€šçŸ¥
  notify: true,
  // æ¯æ¬¡æµ‹è¯•å‰æ¸…é™¤æ¨¡æ‹Ÿè°ƒç”¨å’Œå®ä¾‹
  clearMocks: true,
  // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ç±»å‹
  coverageReporters: ['json', 'html'],
  // è¦†ç›–ç‡æŠ¥å‘Šçš„ç›®å½•ï¼Œæµ‹è¯•æŠ¥å‘Šæ‰€å­˜æ”¾çš„ä½ç½®
  coverageDirectory: './coverage-reports',
  // è½¬æ¢å™¨ -- tséœ€è¦é…ç½®è¯¥é€‰é¡¹
  transform: {
    '^.+\\.(t|j)sx?$': [
      'babel-jest', {
        presets: [
          '@babel/preset-typescript',
        ],
      },
    ],
  },
  snapshotSerializers: ['./node_modules/jest-serializer-vue'],
};
```

### 4. vue-test-utils + ts + jest é¡¹ç›®

```bash
npm i jest babel-jest @babel/core @babel/preset-env ts-jest @types/jest vue-jest @vue/test-utils slint-plugin-jest jest-html-reporter vue-template-compiler
```

`package.json`

```json
{
  "name": "test-ts",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "jest",
    "test:init": "jest --init",
    "test:coverage": "jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@babel/core": "^7.13.14",
    "@babel/preset-env": "^7.13.12",
    "@types/jest": "^26.0.22",
    "@vue/test-utils": "^2.0.0-rc.4",
    "babel-jest": "^26.6.3",
    "eslint-plugin-jest": "^24.3.2",
    "jest": "^26.6.3",
    "jest-html-reporter": "^3.3.0",
    "ts-jest": "^26.5.4",
    "vite": "^2.0.1",
    "vue-jest": "^5.0.0-alpha.8",
    "vue-template-compiler": "^2.6.12"
  }
}
```

`jest.config.js` ç»„ä»¶åº“çš„é…ç½®

```js
const path = require('path');

module.exports = {
  // è¿è¡Œæ—¶æ˜¯å¦è¾“å‡ºæµ‹è¯•ä¿¡æ¯
  verbose: true,
  // æ ¹ç›®å½•
  rootDir: path.resolve(__dirname),
  preset: 'ts-jest',
  // æµ‹è¯•ç¯å¢ƒ
  testEnvironment: 'jsdom',
  // è½¬æ¢å™¨
  transform: {
    '^.+\\.vue$': 'vue-jest',
    '^.+\\.(t|j)sx?$': [
      'babel-jest', {
        presets: [
          [
            '@babel/preset-env',
            {
              targets: {
                node: true,
              },
            },
          ],
          '@babel/preset-typescript',
        ],
      },
    ],
  },
  // æŒ‡å®šæ–‡ä»¶æ‰©å±•å
  moduleFileExtensions: ['vue', 'js', 'json', 'jsx', 'ts', 'tsx', 'node'],
  // åŒ¹é…æµ‹è¯•ç”¨ä¾‹çš„æ–‡ä»¶
  testMatch: [
    '<rootDir>/packages/**/__tests__/*.spec.js',
  ],
  // æ˜¯å¦æ”¶é›†æµ‹è¯•æ—¶çš„è¦†ç›–ç‡ä¿¡æ¯
  collectCoverage: true,
  // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ç±»å‹
  coverageReporters: ['json', 'html'],
  // è¦†ç›–ç‡æŠ¥å‘Šçš„ç›®å½•ï¼Œæµ‹è¯•æŠ¥å‘Šæ‰€å­˜æ”¾çš„ä½ç½®
  coverageDirectory: '<rootDir>/testReports/',
  // æµ‹è¯•æŠ¥å‘Šæƒ³è¦è¦†ç›–é‚£äº›æ–‡ä»¶ï¼Œç›®å½•ï¼Œå‰é¢åŠ ï¼æ˜¯é¿å¼€è¿™äº›æ–‡ä»¶
  collectCoverageFrom: [
    '!site/components/**/src/*.(js|vue|ts)',
    'packages/**/*.(js|vue)',
    'packages/testReports/*.(js|vue)',
    '!site/main.ts',
    '!site/router/index.ts',
    '!**/node_modules/**',
  ],
  // æµ‹è¯•è¦†ç›–æ•ˆæœé˜ˆå€¼ å½“è¦†ç›–ç‡è¾¾åˆ°é¢„è®¾å€¼è¿”å›æˆåŠŸ  å°äºé¢„è®¾å€¼åˆ™è¿”å›å¤±è´¥  ä½†ä¸å½±å“æŠ¥å‘Šè¾“å‡º
  coverageThreshold: {
    // å…¨éƒ¨æ–‡ä»¶
    // global: {
    //   branches: 60,
    //   functions: 60,
    //   lines: 60,
    //   statements: 60,
    // },
    // å•ç‹¬æ–‡ä»¶
    // 'packages/header-base/src/index.vue': {
    //   branches: 60,
    //   statements: 60,
    // },
  },
  // æ¿€æ´»æµ‹è¯•ç»“æœé€šçŸ¥
  notify: true,
  // æ¯æ¬¡æµ‹è¯•å‰æ¸…é™¤æ¨¡æ‹Ÿè°ƒç”¨å’Œå®ä¾‹
  clearMocks: true,
  snapshotSerializers: ['<rootDir>/node_modules/jest-serializer-vue'],
};
```

## ğŸŒŸ. å‚è€ƒæ–‡æ¡£

- [Jest ä¸­æ–‡æ–‡æ¡£ ](https://jestjs.io/zh-Hans/)
- [Vue Test Utils for Vue3 æ–‡æ¡£](https://next.vue-test-utils.vuejs.org/guide/)
- [Vue Test Utils for Vue3API](https://test-utils.vuejs.org/api/) 
- [Jest é…ç½®](https://jestjs.io/zh-Hans/docs/configuration)
