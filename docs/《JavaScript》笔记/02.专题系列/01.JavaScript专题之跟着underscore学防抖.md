---
title: JavaScript ä¸“é¢˜ä¹‹è·Ÿç€ underscore å­¦é˜²æŠ–
date: 2021-10-18 16:30:32
permalink: /pages/095f2e/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ä¸“é¢˜ç³»åˆ—
author:
  name: Jamison
  link: https://github.com/oliver556
---

# JavaScript ä¸“é¢˜ä¹‹è·Ÿç€ underscore å­¦é˜²æŠ–

## ğŸ“–. å‰è¨€

åœ¨å‰ç«¯å¼€å‘ä¸­ä¼šé‡åˆ°ä¸€äº›é¢‘ç¹çš„äº‹ä»¶è§¦å‘ï¼Œæ¯”å¦‚ï¼š

1. window çš„ `resize`ã€`scroll`
2. `mousedown`ã€`mousemove`
3. `keyup`ã€`keydown`  
â€¦â€¦

ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸¾ä¸ªç¤ºä¾‹ä»£ç æ¥äº†è§£äº‹ä»¶å¦‚ä½•é¢‘ç¹çš„è§¦å‘ï¼š

æˆ‘ä»¬å†™ä¸ª `index.html` æ–‡ä»¶ï¼š

```html
<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge, chrome=1">
  <title>debounce</title>
  <style>
    #container{
      width: 100%; height: 200px; line-height: 200px; text-align: center; color: #fff; background-color: #444; font-size: 30px;
    }
  </style>
</head>

<body>
    <div id="container"></div>
    <script src="debounce.js"></script>
</body>

</html>
```

`debounce.js` æ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š

```js
var count = 1;
var container = document.getElementById('container');

function getUserAction() {
  container.innerHTML = count++;
};

container.onmousemove = getUserAction;
```

æˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š

![javascript_03-14_01](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220314/javascript_03-14_01.4bcyvac8ezk0.gif)

ä»å·¦è¾¹æ»‘åˆ°å³è¾¹å°±è§¦å‘äº† 165 æ¬¡ getUserAction å‡½æ•°ï¼

å› ä¸ºè¿™ä¸ªä¾‹å­å¾ˆç®€å•ï¼Œæ‰€ä»¥æµè§ˆå™¨å®Œå…¨ååº”çš„è¿‡æ¥ï¼Œå¯æ˜¯å¦‚æœæ˜¯å¤æ‚çš„å›è°ƒå‡½æ•°æˆ–æ˜¯ ajax è¯·æ±‚å‘¢ï¼Ÿå‡è®¾ 1 ç§’è§¦å‘äº† 60 æ¬¡ï¼Œæ¯ä¸ªå›è°ƒå°±å¿…é¡»åœ¨ 1000 / 60 = 16.67ms å†…å®Œæˆï¼Œå¦åˆ™å°±ä¼šæœ‰å¡é¡¿å‡ºç°ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

1. debounce é˜²æŠ–
2. throttle èŠ‚æµ

## ä¸€. é˜²æŠ–

ä»Šå¤©é‡ç‚¹è®²è®²é˜²æŠ–çš„å®ç°ã€‚

é˜²æŠ–çš„åŸç†å°±æ˜¯ï¼šä½ å°½ç®¡è§¦å‘äº‹ä»¶ï¼Œä½†æ˜¯æˆ‘ä¸€å®šåœ¨äº‹ä»¶è§¦å‘ n ç§’åæ‰æ‰§è¡Œï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ n ç§’å†…åˆè§¦å‘äº†è¿™ä¸ªäº‹ä»¶ï¼Œé‚£æˆ‘å°±ä»¥æ–°çš„äº‹ä»¶çš„æ—¶é—´ä¸ºå‡†ï¼Œn ç§’åæ‰æ‰§è¡Œï¼Œ
æ€»ä¹‹ï¼Œå°±æ˜¯è¦ç­‰ä½ è§¦å‘å®Œäº‹ä»¶ n ç§’å†…ä¸å†è§¦å‘äº‹ä»¶ï¼Œæˆ‘æ‰æ‰§è¡Œï¼ŒçœŸæ˜¯ä»»æ€§å‘!

## äºŒ. ç¬¬ä¸€ç‰ˆ

æ ¹æ®è¿™æ®µè¡¨è¿°ï¼Œæˆ‘ä»¬å¯ä»¥å†™ç¬¬ä¸€ç‰ˆçš„ä»£ç ï¼š

```js
// ç¬¬ä¸€ç‰ˆ
function debounce(func, wait) {
  var timeout;
  return function () {
    clearTimeout(timeout)
    timeout = setTimeout(func, wait);
  }
}
```

å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨å®ƒï¼Œä»¥æœ€ä¸€å¼€å§‹çš„ä¾‹å­ä¸ºä¾‹ï¼š

```js
container.onmousemove = debounce(getUserAction, 1000);
```

ç°åœ¨éšä½ æ€ä¹ˆç§»åŠ¨ï¼Œåæ­£ä½ ç§»åŠ¨å®Œ 1000ms å†…ä¸å†è§¦å‘ï¼Œæˆ‘æ‰æ‰§è¡Œäº‹ä»¶ã€‚çœ‹çœ‹ä½¿ç”¨æ•ˆæœï¼š

![javascript_03-14_02](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220314/javascript_03-14_02.6x1r5xy8s4s0.gif)

é¡¿æ—¶å°±ä» 165 æ¬¡é™ä½æˆäº† 1 æ¬¡!

æ£’æ£’å“’ï¼Œæˆ‘ä»¬æ¥ç€å®Œå–„å®ƒã€‚

## ä¸‰. this

å¦‚æœæˆ‘ä»¬åœ¨ `getUserAction` å‡½æ•°ä¸­ `console.log(this)`ï¼Œåœ¨ä¸ä½¿ç”¨ `debounce` å‡½æ•°çš„æ—¶å€™ï¼Œ`this` çš„å€¼ä¸ºï¼š

```html
<div id="container"></div>
```

ä½†æ˜¯å¦‚æœä½¿ç”¨æˆ‘ä»¬çš„ debounce å‡½æ•°ï¼Œthis å°±ä¼šæŒ‡å‘ Window å¯¹è±¡ï¼

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† this æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡ã€‚

æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼š

```js
// ç¬¬äºŒç‰ˆ
function debounce(func, wait) {
  var timeout;
  
  return function () {
    var context = this;
  
    clearTimeout(timeout)
    timeout = setTimeout(function(){
      func.apply(context)
    }, wait);
  }
}
```

ç°åœ¨ this å·²ç»å¯ä»¥æ­£ç¡®æŒ‡å‘äº†ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹ä¸ªé—®é¢˜ï¼š

## å››. event å¯¹è±¡

JavaScript åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ä¼šæä¾›äº‹ä»¶å¯¹è±¡ eventï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸‹ getUserAction å‡½æ•°ï¼š

```js
function getUserAction(e) {
  console.log(e);
  container.innerHTML = count++;
};
```

å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ debouce å‡½æ•°ï¼Œè¿™é‡Œä¼šæ‰“å° MouseEvent å¯¹è±¡ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![javascript_03-14_03](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220314/javascript_03-14_03.1ot5zopgzclc.webp)

ä½†æ˜¯åœ¨æˆ‘ä»¬å®ç°çš„ debounce å‡½æ•°ä¸­ï¼Œå´åªä¼šæ‰“å° undefined!

æ‰€ä»¥æˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š

```js
// ç¬¬ä¸‰ç‰ˆ
function debounce(func, wait) {
  var timeout;
  
  return function () {
    var context = this;
    var args = arguments;
  
    clearTimeout(timeout)
    timeout = setTimeout(function(){
      func.apply(context, args)
    }, wait);
  }
}
```

åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¿®å¤äº†ä¸¤ä¸ªå°é—®é¢˜ï¼š

1. this æŒ‡å‘
2. event å¯¹è±¡

## äº”. ç«‹åˆ»æ‰§è¡Œ

è¿™ä¸ªæ—¶å€™ï¼Œä»£ç å·²ç»å¾ˆæ˜¯å®Œå–„äº†ï¼Œä½†æ˜¯ä¸ºäº†è®©è¿™ä¸ªå‡½æ•°æ›´åŠ å®Œå–„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥æ€è€ƒä¸€ä¸ªæ–°çš„éœ€æ±‚ã€‚

è¿™ä¸ªéœ€æ±‚å°±æ˜¯ï¼š

æˆ‘ä¸å¸Œæœ›éè¦ç­‰åˆ°äº‹ä»¶åœæ­¢è§¦å‘åæ‰æ‰§è¡Œï¼Œæˆ‘å¸Œæœ›ç«‹åˆ»æ‰§è¡Œå‡½æ•°ï¼Œç„¶åç­‰åˆ°åœæ­¢è§¦å‘ n ç§’åï¼Œæ‰å¯ä»¥é‡æ–°è§¦å‘æ‰§è¡Œã€‚

æƒ³æƒ³è¿™ä¸ªéœ€æ±‚ä¹Ÿæ˜¯å¾ˆæœ‰é“ç†çš„å˜›ï¼Œé‚£æˆ‘ä»¬åŠ ä¸ª immediate å‚æ•°åˆ¤æ–­æ˜¯å¦æ˜¯ç«‹åˆ»æ‰§è¡Œã€‚

```js
// ç¬¬å››ç‰ˆ
function debounce(func, wait, immediate) {
  
  var timeout;
  
  return function () {
    var context = this;
    var args = arguments;
  
    if (timeout) clearTimeout(timeout);
    if (immediate) {
      // å¦‚æœå·²ç»æ‰§è¡Œè¿‡ï¼Œä¸å†æ‰§è¡Œ
      var callNow = !timeout;
      timeout = setTimeout(function(){
        timeout = null;
      }, wait)
      if (callNow) func.apply(context, args)
    }
    else {
      timeout = setTimeout(function(){
        func.apply(context, args)
      }, wait);
    }
  }
}
```

å†æ¥çœ‹çœ‹ä½¿ç”¨æ•ˆæœï¼š

![javascript_03-14_04](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220314/javascript_03-14_04.ufiyn43he8w.gif)

## å…­. è¿”å›å€¼

æ­¤æ—¶æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯ getUserAction å‡½æ•°å¯èƒ½æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦è¿”å›å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œä½†æ˜¯å½“ immediate ä¸º false çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨äº† setTimeout ï¼Œæˆ‘ä»¬å°† func.apply(context, args) çš„è¿”å›å€¼èµ‹ç»™å˜é‡ï¼Œ
æœ€åå† return çš„æ—¶å€™ï¼Œå€¼å°†ä¼šä¸€ç›´æ˜¯ undefinedï¼Œæ‰€ä»¥æˆ‘ä»¬åªåœ¨ immediate ä¸º true çš„æ—¶å€™è¿”å›å‡½æ•°çš„æ‰§è¡Œç»“æœã€‚

```js
// ç¬¬äº”ç‰ˆ
function debounce(func, wait, immediate) {

  var timeout, result;
  
  return function () {
    var context = this;
    var args = arguments;
  
    if (timeout) clearTimeout(timeout);
    if (immediate) {
      // å¦‚æœå·²ç»æ‰§è¡Œè¿‡ï¼Œä¸å†æ‰§è¡Œ
      var callNow = !timeout;
      timeout = setTimeout(function(){
        timeout = null;
      }, wait)
      if (callNow) result = func.apply(context, args)
    }
    else {
      timeout = setTimeout(function(){
        func.apply(context, args)
      }, wait);
    }
    return result;
  }
}
```

## ä¸ƒ. å–æ¶ˆ

æœ€åæˆ‘ä»¬å†æ€è€ƒä¸€ä¸ªå°éœ€æ±‚ï¼Œæˆ‘å¸Œæœ›èƒ½å–æ¶ˆ debounce å‡½æ•°ï¼Œæ¯”å¦‚è¯´æˆ‘ debounce çš„æ—¶é—´é—´éš”æ˜¯ 10 ç§’é’Ÿï¼Œimmediate ä¸º trueï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘åªæœ‰ç­‰ 10 ç§’åæ‰èƒ½é‡æ–°è§¦å‘äº‹ä»¶ï¼Œç°åœ¨æˆ‘å¸Œæœ›æœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»åï¼Œå–æ¶ˆé˜²æŠ–ï¼Œ
è¿™æ ·æˆ‘å†å»è§¦å‘ï¼Œå°±å¯ä»¥åˆç«‹åˆ»æ‰§è¡Œå•¦ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¼€å¿ƒï¼Ÿ

ä¸ºäº†è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬å†™æœ€åä¸€ç‰ˆçš„ä»£ç ï¼š

```js
// ç¬¬å…­ç‰ˆ
function debounce(func, wait, immediate) {

  var timeout, result;
  
  var debounced = function () {
    var context = this;
    var args = arguments;
  
    if (timeout) clearTimeout(timeout);
    if (immediate) {
      // å¦‚æœå·²ç»æ‰§è¡Œè¿‡ï¼Œä¸å†æ‰§è¡Œ
      var callNow = !timeout;
      timeout = setTimeout(function(){
        timeout = null;
      }, wait)
      if (callNow) result = func.apply(context, args)
    }
    else {
      timeout = setTimeout(function(){
        func.apply(context, args)
      }, wait);
    }
    return result;
  };
  
  debounced.cancel = function() {
    clearTimeout(timeout);
    timeout = null;
  };
  
  return debounced;
}
```

é‚£ä¹ˆè¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ª cancel å‡½æ•°å‘¢ï¼Ÿä¾ç„¶æ˜¯ä»¥ä¸Šé¢çš„ demo ä¸ºä¾‹ï¼š

```js
var count = 1;
var container = document.getElementById('container');

function getUserAction(e) {
  container.innerHTML = count++;
};

var setUseAction = debounce(getUserAction, 10000, true);

container.onmousemove = setUseAction;

document.getElementById("button").addEventListener('click', function(){
  setUseAction.cancel();
})
```

æ¼”ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š

![javascript_03-14_05](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220314/javascript_03-14_05.1qjgygbqmod.gif)

è‡³æ­¤æˆ‘ä»¬å·²ç»å®Œæ•´å®ç°äº†ä¸€ä¸ª underscore ä¸­çš„ debounce å‡½æ•°ï¼Œæ­å–œï¼Œæ’’èŠ±ï¼
