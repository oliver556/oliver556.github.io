---
title: 30åˆ†é’Ÿå¿«é€ŸæŒæ¡å¾®å‰ç«¯ qiankun çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯
date: 2022-07-08 11:39:45
permalink: /pages/d6bd93/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - å¾®å‰ç«¯
---

# 30åˆ†é’Ÿå¿«é€ŸæŒæ¡å¾®å‰ç«¯ qiankun çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯

## ä¸€. å¼•è¨€

### 1. å¾®å‰ç«¯æ˜¯ä»€ä¹ˆï¼Ÿ

å·²ç»äº†è§£å¾®å‰ç«¯çš„æœ‹å‹å¯è‡ªè¡Œè·³è¿‡æœ¬èŠ‚ï¼Œç®€å•ä»‹ç»ä¸‹å¾®å‰ç«¯ï¼Œå¾®å‰ç«¯æ˜¯å°†å‰ç«¯æ›´åŠ ç»†åˆ†åŒ–çš„ä¸€ç§æŠ€æœ¯æ–¹æ¡ˆï¼Œç±»ä¼¼ä¸åç«¯å¾®æœåŠ¡ï¼Œä¸‹å›¾æ‰€ç¤º 3 ä¸ª**å¯ç‹¬ç«‹æ„å»ºæµ‹è¯•éƒ¨ç½²**å¹¶å¯å¢é‡å‡çº§çš„**ä¸åŒæŠ€æœ¯æ ˆ**åº”ç”¨ï¼Œå¯ä»¥é›†æˆåœ¨ä¸€ä¸ªåŸºåº§åº”ç”¨ä¸­ä¸€èµ·å±•ç¤ºã€‚

![javascript_07-08_01](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_01.5e0d34reods0.webp)

> å¾®å‰ç«¯æ˜¯ä¸€ç§å¤šä¸ªå›¢é˜Ÿé€šè¿‡ç‹¬ç«‹å‘å¸ƒåŠŸèƒ½çš„æ–¹å¼æ¥å…±åŒæ„å»ºç°ä»£åŒ– web åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µåŠæ–¹æ³•ç­–ç•¥ã€‚

å¾®å‰ç«¯æ¶æ„å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒä»·å€¼ï¼š

- **æŠ€æœ¯æ ˆæ— å…³**  
ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå¾®åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒ

- **ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²**  
å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°

- **å¢é‡å‡çº§**  
åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥

- **ç‹¬ç«‹è¿è¡Œæ—¶**  
æ¯ä¸ªå¾®åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«

### 2. å¾®å‰ç«¯è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„**æ—¶é—´è·¨åº¦**ä¸‹ï¼Œç”±äº**å‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿**ã€ä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ª**å·¨çŸ³åº”ç”¨**ï¼ˆFrontend Monolithï¼‰åï¼Œéšä¹‹è€Œæ¥çš„**åº”ç”¨ä¸å¯ç»´æŠ¤**çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚

### 3. å¦‚ä½•å®ç°å¾®å‰ç«¯ï¼Ÿ

å®ç°å¾®å‰ç«¯éœ€è¦è§£å†³çš„æŠ€æœ¯é—®é¢˜æœ‰ï¼š

1. **åº”ç”¨æ¥å…¥**
2. **åº”ç”¨å…¥å£**
3. **åº”ç”¨éš”ç¦»**
4. **æ ·å¼éš”ç¦»**
5. **åº”ç”¨é€šä¿¡**
6. **åº”ç”¨è·¯ç”±**

### 4. ä¸ºä»€ä¹ˆé€‰æ‹© qiankunï¼Ÿ

1. åœ¨åˆ©ç”¨ Single SPA æˆ–å…¶å®ƒå¾®åº”ç”¨æ¡†æ¶æ„å»ºå‰ç«¯ç³»ç»Ÿä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚**æ ·å¼éš”ç¦»**ã€**JSæ²™ç®±**ã€**èµ„æºé¢„åŠ è½½**ã€**JS å‰¯ä½œç”¨å¤„ç†**ç­‰ç­‰è¿™äº›ä½ éœ€è¦çš„èƒ½åŠ›å…¨éƒ¨å†…ç½®åˆ°äº† `qiankun` é‡Œé¢ã€‚
2. åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»å¤§æ¦‚æœ‰ 2000+ çš„åº”ç”¨ï¼Œä½¿ç”¨ `qiankun` æ¥æ¥å…¥è‡ªå·±çš„å¾®å‰ç«¯ä½“ç³»ã€‚`qiankun` åœ¨èš‚èšå†…å¤–å—è¿‡äº†å¤§é‡çº¿ä¸Šç³»ç»Ÿçš„è€ƒéªŒï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå€¼å¾—ä¿¡èµ–çš„ç”Ÿäº§å¯ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

çŸ­çŸ­ä¸€å¹´æ—¶é—´ï¼Œ`qiankun` å·²ç„¶æˆä¸ºæœ€çƒ­é—¨çš„**å¾®å‰ç«¯**æ¡†æ¶ä¹‹ä¸€ï¼Œè™½ç„¶æºç ä¸€ç›´åœ¨æ›´æ–°ï¼Œä½†æ˜¯å®ƒçš„**æ ¸å¿ƒæŠ€æœ¯**å§‹ç»ˆæ˜¯é‚£ä¹ˆå‡ ä¸ªï¼š**JS æ²™ç®±**ã€**CSS æ ·å¼éš”ç¦»**ã€**åº”ç”¨ HTML å…¥å£æ¥å…¥**ã€**åº”ç”¨é€šä¿¡**ã€**åº”ç”¨è·¯ç”±**ç­‰ï¼Œ
æ¥ä¸‹æ¥å°†é€šè¿‡æ¼”ç¤º `demo` çš„æ–¹å¼è¯¦ç»†è¯´æ˜å‡ ç§æŠ€æœ¯çš„**è®¾è®¡ä¸å®ç°**ã€‚

## äºŒ. JS æ²™ç®±éš”ç¦»çš„è®¾è®¡ä¸å®ç°

### 1. JS æ²™ç®±ç®€ä»‹

**JS æ²™ç®±** ç®€å•ç‚¹è¯´å°±æ˜¯ï¼Œä¸»åº”ç”¨æœ‰ä¸€å¥—å…¨å±€ç¯å¢ƒ `window`ï¼Œå­åº”ç”¨æœ‰ä¸€å¥—ç§æœ‰çš„å…¨å±€ç¯å¢ƒ `fakeWindow`ï¼Œå­åº”ç”¨æ‰€æœ‰æ“ä½œéƒ½åªåœ¨æ–°çš„å…¨å±€ä¸Šä¸‹æ–‡ä¸­ç”Ÿæ•ˆï¼Œè¿™æ ·çš„å­åº”ç”¨å°±å¥½æ¯”è¢«ä¸€ä¸ªä¸ªç®±å­è£…èµ·æ¥ä¸ä¸»åº”ç”¨**éš”ç¦»**ï¼Œ
å› æ­¤ä¸»åº”ç”¨åŠ è½½åº”ç”¨ä¾¿ä¸ä¼šé€ æˆ**JS å˜é‡çš„ç›¸äº’æ±¡æŸ“**ã€**JS å‰¯ä½œç”¨**ã€**CSS æ ·å¼è¢«è¦†ç›–**ç­‰ï¼Œæ¯ä¸ªå­åº”ç”¨çš„å…¨å±€ä¸Šä¸‹æ–‡éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚

### 2. å¿«ç…§æ²™ç®± - snapshotSandbox

å¿«ç…§æ²™ç®±å°±æ˜¯åœ¨åº”ç”¨æ²™ç®±æŒ‚è½½å’Œå¸è½½çš„æ—¶å€™**è®°å½•å¿«ç…§**ï¼Œåœ¨åº”ç”¨åˆ‡æ¢çš„æ—¶å€™**ä¾æ®å¿«ç…§æ¢å¤ç¯å¢ƒ**ã€‚

- **demo æ¼”ç¤º**

![javascript_07-08_02](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_02.pbatodsb1w0.webp)

- **å®ç°ä»£ç **

```js
// å­åº”ç”¨A
mountSnapshotSandbox();
window.a = 123;
console.log("å¿«ç…§æ²™ç®±æŒ‚è½½åçš„a:", window.a); // 123
unmountSnapshotSandbox();
console.log("å¿«ç…§æ²™ç®±å¸è½½åçš„a:", window.a); // undefined
mountSnapshotSandbox();
console.log("å¿«ç…§æ²™ç®±å†æ¬¡æŒ‚è½½åçš„a:", window.a); // 123
```

```js
// snapshotSandbox.ts
// éå†å¯¹è±¡keyå¹¶å°†keyä¼ ç»™å›è°ƒå‡½æ•°æ‰§è¡Œ
function iter(obj: object, callbackFn: (prop: any) => void) {
  for (const prop in obj) {
    if (obj.hasOwnProperty(prop)) {
      callbackFn(prop);
    }
  }
}

// æŒ‚è½½å¿«ç…§æ²™ç®±
mountSnapshotSandbox()
{
  // è®°å½•å½“å‰å¿«ç…§
  this.windowSnapshot = {} as Window;
  iter(window, (prop) => {
    this.windowSnapshot[prop] = window[prop];
  });

  // æ¢å¤ä¹‹å‰çš„å˜æ›´
  Object.keys(this.modifyPropsMap).forEach((p: any) => {
    window[p] = this.modifyPropsMap[p];
  });
}
// å¸è½½å¿«ç…§æ²™ç®±
unmountSnapshotSandbox()
{
  // è®°å½•å½“å‰å¿«ç…§ä¸Šæ”¹åŠ¨çš„å±æ€§
  this.modifyPropsMap = {};

  iter(window, (prop) => {
    if (window[prop] !== this.windowSnapshot[prop]) {
      // è®°å½•å˜æ›´ï¼Œæ¢å¤ç¯å¢ƒ
      this.modifyPropsMap[prop] = window[prop];
      window[prop] = this.windowSnapshot[prop];
    }
  });
}
```

- **ä¼˜ç‚¹**
  - å…¼å®¹å‡ ä¹æ‰€æœ‰æµè§ˆå™¨
- **ç¼ºç‚¹** 
  - æ— æ³•åŒæ—¶æœ‰å¤šä¸ªè¿è¡Œæ—¶å¿«ç…§æ²™ç®±ï¼Œå¦åˆ™åœ¨ window ä¸Šä¿®æ”¹çš„è®°å½•ä¼šæ··ä¹±ï¼Œä¸€ä¸ªé¡µé¢åªèƒ½è¿è¡Œä¸€ä¸ªå•å®ä¾‹å¾®åº”ç”¨

### 3. ä»£ç†æ²™ç®± - proxySandbox

å½“æœ‰å¤šä¸ªå®ä¾‹çš„æ—¶å€™ï¼Œæ¯”å¦‚æœ‰ `A`ã€`B` ä¸¤ä¸ªåº”ç”¨ï¼Œ`A` åº”ç”¨å°±æ´»åœ¨ `A` åº”ç”¨çš„æ²™ç®±é‡Œé¢ï¼Œ`B` åº”ç”¨å°±æ´»åœ¨ `B` åº”ç”¨çš„æ²™ç®±é‡Œé¢ï¼Œ`A` å’Œ `B` æ— æ³•äº’ç›¸å¹²æ‰°ï¼Œè¿™æ ·çš„æ²™ç®±å°±æ˜¯**ä»£ç†æ²™ç®±**ï¼Œ
è¿™ä¸ªæ²™ç®±çš„å®ç°æ€è·¯å…¶å®ä¹Ÿæ˜¯é€šè¿‡ `ES6` çš„ [proxy](https://developer.mozilla.org/zh-CN/docs/web/javascript/reference/global_objects/proxy)ï¼Œé€šè¿‡**ä»£ç†ç‰¹æ€§**å®ç°çš„ã€‚

> `Proxy` å¯¹è±¡ç”¨äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†ï¼Œä»è€Œå®ç°åŸºæœ¬æ“ä½œçš„æ‹¦æˆªå’Œè‡ªå®šä¹‰ï¼ˆå¦‚å±æ€§æŸ¥æ‰¾ã€èµ‹å€¼ã€æšä¸¾ã€å‡½æ•°è°ƒç”¨ç­‰ï¼‰ã€‚
> ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå¯ä»¥åœ¨å¯¹ç›®æ ‡å¯¹è±¡è®¾ç½®ä¸€å±‚æ‹¦æˆªã€‚æ— è®ºå¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œéƒ½è¦ç»è¿‡è¿™å±‚æ‹¦æˆªã€‚

![javascript_07-08_03](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_03.5fzy34nn3tc0.webp)

- **Proxy** vs **Object.defineProperty**  
`Object.defineProperty` ä¹Ÿèƒ½å®ç°åŸºæœ¬æ“ä½œçš„æ‹¦æˆªå’Œè‡ªå®šä¹‰ï¼Œé‚£ä¸ºä»€ä¹ˆç”¨ `Proxy` å‘¢ï¼Ÿå› ä¸º `Proxy` èƒ½è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **åˆ é™¤æˆ–è€…å¢åŠ å¯¹è±¡å±æ€§æ— æ³•ç›‘å¬åˆ°**ã€‚
2. **æ•°ç»„çš„å˜åŒ–æ— æ³•ç›‘å¬åˆ°**ï¼ˆ`vue2` æ­£æ˜¯ä½¿ç”¨çš„ `Object.defineProperty` åŠ«æŒå±æ€§ï¼Œ`watch` ä¸­æ— æ³•æ£€æµ‹æ•°ç»„æ”¹å˜çš„å…ƒå‡¶æ‰¾åˆ°äº†ï¼‰

- demo æ¼”ç¤º

  - ç®€å•ç‰ˆæœ¬

![javascript_07-08_04](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_04.lv4yactag1c.webp)

  - å®é™…åœºæ™¯ç‰ˆæœ¬

![javascript_07-08_05](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_05.10vpdm6hdheo.gif)

- å®ç°ä»£ç 

1. ç®€å•ç‰ˆæœ¬

```js
const proxyA = new CreateProxySandbox({});
const proxyB = new CreateProxySandbox({});

proxyA.mountProxySandbox();
proxyB.mountProxySandbox();

(function (window) {
  window.a = "this is a";
  console.log("ä»£ç†æ²™ç®± a:", window.a); // undefined
})(proxyA.proxy);

(function (window) {
  window.b = "this is b";
  console.log("ä»£ç†æ²™ç®± b:", window.b); // undefined
})(proxyB.proxy);

proxyA.unmountProxySandbox();
proxyB.unmountProxySandbox();

(function (window) {
  console.log("ä»£ç†æ²™ç®± a:", window.a); // undefined
})(proxyA.proxy);

(function (window) {
  console.log("ä»£ç†æ²™ç®± b:", window.b); // undefined
})(proxyB.proxy);
```

2. çœŸå®åœºæ™¯ç‰ˆæœ¬

```html
<!DOCTYPE html>
<html lang="en">
  <body data-qiankun-A>
    <h5>ä»£ç†æ²™ç®±ï¼š</h5>
    <button onclick="mountA()">ä»£ç†æ²™ç®±æ¨¡å¼æŒ‚è½½aåº”ç”¨</button>
    <button onclick="unmountA()">ä»£ç†æ²™ç®±æ¨¡å¼å¸è½½aåº”ç”¨</button>
    <button onclick="mountB()">ä»£ç†æ²™ç®±æ¨¡å¼æŒ‚è½½båº”ç”¨</button>
    <button onclick="unmountB()">ä»£ç†æ²™ç®±æ¨¡å¼å¸è½½båº”ç”¨</button>

    <script src="proxySandbox.js"></script>
    <script src="index.js"></script>
  </body>
</html>
```

`a` åº”ç”¨jsï¼Œåœ¨ `a` åº”ç”¨æŒ‚åœ¨æœŸé—´åŠ è½½çš„æ‰€æœ‰ `js` éƒ½ä¼šè¿è¡Œåœ¨ `a` åº”ç”¨çš„æ²™ç®±ï¼ˆ`proxyB.proxy`ï¼‰ä¸­

```js
// a.js
window.a = "this is a";
console.log("ä»£ç†æ²™ç®±1 a:", window.a);
```

`b` åº”ç”¨jsï¼Œåœ¨ `b` åº”ç”¨æŒ‚è½½æœŸé—´åŠ è½½æ‰€æœ‰çš„ `js` éƒ½ä¼šè¿è¡Œåœ¨ `b` åº”ç”¨çš„æ²™ç®±ï¼ˆ`proxyB.proxy`ï¼‰ä¸­

```js
// b.js
window.b = "this is b";
console.log("ä»£ç†æ²™ç®± b:", window.b);
```

```js
const proxyA = new CreateProxySandbox({});
const proxyB = new CreateProxySandbox({});

function mountA() {
  proxyA.mountProxySandbox();

  fetch("./a.js")
    .then((response) => response.text())
    .then((scriptText) => {
      const sourceUrl = `//# sourceURL=a.js\n`;
      window.proxy = proxyA.proxy;
      eval(
        `;(function(window, self){with(window){;${scriptText}\n${sourceUrl}}}).bind(window.proxy)(window.proxy, window.proxy);`
      );
    });
}

function unmountA() {
  proxyA.unmountProxySandbox();
  fetch("./a.js")
    .then((response) => response.text())
    .then((scriptText) => {
      const sourceUrl = `//# sourceURL=a.js\n`;
      eval(
        `;(function(window, self){with(window){;${scriptText}\n${sourceUrl}}}).bind(window.proxy)(window.proxy, window.proxy);`
      );
    });
}

function mountB() {
  proxyB.mountProxySandbox();

  fetch("./b.js")
    .then((response) => response.text())
    .then((scriptText) => {
      const sourceUrl = `//# sourceURL=b.js\n`;
      window.proxy = proxyB.proxy;
      eval(
        `;(function(window, self){with(window){;${scriptText}\n${sourceUrl}}}).bind(window.proxy)(window.proxy, window.proxy);`
      );
    });
}

function unmountB() {
  proxyB.unmountProxySandbox();

  fetch("./b.js")
    .then((response) => response.text())
    .then((scriptText) => {
      const sourceUrl = `//# sourceURL=b.js\n`;
      eval(
        `;(function(window, self){with(window){;${scriptText}\n${sourceUrl}}}).bind(window.proxy)(window.proxy, window.proxy);`
      );
    });
}
```

ä»£ç†æ²™ç®±ä»£ç 

```js
// proxySandbox.ts
function CreateProxySandbox(fakeWindow = {}) {
  const _this = this;
  _this.proxy = new Proxy(fakeWindow, {
    set(target, p, value) {
      if (_this.sandboxRunning) {
        target[p] = value;
      }

      return true;
    },
    get(target, p) {
      if (_this.sandboxRunning) {
        return target[p];
      }
      return undefined;
    },
  });

  _this.mountProxySandbox = () => {
    _this.sandboxRunning = true;
  };

  _this.unmountProxySandbox = () => {
    _this.sandboxRunning = false;
  };
}
```

- ä¼˜ç‚¹

1. å¯åŒæ—¶è¿è¡Œå¤šä¸ªæ²™ç®±
2. ä¸ä¼šæ±¡æŸ“ window ç¯å¢ƒ

- ç¼ºç‚¹

1. ä¸å…¼å®¹ ie
2. åœ¨å…¨å±€ä½œç”¨åŸŸä¸Šé€šè¿‡ `var` æˆ– `function` å£°æ˜çš„å˜é‡å’Œå‡½æ•°æ— æ³•è¢«ä»£ç†æ²™ç®±åŠ«æŒï¼Œå› ä¸ºä»£ç†å¯¹è±¡ `Proxy` åªèƒ½è¯†åˆ«åœ¨è¯¥å¯¹è±¡ä¸Šå­˜åœ¨çš„å±æ€§ï¼Œé€šè¿‡ `var` æˆ– `function` å£°æ˜çš„å˜é‡å¼€è¾Ÿäº†æ–°çš„åœ°å€ï¼Œè‡ªç„¶æ— æ³•è¢« `Proxy` åŠ«æŒï¼Œæ¯”å¦‚

```js
const proxy1 = new CreateProxySandbox({});
proxy1.mountProxySandbox();
(function (window) {
  mountProxySandbox();
  var a = "this is proxySandbox1";
  function b() {}
  console.log("ä»£ç†æ²™ç®±1æŒ‚è½½åçš„a, b:", window.a, window.b); // undefined undefined
})(proxy1.proxy);

proxy1.unmountProxySandbox();
(function (window) {
  console.log("ä»£ç†æ²™ç®±1å¸è½½åçš„a, b:", window.a, window.b); // undefined undefined
})(proxy1.proxy);
```

ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä¸ç”¨ `var` å’Œ `function` å£°æ˜å…¨å±€å˜é‡å’Œå…¨å±€å‡½æ•°ï¼Œæ¯”å¦‚

```js
var a = 1; // å¤±æ•ˆ
a = 1; // æœ‰æ•ˆ
window.a = 1; // æœ‰æ•ˆ

function b() {} // å¤±æ•ˆ
b = () => {}; // æœ‰æ•ˆ
window.b = () => {}; // æœ‰æ•ˆ
```

![javascript_07-08_06](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_06.1j011k0th8jk.webp)

## ä¸‰. CSS éš”ç¦»çš„è®¾è®¡ä¸å®ç°

### 1. CSS éš”ç¦»ç®€ä»‹

é¡µé¢ä¸­æœ‰å¤šä¸ªå¾®åº”ç”¨æ—¶ï¼Œè¦ç¡®ä¿ `A` åº”ç”¨çš„æ ·å¼ä¸ä¼šå½±å“ `B` åº”ç”¨çš„æ ·å¼ï¼Œå°±éœ€è¦å¯¹åº”ç”¨çš„æ ·å¼é‡‡å–éš”ç¦»ã€‚

### 2. åŠ¨æ€æ ·å¼è¡¨ - Dynamic Stylesheet

![javascript_07-08_07](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_07.17kcmv6jwhuk.webp)

### 3. å·¥ç¨‹åŒ–æ‰‹æ®µ - BEMã€CSS Modulesã€CSS in JS

é€šè¿‡ä¸€ç³»åˆ—**çº¦æŸ**å’Œ**ç¼–è¯‘æ—¶ç”Ÿæˆä¸åŒç±»å**ã€**JS ä¸­å¤„ç† CSS ç”Ÿæˆä¸åŒç±»å**æ¥è§£å†³éš”ç¦»é—®é¢˜

![javascript_07-08_08](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_08.71diw28cx380.webp)

### 4. Shadow DOM

`Shadow DOM` å…è®¸å°†éšè—çš„ `DOM` æ ‘é™„åŠ åˆ°å¸¸è§„çš„ `DOM` æ ‘ç§ â€”â€” å®ƒä»¥ `shadow root` èŠ‚ç‚¹ä¸ºèµ·å§‹æ ¹èŠ‚ç‚¹ï¼Œåœ¨è¿™ä¸ªæ ¹èŠ‚ç‚¹çš„ä¸‹æ–¹ï¼Œå¯ä»¥æ˜¯ä»»æ„å…ƒç´ ï¼Œå’Œæ™®é€šçš„ `DOM` å…ƒç´ ä¸€æ ·ï¼Œéšè—çš„ `DOM` æ ·å¼å’Œå…¶ä½™ `DOM` æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œç±»ä¼¼äº `iframe` çš„æ ·å¼éš”ç¦»æ•ˆæœã€‚

![javascript_07-08_09](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_09.3vzejnhzgi60.webp)

> ç§»åŠ¨ç«¯æ¡†æ¶ `Ionic` çš„ç»„ä»¶æ ·å¼éš”ç¦»å°±æ˜¯é‡‡ç”¨çš„ `Shadow DOM` æ–¹æ¡ˆï¼Œä¿è¯ç›¸åŒç»„ä»¶çš„æ ·å¼ä¸ä¼šå†²çªã€‚

![javascript_07-08_10](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_10.3awjie9zwz20.webp)

- demo æ¼”ç¤º

![javascript_07-08_11](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_11.3vg7btv70je0.webp)

- ä»£ç å®ç°

```html
<!DOCTYPE html>
<html lang="en">
  <body data-qiankun-A>
    <h5>æ ·å¼éš”ç¦»ï¼š</h5>
    <p class="title">ä¸€è¡Œæ–‡å­—</p>

    <script src="scopedCSS.js"></script>
    <script src="index.js"></script>
  </body>
</html>
```

```js
// index.js
var bodyNode = document.getElementsByTagName("body")[0];
openShadow(bodyNode);
```

```js
// scopedCss.js
function openShadow(domNode) {
  var shadow = domNode.attachShadow({ mode: "open" });
  shadow.innerHTML = domNode.innerHTML;
  domNode.innerHTML = "";
}
```

- ä¼˜ç‚¹  
  1.å®Œå…¨éš”ç¦» CSS æ ·å¼

- ç¼ºç‚¹  
  2.åœ¨ä½¿ç”¨ä¸€äº›å¼¹çª—ç»„ä»¶çš„æ—¶å€™ï¼ˆå¼¹çª—å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯é»˜è®¤æ·»åŠ åˆ°äº† document.body ï¼‰è¿™ä¸ªæ—¶å€™å®ƒå°±è·³è¿‡äº†é˜´å½±è¾¹ç•Œï¼Œè·‘åˆ°äº†ä¸»åº”ç”¨é‡Œé¢ï¼Œæ ·å¼å°±ä¸¢äº†

### 5. è¿è¡Œæ—¶è½¬æ¢æ ·å¼ - runtime css transformer

åŠ¨æ€è¿è¡Œæ—¶åœ°å»æ”¹å˜ `CSS` ï¼Œæ¯”å¦‚ A åº”ç”¨çš„ä¸€ä¸ªæ ·å¼ `p.title`ï¼Œè½¬æ¢åä¼šå˜æˆ `div[data-qiankun-A] p.titleï¼Œdiv[data-qiankun-A]` æ˜¯å¾®åº”ç”¨æœ€å¤–å±‚çš„å®¹å™¨èŠ‚ç‚¹ï¼Œæ•…ä¿è¯ `A` åº”ç”¨çš„æ ·å¼åªæœ‰åœ¨ `div[data-qiankun-A]` ä¸‹ç”Ÿæ•ˆã€‚

- demo æ¼”ç¤º

![javascript_07-08_12](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_12.5czu02ajomg0.webp)

- ä»£ç å®ç°

```html
<!-- index.html -->
<html lang="en">
  <head>
    <style>
      p.title {
        font-size: 20px;
      }
    </style>
  </head>
  <body data-qiankun-A>
    <p class="title">ä¸€è¡Œæ–‡å­—</p>

    <script src="scopedCSS.js"></script>
    <script>
      var styleNode = document.getElementsByTagName("style")[0];
      scopeCss(styleNode, "body[data-qiankun-A]");
    </script>
  </body>
</html>
```

```js
// scopedCSS.js
function scopeCss(styleNode, prefix) {
  const css = ruleStyle(styleNode.sheet.cssRules[0], prefix);
  styleNode.textContent = css;
}

function ruleStyle(rule, prefix) {
  const rootSelectorRE = /((?:[^\w\-.#]|^)(body|html|:root))/gm;

  let { cssText } = rule;

  // ç»‘å®šé€‰æ‹©å™¨, a,span,p,div { ... }
  cssText = cssText.replace(/^[\s\S]+{/, (selectors) =>
    selectors.replace(/(^|,\n?)([^,]+)/g, (item, p, s) => {
      // ç»‘å®š div,body,span { ... }
      if (rootSelectorRE.test(item)) {
        return item.replace(rootSelectorRE, (m) => {
          // ä¸è¦ä¸¢å¤±æœ‰æ•ˆå­—ç¬¦ å¦‚ body,html or *:not(:root)
          const whitePrevChars = [",", "("];

          if (m && whitePrevChars.includes(m[0])) {
            return `${m[0]}${prefix}`;
          }

          // ç”¨å‰ç¼€æ›¿æ¢æ ¹é€‰æ‹©å™¨
          return prefix;
        });
      }

      return `${p}${prefix} ${s.replace(/^ */, "")}`;
    })
  );

  return cssText;
}
```

- ä¼˜ç‚¹  
  1.æ”¯æŒå¤§éƒ¨åˆ†æ ·å¼éš”ç¦»éœ€æ±‚  
  2.è§£å†³äº† `Shadow DOM` æ–¹æ¡ˆå¯¼è‡´çš„ä¸¢å¤±æ ¹èŠ‚ç‚¹é—®é¢˜

- ç¼ºç‚¹  
  1.è¿è¡Œæ—¶é‡æ–°åŠ è½½æ ·å¼ï¼Œä¼šæœ‰ä¸€å®šæ€§èƒ½æŸè€—

## å››. æ¸…é™¤ js å‰¯ä½œç”¨çš„è®¾è®¡ä¸å®ç°

### 1. æ¸…é™¤ js å‰¯ä½œç”¨ç®€ä»‹

å­åº”ç”¨åœ¨ `æ²™ç®±` ä¸­ä½¿ç”¨ `window.addEventListenerã€setInterval` è¿™äº› `éœ€å¼‚æ­¥ç›‘å¬çš„å…¨å±€api` æ—¶ï¼Œè¦ç¡®ä¿å­åº”ç”¨åœ¨ç§»å‡ºæ—¶ä¹Ÿè¦ç§»å‡ºå¯¹åº”çš„ç›‘å¬äº‹ä»¶ï¼Œå¦åˆ™ä¼šå¯¹å…¶ä»–åº”ç”¨é€ æˆå‰¯ä½œç”¨ã€‚

### 2. å®ç°æ¸…é™¤ js æ“ä½œå‰¯ä½œç”¨

- demo æ¼”ç¤º

![javascript_07-08_13](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/20220708/javascript_07-08_13.10t57rtwi5cg.gif)

- ä»£ç å®ç°

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <h5>æ¸…é™¤windowå‰¯ä½œç”¨ï¼š</h5>
    <button onclick="mountSandbox()">æŒ‚è½½æ²™ç®±å¹¶å¼€å¯å‰¯ä½œç”¨</button>
    <button onclick="unmountSandbox(true)">å¸è½½æ²™ç®±å¹¶å…³é—­å‰¯ä½œç”¨</button>
    <button onclick="unmountSandbox()">æ™®é€šå¸è½½æ²™ç®±</button>

    <script src="proxySandbox.js"></script>
    <script src="patchSideEffects.js"></script>
    <script src="index.js"></script>
  </body>
</html>
```

```js
let mountingFreer;
const proxy2 = new CreateProxySandbox({});

function mountSandbox() {
  proxy2.mountProxySandbox();

  // åœ¨æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œçš„ä»£ç 
  (function (window, self) {
    with (window) {
      // è®°å½•å‰¯ä½œç”¨
      mountingFreer = patchSideEffects(window);
      window.a = "this is proxySandbox2";
      console.log("ä»£ç†æ²™ç®±2æŒ‚è½½åçš„a:", window.a); // undefined

      // è®¾ç½®å±å¹•å˜åŒ–ç›‘å¬
      window.addEventListener("resize", () => {
        console.log("resize");
      });

      // å®šæ—¶è¾“å‡ºå­—ç¬¦ä¸²
      setInterval(() => {
        console.log("Interval");
      }, 500);
    }
  }.bind(proxy2.proxy)(proxy2.proxy, proxy2.proxy));
}

/**
 * @param isPatch æ˜¯å¦å…³é—­å‰¯ä½œç”¨
 */
function unmountSandbox(isPatch = false) {
  proxy2.mountProxySandbox();
  console.log("ä»£ç†æ²™ç®±2å¸è½½åçš„a:", window.a); // undefined
  if (isPatch) {
    mountingFreer();
  }
}
```

```js
// patchSideEffects.js
const rawAddEventListener = window.addEventListener;
const rawRemoveEventListener = window.removeEventListener;

const rawWindowInterval = window.setInterval;
const rawWindowClearInterval = window.clearInterval;

function patch(global) {
  const listenerMap = new Map();
  let intervals = [];

  global.addEventListener = (type, listener, options) => {
    const listeners = listenerMap.get(type) || [];
    listenerMap.set(type, [...listeners, listener]);
    return rawAddEventListener.call(window, type, listener, options);
  };

  global.removeEventListener = (type, listener, options) => {
    const storedTypeListeners = listenerMap.get(type);
    if (
      storedTypeListeners &&
      storedTypeListeners.length &&
      storedTypeListeners.indexOf(listener) !== -1
    ) {
      storedTypeListeners.splice(storedTypeListeners.indexOf(listener), 1);
    }
    return rawRemoveEventListener.call(window, type, listener, options);
  };

  global.clearInterval = (intervalId) => {
    intervals = intervals.filter((id) => id !== intervalId);
    return rawWindowClearInterval(intervalId);
  };

  global.setInterval = (handler, timeout, ...args) => {
    const intervalId = rawWindowInterval(handler, timeout, ...args);
    intervals = [...intervals, intervalId];
    return intervalId;
  };

  return function free() {
    listenerMap.forEach((listeners, type) =>
      [...listeners].forEach((listener) =>
        global.removeEventListener(type, listener)
      )
    );
    global.addEventListener = rawAddEventListener;
    global.removeEventListener = rawRemoveEventListener;

    intervals.forEach((id) => global.clearInterval(id));
    global.setInterval = rawWindowInterval;
    global.clearInterval = rawWindowClearInterval;
  };
}

function patchSideEffects(global) {
  return patch(global);
}
```

## ğŸŒŸ. å‚è€ƒèµ„æ–™

- [å¾®å‰ç«¯è¿è½½ 6/7ï¼šå¾®å‰ç«¯æ¡†æ¶ - qiankun å¤§æ³•å¥½](https://juejin.cn/post/6846687602439897101)
- [qiankun å®˜æ–¹æ–‡æ¡£](https://qiankun.umijs.org/zh/guide#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E5%89%8D%E7%AB%AF)
