---
title: ES6 ç³»åˆ—ä¹‹ defineProperty ä¸ proxy
date: 2021-12-04 12:26:13
permalink: /pages/53eebb/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹ defineProperty ä¸ proxy

## ğŸ“–. å‰è¨€

æˆ‘ä»¬æˆ–å¤šæˆ–å°‘éƒ½å¬è¿‡â€œæ•°æ®ç»‘å®šâ€è¿™ä¸ªè¯ï¼Œâ€œæ•°æ®ç»‘å®šâ€çš„å…³é”®åœ¨äºç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œå¯æ˜¯å¯¹äºè¿™æ ·ä¸€ä¸ªå¯¹è±¡ `var obj = {value: 1}`ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆçŸ¥é“ obj å‘ç”Ÿäº†æ”¹å˜å‘¢ï¼Ÿ

## ä¸€. defineProperty

ES5 æä¾›äº† `Object.defineProperty` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚

**è¯­æ³•**

> Object.defineProperty(obj, prop, descriptor)

**å‚æ•°**

```
obj: è¦åœ¨å…¶ä¸Šå®šä¹‰å±æ€§çš„å¯¹è±¡ã€‚

prop:  è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°ã€‚

descriptor: å°†è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„æè¿°ç¬¦ã€‚
```

ä¸¾ä¸ªä¾‹å­ï¼š

```js
var obj = {};
Object.defineProperty(obj, "num", {
    value : 1,
    writable : true,
    enumerable : true,
    configurable : true
});
//  å¯¹è±¡ obj æ‹¥æœ‰å±æ€§ numï¼Œå€¼ä¸º 1
```

è™½ç„¶æˆ‘ä»¬å¯ä»¥ç›´æ¥æ·»åŠ å±æ€§å’Œå€¼ï¼Œä½†æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½è¿›è¡Œæ›´å¤šçš„é…ç½®ã€‚

å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•° descriptor æ‰€è¡¨ç¤ºçš„å±æ€§æè¿°ç¬¦æœ‰ä¸¤ç§å½¢å¼ï¼š**æ•°æ®æè¿°ç¬¦å’Œå­˜å–æè¿°ç¬¦**ã€‚

**ï¼ˆ1ï¼‰ä¸¤è€…å‡å…·æœ‰ä»¥ä¸‹ä¸¤ç§é”®å€¼ï¼š**

**configurable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ configurable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æè¿°ç¬¦æ‰èƒ½å¤Ÿè¢«æ”¹å˜ï¼Œä¹Ÿèƒ½å¤Ÿè¢«åˆ é™¤ã€‚é»˜è®¤ä¸º falseã€‚
```

**enumerable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ enumerable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æ‰èƒ½å¤Ÿå‡ºç°åœ¨å¯¹è±¡çš„æšä¸¾å±æ€§ä¸­ã€‚é»˜è®¤ä¸º falseã€‚
```

**ï¼ˆ2ï¼‰æ•°æ®æè¿°ç¬¦åŒæ—¶å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š**

**value**

```
è¯¥å±æ€§å¯¹åº”çš„å€¼ã€‚å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ JavaScript å€¼ï¼ˆæ•°å€¼ï¼Œå¯¹è±¡ï¼Œå‡½æ•°ç­‰ï¼‰ã€‚é»˜è®¤ä¸º undefinedã€‚
```

**writable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ writable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æ‰èƒ½è¢«èµ‹å€¼è¿ç®—ç¬¦æ”¹å˜ã€‚é»˜è®¤ä¸º falseã€‚
```

**ï¼ˆ3ï¼‰å­˜å–æè¿°ç¬¦åŒæ—¶å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š**

**get**

```
ä¸€ä¸ªç»™å±æ€§æä¾› getter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ getter åˆ™ä¸º undefinedã€‚è¯¥æ–¹æ³•è¿”å›å€¼è¢«ç”¨ä½œå±æ€§å€¼ã€‚é»˜è®¤ä¸º undefinedã€‚
```

**set**

```
ä¸€ä¸ªç»™å±æ€§æä¾› setter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ setter åˆ™ä¸º undefinedã€‚è¯¥æ–¹æ³•å°†æ¥å—å”¯ä¸€å‚æ•°ï¼Œå¹¶å°†è¯¥å‚æ•°çš„æ–°å€¼åˆ†é…ç»™è¯¥å±æ€§ã€‚é»˜è®¤ä¸º undefinedã€‚
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š

**å±æ€§æè¿°ç¬¦å¿…é¡»æ˜¯æ•°æ®æè¿°ç¬¦æˆ–è€…å­˜å–æè¿°ç¬¦ä¸¤ç§å½¢å¼ä¹‹ä¸€ï¼Œä¸èƒ½åŒæ—¶æ˜¯ä¸¤è€…**ã€‚è¿™å°±æ„å‘³ç€ä½ å¯ä»¥ï¼š

```js
Object.defineProperty({}, "num", {
    value: 1,
    writable: true,
    enumerable: true,
    configurable: true
});
```

ä¹Ÿå¯ä»¥ï¼š

```js
var value = 1;
Object.defineProperty({}, "num", {
    get : function(){
      return value;
    },
    set : function(newValue){
      value = newValue;
    },
    enumerable : true,
    configurable : true
});
```

ä½†æ˜¯ä¸å¯ä»¥ï¼š

```js
// æŠ¥é”™
Object.defineProperty({}, "num", {
    value: 1,
    get: function() {
        return 1;
    }
});
```

æ­¤å¤–ï¼Œæ‰€æœ‰çš„å±æ€§æè¿°ç¬¦éƒ½æ˜¯éå¿…é¡»çš„ï¼Œä½†æ˜¯ descriptor è¿™ä¸ªå­—æ®µæ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸è¿›è¡Œä»»ä½•é…ç½®ï¼Œä½ å¯ä»¥è¿™æ ·ï¼š

```js
var obj = Object.defineProperty({}, "num", {});
console.log(obj.num); // undefined
```

## äºŒ. Setters å’Œ Getters

ä¹‹æ‰€ä»¥è®²åˆ° definePropertyï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨å­˜å–æè¿°ç¬¦ä¸­çš„ `get` å’Œ `set`ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆè¢«ç§°ä¸º `getter` å’Œ `setter`ã€‚ç”± `getter` å’Œ `setter` å®šä¹‰çš„å±æ€§ç§°åšâ€å­˜å–å™¨å±æ€§â€œã€‚

å½“ç¨‹åºæŸ¥è¯¢å­˜å–å™¨å±æ€§çš„å€¼æ—¶ï¼ŒJavaScript è°ƒç”¨ `getter` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯å±æ€§å­˜å–è¡¨è¾¾å¼çš„å€¼ã€‚å½“ç¨‹åºè®¾ç½®ä¸€ä¸ªå­˜å–å™¨å±æ€§çš„å€¼æ—¶ï¼ŒJavaScript è°ƒç”¨ `setter` æ–¹æ³•ï¼Œå°†èµ‹å€¼è¡¨è¾¾å¼å³ä¾§çš„å€¼å½“åšå‚æ•°ä¼ å…¥ `setter`ã€‚
ä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œè¿™ä¸ªæ–¹æ³•è´Ÿè´£â€œè®¾ç½®â€å±æ€§å€¼ã€‚å¯ä»¥å¿½ç•¥ `setter` æ–¹æ³•çš„è¿”å›å€¼ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
var obj = {}, value = null;
Object.defineProperty(obj, "num", {
    get: function(){
        console.log('æ‰§è¡Œäº† get æ“ä½œ')
        return value;
    },
    set: function(newValue) {
        console.log('æ‰§è¡Œäº† set æ“ä½œ')
        value = newValue;
    }
})

obj.num = 1 // æ‰§è¡Œäº† set æ“ä½œ

console.log(obj.num); // æ‰§è¡Œäº† get æ“ä½œ // 1
```

è¿™ä¸å°±æ˜¯æˆ‘ä»¬è¦çš„ç›‘æ§æ•°æ®æ”¹å˜çš„æ–¹æ³•å—ï¼Ÿæˆ‘ä»¬å†æ¥å°è£…ä¸€ä¸‹ï¼š

```js
function Archiver() {
    var value = null;
    // archive n. æ¡£æ¡ˆ
    var archive = [];

    Object.defineProperty(this, 'num', {
        get: function() {
            console.log('æ‰§è¡Œäº† get æ“ä½œ')
            return value;
        },
        set: function(value) {
            console.log('æ‰§è¡Œäº† set æ“ä½œ')
            value = value;
            archive.push({ val: value });
        }
    });

    this.getArchive = function() { return archive; };
}

var arc = new Archiver();
arc.num; // æ‰§è¡Œäº† get æ“ä½œ
arc.num = 11; // æ‰§è¡Œäº† set æ“ä½œ
arc.num = 13; // æ‰§è¡Œäº† set æ“ä½œ
console.log(arc.getArchive()); // [{ val: 11 }, { val: 13 }]
```

## ä¸‰. watch API

æ—¢ç„¶å¯ä»¥ç›‘æ§æ•°æ®çš„æ”¹å˜ï¼Œé‚£æˆ‘å¯ä»¥è¿™æ ·è®¾æƒ³ï¼Œå³å½“æ•°æ®æ”¹å˜çš„æ—¶å€™ï¼Œè‡ªåŠ¨è¿›è¡Œæ¸²æŸ“å·¥ä½œã€‚ä¸¾ä¸ªä¾‹å­ï¼š

HTML ä¸­æœ‰ä¸ª span æ ‡ç­¾å’Œ button æ ‡ç­¾

```html
<span id="container">1</span>
<button id="button">ç‚¹å‡»åŠ  1</button>
```

å½“ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œspan æ ‡ç­¾é‡Œçš„å€¼åŠ  1ã€‚

ä¼ ç»Ÿçš„åšæ³•æ˜¯ï¼š

```js
document.getElementById('button').addEventListener("click", function(){
    var container = document.getElementById("container");
    container.innerHTML = Number(container.innerHTML) + 1;
});
```

å¦‚æœä½¿ç”¨äº† definePropertyï¼š

```js
var obj = {
    value: 1
}

// å‚¨å­˜ obj.value çš„å€¼
var value = 1;

Object.defineProperty(obj, "value", {
    get: function() {
        return value;
    },
    set: function(newValue) {
        value = newValue;
        document.getElementById('container').innerHTML = newValue;
    }
});

document.getElementById('button').addEventListener("click", function() {
    obj.value += 1;
});
```

ä»£ç çœ‹ä¼¼å¢å¤šäº†ï¼Œä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦æ”¹å˜ span æ ‡ç­¾é‡Œçš„å€¼çš„æ—¶å€™ï¼Œç›´æ¥ä¿®æ”¹ `obj.value` çš„å€¼å°±å¯ä»¥äº†ã€‚

ç„¶è€Œï¼Œç°åœ¨çš„å†™æ³•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å•ç‹¬å£°æ˜ä¸€ä¸ªå˜é‡å­˜å‚¨ `obj.value` çš„å€¼ï¼Œå› ä¸ºå¦‚æœä½ åœ¨ `set` ä¸­ç›´æ¥ `obj.value = newValue` å°±ä¼šé™·å…¥æ— é™çš„å¾ªç¯ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç›‘æ§å¾ˆå¤šå±æ€§å€¼çš„æ”¹å˜ï¼Œè¦æ˜¯ä¸€ä¸ªä¸€ä¸ªå†™ï¼Œä¹Ÿå¾ˆç´¯å‘ï¼Œ
æ‰€ä»¥æˆ‘ä»¬ç®€å•å†™ä¸ª watch å‡½æ•°ã€‚ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š

```js
var obj = {
    value: 1
}

watch(obj, "value", function(newvalue){
    document.getElementById('container').innerHTML = newvalue;
})

document.getElementById('button').addEventListener("click", function(){
    obj.value += 1
});
```

æˆ‘ä»¬æ¥å†™ä¸‹è¿™ä¸ª watch å‡½æ•°ï¼š

```js
(function(){
    var root = this;
    function watch(obj, name, func){
        var value = obj[name];

        Object.defineProperty(obj, name, {
            get: function() {
                return value;
            },
            set: function(newValue) {
                value = newValue;
                func(value)
            }
        });

        if (value) obj[name] = value
    }

    this.watch = watch;
})()
```

ç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥ç›‘æ§å¯¹è±¡å±æ€§å€¼çš„æ”¹å˜ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®å±æ€§å€¼çš„æ”¹å˜ï¼Œæ·»åŠ å›è°ƒå‡½æ•°ï¼Œæ£’æ£’å“’~

## å››. proxy

ä½¿ç”¨ `defineProperty` åªèƒ½é‡å®šä¹‰å±æ€§çš„è¯»å–ï¼ˆgetï¼‰å’Œè®¾ç½®ï¼ˆsetï¼‰è¡Œä¸ºï¼Œåˆ°äº† ES6ï¼Œæä¾›äº† Proxyï¼Œå¯ä»¥é‡å®šä¹‰æ›´å¤šçš„è¡Œä¸ºï¼Œæ¯”å¦‚ `in`ã€`delete`ã€å‡½æ•°è°ƒç”¨ç­‰æ›´å¤šè¡Œä¸ºã€‚

Proxy è¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼ŒES6 åŸç”Ÿæä¾› Proxy æ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆ Proxy å®ä¾‹ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š

```js
var proxy = new Proxy(target, handler);
```

proxy å¯¹è±¡çš„æ‰€æœ‰ç”¨æ³•ï¼Œéƒ½æ˜¯ä¸Šé¢è¿™ç§å½¢å¼ï¼Œä¸åŒçš„åªæ˜¯ `handler` å‚æ•°çš„å†™æ³•ã€‚å…¶ä¸­ï¼Œ`new Proxy()` è¡¨ç¤ºç”Ÿæˆä¸€ä¸ª Proxy å®ä¾‹ï¼Œ`target` å‚æ•°è¡¨ç¤ºæ‰€è¦æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡ï¼Œ`handler` å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å®šåˆ¶æ‹¦æˆªè¡Œä¸ºã€‚

```js
var proxy = new Proxy({}, {
    get: function(obj, prop) {
        console.log('è®¾ç½® get æ“ä½œ')
        return obj[prop];
    },
    set: function(obj, prop, value) {
        console.log('è®¾ç½® set æ“ä½œ')
        obj[prop] = value;
    }
});

proxy.time = 35; // è®¾ç½® set æ“ä½œ

console.log(proxy.time); // è®¾ç½® get æ“ä½œ // 35
```

é™¤äº† `get` å’Œ `set` ä¹‹å¤–ï¼Œproxy å¯ä»¥æ‹¦æˆªå¤šè¾¾ 13 ç§æ“ä½œï¼Œæ¯”å¦‚ `has(target, propKey)`ï¼Œå¯ä»¥æ‹¦æˆª `propKey in proxy` çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

```js
// ä½¿ç”¨ has æ–¹æ³•éšè—æŸäº›å±æ€§ï¼Œä¸è¢« in è¿ç®—ç¬¦å‘ç°
var handler = {
  has (target, key) {
    if (key[0] === '_') {
      return false;
    }
    return key in target;
  }
};
var target = { _prop: 'foo', prop: 'foo' };
var proxy = new Proxy(target, handler);
console.log('_prop' in proxy); // false
```

åˆæ¯”å¦‚è¯´ apply æ–¹æ³•æ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ã€`call` å’Œ `apply` æ“ä½œã€‚

apply æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€ç›®æ ‡å¯¹è±¡çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆthisï¼‰å’Œç›®æ ‡å¯¹è±¡çš„å‚æ•°æ•°ç»„ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬ç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼š

```js
var target = function () { return 'I am the target'; };
var handler = {
  apply: function () {
    return 'I am the proxy';
  }
};

var p = new Proxy(target, handler);

p();
// "I am the proxy"
```

åˆæ¯”å¦‚è¯´ ownKeys æ–¹æ³•å¯ä»¥æ‹¦æˆªå¯¹è±¡è‡ªèº«å±æ€§çš„è¯»å–æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œæ‹¦æˆªä»¥ä¸‹æ“ä½œï¼š

- `Object.getOwnPropertyNames()`
- `Object.getOwnPropertySymbols()`
- `Object.keys()`

ä¸‹é¢çš„ä¾‹å­æ˜¯æ‹¦æˆªç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºä¸‹åˆ’çº¿çš„å±æ€§åï¼Œä¸è®©å®ƒè¢« for of éå†åˆ°ã€‚

```js
let target = {
  _bar: 'foo',
  _prop: 'bar',
  prop: 'baz'
};

let handler = {
  ownKeys (target) {
    return Reflect.ownKeys(target).filter(key => key[0] !== '_');
  }
};

let proxy = new Proxy(target, handler);
for (let key of Object.keys(proxy)) {
  console.log(target[key]);
}
// "baz"
```

æ›´å¤šçš„æ‹¦æˆªè¡Œä¸ºå¯ä»¥æŸ¥çœ‹é˜®ä¸€å³°è€å¸ˆçš„ [ã€ŠECMAScript 6 å…¥é—¨ã€‹](http://es6.ruanyifeng.com/#docs/proxy)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œproxy çš„æœ€å¤§é—®é¢˜åœ¨äºæµè§ˆå™¨æ”¯æŒåº¦ä¸å¤Ÿï¼Œè€Œä¸”å¾ˆå¤šæ•ˆæœæ— æ³•ä½¿ç”¨ `poilyfill` æ¥å¼¥è¡¥ã€‚

## äº”. watch API ä¼˜åŒ–

æˆ‘ä»¬ä½¿ç”¨ proxy å†æ¥å†™ä¸€ä¸‹ watch å‡½æ•°ã€‚ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š

```js
(function() {
    var root = this;

    function watch(target, func) {

        var proxy = new Proxy(target, {
            get: function(target, prop) {
                return target[prop];
            },
            set: function(target, prop, value) {
                target[prop] = value;
                func(prop, value);
            }
        });

        return proxy;
    }

    this.watch = watch;
})()

var obj = {
    value: 1
}

var newObj = watch(obj, function(key, newvalue) {
    if (key == 'value') document.getElementById('container').innerHTML = newvalue;
})

document.getElementById('button').addEventListener("click", function() {
    newObj.value += 1
});
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œä½¿ç”¨ `defineProperty` å’Œ `proxy` çš„åŒºåˆ«ï¼Œå½“ä½¿ç”¨ `defineProperty`ï¼Œæˆ‘ä»¬ä¿®æ”¹åŸæ¥çš„ `obj` å¯¹è±¡å°±å¯ä»¥è§¦å‘æ‹¦æˆªï¼Œè€Œä½¿ç”¨ `proxy`ï¼Œå°±å¿…é¡»ä¿®æ”¹ä»£ç†å¯¹è±¡ï¼Œå³ `Proxy` çš„å®ä¾‹æ‰å¯ä»¥è§¦å‘æ‹¦æˆªã€‚
