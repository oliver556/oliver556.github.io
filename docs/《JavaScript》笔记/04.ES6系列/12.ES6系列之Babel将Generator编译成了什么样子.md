---
title: ES6 ç³»åˆ—ä¹‹ Babel å°† Generator ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­
date: 2021-11-30 14:23:15
permalink: /pages/191832/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹ Babel å°† Generator ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­

## ğŸ“–. å‰è¨€

æœ¬æ–‡å°±æ˜¯ç®€å•ä»‹ç»ä¸‹ Generator è¯­æ³•ç¼–è¯‘åçš„ä»£ç ã€‚

## ä¸€. Generator

```js
function* helloWorldGenerator() {
  yield 'hello';
  yield 'world';
  return 'ending';
}
```

æˆ‘ä»¬æ‰“å°ä¸‹æ‰§è¡Œçš„ç»“æœï¼š

```js
var hw = helloWorldGenerator();

console.log(hw.next()); // {value: "hello", done: false}
console.log(hw.next()); // {value: "world", done: false}
console.log(hw.next()); // {value: "ending", done: true}
console.log(hw.next()); // {value: undefined, done: true}
```

## äºŒ. Babel

å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹å°±ä¸è¯´äº†ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ Babel å®˜ç½‘çš„ [Try it out](https://babeljs.io/repl) ç²˜è´´ä¸Šè¿°ä»£ç ï¼Œç„¶åæŸ¥çœ‹ä»£ç è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­ï¼š

```js
/**
 * æˆ‘ä»¬å°±ç§°å‘¼è¿™ä¸ªç‰ˆæœ¬ä¸ºç®€å•ç¼–è¯‘ç‰ˆæœ¬å§
 */
var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);

function helloWorldGenerator() {
  return regeneratorRuntime.wrap(
    function helloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case 0:
            _context.next = 2;
            return "hello";

          case 2:
            _context.next = 4;
            return "world";

          case 4:
            return _context.abrupt("return", "ending");

          case 5:
          case "end":
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}
```

çŒ›ä¸€çœ‹ï¼Œå¥½åƒç¼–è¯‘åçš„ä»£ç è¿˜è›®å°‘çš„ï¼Œä½†æ˜¯ç»†ç»†ä¸€çœ‹ï¼Œç¼–è¯‘åçš„ä»£ç è‚¯å®šæ˜¯ä¸èƒ½ç”¨çš„å‘€ï¼Œ`regeneratorRuntime` æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿå“ªé‡Œéƒ½æœ‰å£°æ˜å‘€ï¼Ÿ`mark` å’Œ `warp` æ–¹æ³•åˆéƒ½åšäº†ä»€ä¹ˆï¼Ÿ

éš¾é“å°±ä¸èƒ½ç¼–è¯‘ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„ä»£ç å—ï¼Ÿ

## ä¸‰. regenerator

å¦‚æœä½ æƒ³çœ‹åˆ°å®Œæ•´å¯ç”¨çš„ä»£ç ï¼Œä½ å¯ä»¥ä½¿ç”¨ [regenerator](https://github.com/facebook/regenerator)ï¼Œè¿™æ˜¯ facebook ä¸‹çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºç¼–è¯‘ ES6 çš„ generator å‡½æ•°ã€‚

æˆ‘ä»¬å…ˆå®‰è£…ä¸€ä¸‹ regeneratorï¼š

```bash
npm install -g regenerator
```

ç„¶åæ–°å»ºä¸€ä¸ª `generator.js` æ–‡ä»¶ï¼Œé‡Œé¢çš„ä»£ç å°±æ˜¯æ–‡ç« æœ€ä¸€å¼€å§‹çš„ä»£ç ï¼Œæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤ï¼š

```bash
regenerator --include-runtime generator.js > generator-es5.js
```

æˆ‘ä»¬å°±å¯ä»¥åœ¨ generator-es5.js æ–‡ä»¶çœ‹åˆ°ç¼–è¯‘åçš„å®Œæ•´å¯ç”¨çš„ä»£ç ã€‚

è€Œè¿™ä¸€ç¼–è¯‘å°±ç¼–è¯‘äº† 700 å¤šè¡Œâ€¦â€¦

æ€»ä¹‹ç¼–è¯‘åçš„ä»£ç è¿˜è›®å¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­æŠ½ç¦»å‡ºå¤§è‡´çš„é€»è¾‘ï¼Œè‡³å°‘è®©ç®€å•ç¼–è¯‘çš„é‚£æ®µä»£ç èƒ½å¤Ÿè·‘èµ·æ¥ã€‚

## å››. mark å‡½æ•°

ç®€å•ç¼–è¯‘åçš„ä»£ç ç¬¬ä¸€æ®µæ˜¯è¿™æ ·çš„ï¼š

```js
var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);
```

æˆ‘ä»¬æŸ¥çœ‹å®Œæ•´ç¼–è¯‘ç‰ˆæœ¬ä¸­ mark å‡½æ•°çš„æºç ï¼š

```js
runtime.mark = function(genFun) {
  genFun.__proto__ = GeneratorFunctionPrototype;
  genFun.prototype = Object.create(Gp);
  return genFun;
};
```

è¿™å…¶ä¸­åˆæ¶‰åŠäº† GeneratorFunctionPrototype å’Œ Gp å˜é‡ï¼Œæˆ‘ä»¬ä¹ŸæŸ¥çœ‹ä¸‹å¯¹åº”çš„ä»£ç ï¼š

```js
function Generator() {}
function GeneratorFunction() {}
function GeneratorFunctionPrototype() {}

...

var Gp = GeneratorFunctionPrototype.prototype =
  Generator.prototype = Object.create(IteratorPrototype);

GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;

GeneratorFunctionPrototype.constructor = GeneratorFunction;

GeneratorFunctionPrototype[toStringTagSymbol] =
  GeneratorFunction.displayName = "GeneratorFunction";
```

è¿™æ®µä»£ç æ„å»ºäº†ä¸€å †çœ‹èµ·æ¥å¾ˆå¤æ‚çš„å…³ç³»é“¾ï¼Œå…¶å®è¿™æ˜¯å‚ç…§ç€ [ES6 è§„èŒƒ](https://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-constructor) æ„å»ºçš„å…³ç³»é“¾:

![javascript_05-20_01](https://cdn.staticaly.com/gh/oliver556/image-hosting@master/javascript_05-20_01.5ns6ba7v94g0.webp)

å›¾ä¸­ `+@@toStringTag:s = 'Generator'` çš„å°±æ˜¯ Gpï¼Œ`+@@toStringTag:s = 'GeneratorFunction'` çš„å°±æ˜¯ GeneratorFunctionPrototypeã€‚

æ„å»ºå…³ç³»é“¾çš„ç›®çš„åœ¨äºåˆ¤æ–­å…³ç³»çš„æ—¶å€™èƒ½å¤Ÿè·ŸåŸç”Ÿçš„ä¿æŒä¸€è‡´ï¼Œå°±æ¯”å¦‚ï¼š

```js
function* f() {}
var g = f();
console.log(g.__proto__ === f.prototype); // true
console.log(g.__proto__.__proto__ === f.__proto__.prototype); // true
```

ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Gp å…ˆè®¾ç½®ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œä¸è¿‡æ­£å¦‚ä½ åœ¨ä¸Šå›¾ä¸­çœ‹åˆ°çš„ï¼Œ`next()`ã€ `throw()`ã€`return()` å‡½æ•°éƒ½æ˜¯æŒ‚è½½åœ¨ Gp å¯¹è±¡ä¸Šï¼Œå®é™…ä¸Šï¼Œåœ¨å®Œæ•´çš„ç¼–è¯‘ä»£ç ä¸­ï¼Œç¡®å®æœ‰ä¸º Gp æ·»åŠ è¿™ä¸‰ä¸ªå‡½æ•°çš„æ–¹æ³•ï¼š

```js
// 117 è¡Œ
function defineIteratorMethods(prototype) {
  ["next", "throw", "return"].forEach(function(method) {
    prototype[method] = function(arg) {
      return this._invoke(method, arg);
    };
  });
}

// 406 è¡Œ
defineIteratorMethods(Gp);
```

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æ•´ä¸ª mark å‡½æ•°ç®€åŒ–ä¸ºï¼š

```js
runtime.mark = function(genFun) {
  var generator = Object.create({
    next: function(arg) {
      return this._invoke('next', arg)
    }
  });
  genFun.prototype = generator;
  return genFun;
};
```

## äº”. wrap å‡½æ•°

é™¤äº†è®¾ç½®å…³ç³»é“¾ä¹‹å¤–ï¼Œmark å‡½æ•°çš„è¿”å›å€¼ genFun è¿˜ä½œä¸ºäº† wrap å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ï¼š

```js
function helloWorldGenerator() {
  return regeneratorRuntime.wrap(
    function helloWorldGenerator$(_context) {
      ...
    },
    _marked,
    this
  );
}
```

æˆ‘ä»¬å†çœ‹ä¸‹ wrap å‡½æ•°ï¼š

```js
function wrap(innerFn, outerFn, self) {
  var generator = Object.create(outerFn.prototype);
  var context = new Context([]);
  generator._invoke = makeInvokeMethod(innerFn, self, context);

  return generator;
}
```

æ‰€ä»¥å½“æ‰§è¡Œ `var hw = helloWorldGenerator();` çš„æ—¶å€™ï¼Œå…¶å®æ‰§è¡Œçš„æ˜¯ wrap å‡½æ•°ï¼Œwrap å‡½æ•°è¿”å›äº† generatorï¼Œgenerator æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŸå‹æ˜¯ `outerFn.prototype`, `outerFn.prototype` å…¶å®å°±æ˜¯ `genFun.prototype`ï¼Œ
`genFun.prototype` æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼ŒåŸå‹ä¸Šæœ‰ `next()` æ–¹æ³•ã€‚

æ‰€ä»¥å½“ä½ æ‰§è¡Œ hw.next() çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å…¶å®æ˜¯ hw åŸå‹çš„åŸå‹ä¸Šçš„ next å‡½æ•°ï¼Œnext å‡½æ•°æ‰§è¡Œçš„åˆæ˜¯ hw çš„ _invoke å‡½æ•°ï¼š

```js
generator._invoke = makeInvokeMethod(innerFn, self, context);
```

innerFn å°±æ˜¯ wrap åŒ…è£¹çš„é‚£ä¸ªå‡½æ•°ï¼Œå…¶å®å°±æ˜¯ helloWordGenerato$ å‡½æ•°ï¼Œå‘ï¼Œå°±æ˜¯è¿™ä¸ªå‡½æ•°ï¼š

```js
function helloWorldGenerator$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      case 0:
        _context.next = 2;
        return "hello";

      case 2:
        _context.next = 4;
        return "world";

      case 4:
        return _context.abrupt("return", "ending");

      case 5:
      case "end":
        return _context.stop();
    }
  }
}
```

è€Œ context ä½ å¯ä»¥ç›´æ¥ç†è§£ä¸ºè¿™æ ·ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼š

```js
var ContinueSentinel = {};

var context = {
  done: false,
  method: "next",
  next: 0,
  prev: 0,
  abrupt: function(type, arg) {
    var record = {};
    record.type = type;
    record.arg = arg;

    return this.complete(record);
  },
  complete: function(record, afterLoc) {
    if (record.type === "return") {
      this.rval = this.arg = record.arg;
      this.method = "return";
      this.next = "end";
    }

    return ContinueSentinel;
  },
  stop: function() {
    this.done = true;
    return this.rval;
  }
};
```

æ¯æ¬¡ `hw.next` çš„æ—¶å€™ï¼Œå°±ä¼šä¿®æ”¹ next å’Œ prev å±æ€§çš„å€¼ï¼Œå½“åœ¨ generator å‡½æ•°ä¸­ return çš„æ—¶å€™ä¼šæ‰§è¡Œ abruptï¼Œabrupt ä¸­åˆä¼šæ‰§è¡Œ completeï¼Œæ‰§è¡Œå®Œ completeï¼Œå› ä¸º `this.next = end` çš„ç¼˜æ•…ï¼Œå†æ‰§è¡Œå°±ä¼šæ‰§è¡Œ stop å‡½æ•°ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹ makeInvokeMethod å‡½æ•°ï¼š

```js
var ContinueSentinel = {};

function makeInvokeMethod(innerFn, self, context) {
  var state = 'start';

  return function invoke(method, arg) {

    if (state === 'completed') {
      return { value: undefined, done: true };
    }

    context.method = method;
    context.arg = arg;

    while (true) {

      state = 'executing';

      var record = {
        type: 'normal',
        arg: innerFn.call(self, context)
      };
      if (record.type === "normal") {

        state = context.done
          ? 'completed'
          : 'yield';

        if (record.arg === ContinueSentinel) {
          continue;
        }

        return {
          value: record.arg,
          done: context.done
        };

      }
    }
  };
}
```

åŸºæœ¬çš„æ‰§è¡Œè¿‡ç¨‹å°±ä¸åˆ†æäº†ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ç¬¬ä¸‰æ¬¡æ‰§è¡Œ `hw.next()` çš„æ—¶å€™:

ç¬¬ä¸‰æ¬¡æ‰§è¡Œ `hw.next()` çš„æ—¶å€™ï¼Œå…¶å®æ‰§è¡Œäº†

```js
this._invoke("next", undefined);
```

æˆ‘ä»¬åœ¨ invoke å‡½æ•°ä¸­æ„å»ºäº†ä¸€ä¸ª record å¯¹è±¡ï¼š

```js
var record = {
  type: "normal",
  arg: innerFn.call(self, context)
};
```

è€Œåœ¨ `innerFn.call(self, context)` ä¸­ï¼Œå› ä¸º _context.next ä¸º 4 çš„ç¼˜æ•…ï¼Œå…¶å®æ‰§è¡Œäº†:

```js
_context.abrupt("return", 'ending');
```

è€Œåœ¨ abrupt ä¸­ï¼Œæˆ‘ä»¬åˆæ„å»ºäº†ä¸€ä¸ª record å¯¹è±¡ï¼š

```js
var record = {};
record.type = 'return';
record.arg = 'ending';
```

ç„¶åæ‰§è¡Œäº† `this.complete(record)`ï¼Œ

åœ¨ complete ä¸­ï¼Œå› ä¸º `record.type === "return"`

```js
this.rval = 'ending';
this.method = "return";
this.next = "end";
```

ç„¶åè¿”å›äº†å…¨å±€å¯¹è±¡ ContinueSentinelï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå…¨å±€ç©ºå¯¹è±¡ã€‚

ç„¶ååœ¨ invoke å‡½æ•°ä¸­ï¼Œå› ä¸º `record.arg === ContinueSentinel` çš„ç¼˜æ•…ï¼Œæ²¡æœ‰æ‰§è¡Œåé¢çš„ return è¯­å¥ï¼Œå°±ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚

äºæ˜¯åˆæ‰§è¡Œäº†ä¸€é `innerFn.call(self, context)`ï¼Œæ­¤æ—¶ `_context.next` ä¸º end, æ‰§è¡Œäº† `_context.stop()`, åœ¨ stop å‡½æ•°ä¸­ï¼š

```js
this.done = true;
return this.rval; // this.rval å…¶å®å°±æ˜¯ `ending`
```

æ‰€ä»¥æœ€ç»ˆè¿”å›çš„å€¼ä¸º:

```
{
  value: 'ending',
  done: true
};
```

ä¹‹åï¼Œæˆ‘ä»¬å†æ‰§è¡Œ hw.next() çš„æ—¶å€™ï¼Œå› ä¸º state å·²ç»æ˜¯ `completed` çš„ç¼˜æ•…ï¼Œç›´æ¥å°±è¿”å› `{ value: undefined, done: true}`

## å…­. ä¸å®Œæ•´ä½†å¯ç”¨çš„æºç 

å½“ç„¶è¿™ä¸ªè¿‡ç¨‹ï¼Œçœ‹æ–‡å­—ç†è§£èµ·æ¥å¯èƒ½æœ‰äº›éš¾åº¦ï¼Œä¸å®Œæ•´ä½†å¯ç”¨çš„ä»£ç å¦‚ä¸‹ï¼Œä½ å¯ä»¥æ–­ç‚¹è°ƒè¯•æŸ¥çœ‹å…·ä½“çš„è¿‡ç¨‹ï¼š

```js
(function() {
  var ContinueSentinel = {};

  var mark = function(genFun) {
    var generator = Object.create({
      next: function(arg) {
        return this._invoke("next", arg);
      }
    });
    genFun.prototype = generator;
    return genFun;
  };

  function wrap(innerFn, outerFn, self) {
    var generator = Object.create(outerFn.prototype);

    var context = {
      done: false,
      method: "next",
      next: 0,
      prev: 0,
      abrupt: function(type, arg) {
        var record = {};
        record.type = type;
        record.arg = arg;

        return this.complete(record);
      },
      complete: function(record, afterLoc) {
        if (record.type === "return") {
          this.rval = this.arg = record.arg;
          this.method = "return";
          this.next = "end";
        }

        return ContinueSentinel;
      },
      stop: function() {
        this.done = true;
        return this.rval;
      }
    };

    generator._invoke = makeInvokeMethod(innerFn, context);

    return generator;
  }

  function makeInvokeMethod(innerFn, context) {
    var state = "start";

    return function invoke(method, arg) {
      if (state === "completed") {
        return { value: undefined, done: true };
      }

      context.method = method;
      context.arg = arg;

      while (true) {
        state = "executing";

        var record = {
          type: "normal",
          arg: innerFn.call(self, context)
        };

        if (record.type === "normal") {
          state = context.done ? "completed" : "yield";

          if (record.arg === ContinueSentinel) {
            continue;
          }

          return {
            value: record.arg,
            done: context.done
          };
        }
      }
    };
  }

  window.regeneratorRuntime = {};

  regeneratorRuntime.wrap = wrap;
  regeneratorRuntime.mark = mark;
})();

var _marked = regeneratorRuntime.mark(helloWorldGenerator);

function helloWorldGenerator() {
  return regeneratorRuntime.wrap(
    function helloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case 0:
            _context.next = 2;
            return "hello";

          case 2:
            _context.next = 4;
            return "world";

          case 4:
            return _context.abrupt("return", "ending");

          case 5:
          case "end":
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}

var hw = helloWorldGenerator();

console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
```
