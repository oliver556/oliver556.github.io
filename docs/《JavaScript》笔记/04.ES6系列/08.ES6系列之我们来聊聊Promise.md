---
title: ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠ Promise
date: 2021-11-26 10:44:37
permalink: /pages/c721c4/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠ Promise

## ğŸ“–. å‰è¨€

Promise çš„åŸºæœ¬ä½¿ç”¨å¯ä»¥çœ‹é˜®ä¸€å³°è€å¸ˆçš„[ã€ŠECMAScript 6 å…¥é—¨ã€‹](http://es6.ruanyifeng.com/#docs/promise)ã€‚

## ä¸€. å›è°ƒ

è¯´èµ· Promiseï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä»å›è°ƒæˆ–è€…å›è°ƒåœ°ç‹±è¯´èµ·ï¼Œé‚£ä¹ˆä½¿ç”¨å›è°ƒåˆ°åº•ä¼šå¯¼è‡´å“ªäº›ä¸å¥½çš„åœ°æ–¹å‘¢ï¼Ÿ

### 1. å›è°ƒåµŒå¥—

ä½¿ç”¨å›è°ƒï¼Œæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½ä¼šå°†ä¸šåŠ¡ä»£ç å†™æˆå¦‚ä¸‹è¿™ç§å½¢å¼ï¼š

```js
doA( function(){
  doB();

  doC( function(){
    doD();
  } );

  doE();
} );

doF();
```

å½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–çš„å½¢å¼ï¼Œç»è¿‡ä¸€ç•ªç®€å•çš„æ€è€ƒï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡ºæ‰§è¡Œçš„é¡ºåºä¸ºï¼š

```js
doA()
doF()
doB()
doC()
doE()
doD()
```

ç„¶è€Œåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œä»£ç ä¼šæ›´åŠ æ‚ä¹±ï¼Œä¸ºäº†æ’æŸ¥é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡å¾ˆå¤šç¢çœ¼çš„å†…å®¹ï¼Œä¸æ–­çš„åœ¨å‡½æ•°é—´è¿›è¡Œè·³è½¬ï¼Œä½¿å¾—æ’æŸ¥é—®é¢˜çš„éš¾åº¦ä¹Ÿåœ¨æˆå€å¢åŠ ã€‚

å½“ç„¶ä¹‹æ‰€ä»¥å¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®æ˜¯å› ä¸ºè¿™ç§åµŒå¥—çš„ä¹¦å†™æ–¹å¼è·Ÿäººçº¿æ€§çš„æ€è€ƒæ–¹å¼ç›¸è¿å’Œï¼Œä»¥è‡³äºæˆ‘ä»¬è¦å¤šèŠ±ä¸€äº›ç²¾åŠ›å»æ€è€ƒçœŸæ­£çš„æ‰§è¡Œé¡ºåºï¼ŒåµŒå¥—å’Œç¼©è¿›åªæ˜¯è¿™ä¸ªæ€è€ƒè¿‡ç¨‹ä¸­è½¬ç§»æ³¨æ„åŠ›çš„ç»†ææœ«èŠ‚è€Œå·²ã€‚

å½“ç„¶äº†ï¼Œä¸äººçº¿æ€§çš„æ€è€ƒæ–¹å¼ç›¸è¿å’Œï¼Œè¿˜ä¸æ˜¯æœ€ç³Ÿç³•çš„ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨ä»£ç ä¸­åŠ å…¥å„ç§å„æ ·çš„é€»è¾‘åˆ¤æ–­ï¼Œå°±æ¯”å¦‚åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`doD()` å¿…é¡»åœ¨ `doC()` å®Œæˆåæ‰èƒ½å®Œæˆï¼Œä¸‡ä¸€ `doC()` æ‰§è¡Œå¤±è´¥äº†å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯è¦é‡è¯• `doC()` å—ï¼Ÿ
è¿˜æ˜¯ç›´æ¥è·³è½¬åˆ°å…¶ä»–é”™è¯¯å¤„ç†å‡½æ•°ä¸­ï¼Ÿå½“æˆ‘ä»¬å°†è¿™äº›åˆ¤æ–­éƒ½åŠ å…¥åˆ°è¿™ä¸ªæµç¨‹ä¸­ï¼Œå¾ˆå¿«ä»£ç å°±ä¼šå˜å¾—éå¸¸å¤æ‚ï¼Œä»¥è‡³äºæ— æ³•ç»´æŠ¤å’Œæ›´æ–°ã€‚

### 2. æ§åˆ¶åè½¬

æ­£å¸¸ä¹¦å†™ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç†æ‰€å½“ç„¶å¯ä»¥æ§åˆ¶è‡ªå·±çš„ä»£ç ï¼Œç„¶è€Œå½“æˆ‘ä»¬ä½¿ç”¨å›è°ƒçš„æ—¶å€™ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°æ˜¯å¦èƒ½æ¥ç€æ‰§è¡Œï¼Œå…¶å®å–å†³äºä½¿ç”¨å›è°ƒçš„é‚£ä¸ª APIï¼Œå°±æ¯”å¦‚ï¼š

```js
// å›è°ƒå‡½æ•°æ˜¯å¦è¢«æ‰§è¡Œå–å†³äº buy æ¨¡å—
import { buy } from './buy.js';

buy(iteimData, function(res) {
  console.log(res);
});
```

å¯¹äºæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ `fetch` è¿™ç§ APIï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹çš„ API å‘¢ï¼Ÿ

å½“ä½ è°ƒç”¨äº†ç¬¬ä¸‰æ–¹çš„ API ï¼Œå¯¹æ–¹æ˜¯å¦ä¼šå› ä¸ºæŸä¸ªé”™è¯¯å¯¼è‡´ä½ ä¼ å…¥çš„å›è°ƒå‡½æ•°æ‰§è¡Œäº†å¤šæ¬¡å‘¢ï¼Ÿ

ä¸ºäº†é¿å…å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œä½ å¯ä»¥åœ¨è‡ªå·±çš„å›è°ƒå‡½æ•°ä¸­åŠ å…¥åˆ¤æ–­ï¼Œå¯æ˜¯ä¸‡ä¸€åˆå› ä¸ºæŸä¸ªé”™è¯¯å¯¼è‡´è¿™ä¸ªå›è°ƒå‡½æ•°æ²¡æœ‰æ‰§è¡Œå‘¢ï¼Ÿä¸‡ä¸€è¿™ä¸ªå›è°ƒå‡½æ•°æœ‰æ—¶åŒæ­¥æ‰§è¡Œæœ‰æ—¶å¼‚æ­¥æ‰§è¡Œå‘¢ï¼Ÿ

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹è¿™äº›æƒ…å†µï¼š

1. å›è°ƒå‡½æ•°æ‰§è¡Œå¤šæ¬¡ã€‚
2. å›è°ƒå‡½æ•°æ²¡æœ‰æ‰§è¡Œã€‚
3. å›è°ƒå‡½æ•°æœ‰æ—¶åŒæ­¥æ‰§è¡Œï¼Œæœ‰æ—¶å¼‚æ­¥æ‰§è¡Œã€‚

å¯¹äºè¿™äº›æƒ…å†µï¼Œä½ å¯èƒ½éƒ½è¦åœ¨å›è°ƒå‡½æ•°ä¸­åšäº›å¤„ç†ï¼Œå¹¶ä¸”æ¯æ¬¡æ‰§è¡Œå›è°ƒå‡½æ•°çš„æ—¶å€™éƒ½è¦åšè¿™äº›å¤„ç†ï¼Œè¿™å°±å¸¦æ¥äº†å¾ˆå¤šé‡å¤çš„ä»£ç ã€‚

## äºŒ. å›è°ƒåœ°ç‹±

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„å›è°ƒåœ°ç‹±çš„ç¤ºä¾‹ã€‚

ç°åœ¨è¦æ‰¾å‡ºä¸€ä¸ªç›®å½•ä¸­æœ€å¤§çš„æ–‡ä»¶ï¼Œå¤„ç†æ­¥éª¤åº”è¯¥æ˜¯ï¼š

1. ç”¨ `fs.readdir` è·å–ç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨ã€‚
2. å¾ªç¯éå†æ–‡ä»¶ï¼Œä½¿ç”¨ `fs.stat` è·å–æ–‡ä»¶ä¿¡æ¯ã€‚
3. æ¯”è¾ƒæ‰¾å‡ºæœ€å¤§æ–‡ä»¶ã€‚
4. ä»¥æœ€å¤§æ–‡ä»¶çš„æ–‡ä»¶åä¸ºå‚æ•°è°ƒç”¨å›è°ƒã€‚

ä»£ç ä¸ºï¼š

```js
var fs = require('fs');
var path = require('path');

function findLargest(dir, cb) {
    // è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
    fs.readdir(dir, function(er, files) {
        if (er) return cb(er);

        var counter = files.length;
        var errored = false;
        var stats = [];

        files.forEach(function(file, index) {
            // è¯»å–æ–‡ä»¶ä¿¡æ¯
            fs.stat(path.join(dir, file), function(er, stat) {

                if (errored) return;

                if (er) {
                    errored = true;
                    return cb(er);
                }

                stats[index] = stat;

                // äº‹å…ˆç®—å¥½æœ‰å¤šå°‘ä¸ªæ–‡ä»¶ï¼Œè¯»å®Œ 1 ä¸ªæ–‡ä»¶ä¿¡æ¯ï¼Œè®¡æ•°å‡ 1ï¼Œå½“ä¸º 0 æ—¶ï¼Œè¯´æ˜è¯»å–å®Œæ¯•ï¼Œæ­¤æ—¶æ‰§è¡Œæœ€ç»ˆçš„æ¯”è¾ƒæ“ä½œ
                if (--counter == 0) {

                    var largest = stats
                        .filter(function(stat) { return stat.isFile() })
                        .reduce(function(prev, next) {
                            if (prev.size > next.size) return prev
                            return next
                        })

                    cb(null, files[stats.indexOf(largest)])
                }
            })
        })
    })
}
```

ä½¿ç”¨æ–¹å¼ä¸ºï¼š

```js
// æŸ¥æ‰¾å½“å‰ç›®å½•æœ€å¤§çš„æ–‡ä»¶
findLargest('./', function(er, filename) {
    if (er) return console.error(er)
    console.log('largest file was:', filename)
});
```

ä½ å¯ä»¥å°†ä»¥ä¸Šä»£ç å¤åˆ¶åˆ°ä¸€ä¸ªæ¯”å¦‚ `index.js` æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ `node index.js` å°±å¯ä»¥æ‰“å°å‡ºæœ€å¤§çš„æ–‡ä»¶çš„åç§°ã€‚

çœ‹å®Œè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å†æ¥èŠèŠå›è°ƒåœ°ç‹±çš„å…¶ä»–é—®é¢˜ï¼š

**1. éš¾ä»¥å¤ç”¨**

å›è°ƒçš„é¡ºåºç¡®å®šä¸‹æ¥ä¹‹åï¼Œæƒ³å¯¹å…¶ä¸­çš„æŸäº›ç¯èŠ‚è¿›è¡Œå¤ç”¨ä¹Ÿå¾ˆå›°éš¾ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æƒ³å¯¹ `fs.stat` è¯»å–æ–‡ä»¶ä¿¡æ¯è¿™æ®µä»£ç å¤ç”¨ï¼Œå› ä¸ºå›è°ƒä¸­å¼•ç”¨äº†å¤–å±‚çš„å˜é‡ï¼Œæå–å‡ºæ¥åè¿˜éœ€è¦å¯¹å¤–å±‚çš„ä»£ç è¿›è¡Œä¿®æ”¹ã€‚

**2. å †æ ˆä¿¡æ¯è¢«æ–­å¼€**

æˆ‘ä»¬çŸ¥é“ï¼ŒJavaScript å¼•æ“ç»´æŠ¤äº†ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆï¼Œå½“å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºè¯¥å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥æ ˆä¸­ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šå°†è¯¥æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆã€‚

å¦‚æœ A å‡½æ•°ä¸­è°ƒç”¨äº† Bå‡½æ•°ï¼ŒJavaScript ä¼šå…ˆå°† A å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥æ ˆä¸­ï¼Œå†å°† B å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥æ ˆä¸­ï¼Œå½“ B å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå°† B å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆï¼Œå½“ A å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°† A å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆã€‚

è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬å¦‚æœä¸­æ–­ä»£ç æ‰§è¡Œï¼Œå¯ä»¥æ£€ç´¢å®Œæ•´çš„å †æ ˆä¿¡æ¯ï¼Œä»ä¸­è·å–ä»»ä½•æˆ‘ä»¬æƒ³è·å–çš„ä¿¡æ¯ã€‚

å¯æ˜¯å¼‚æ­¥å›è°ƒå¹¶éå¦‚æ­¤ï¼Œæ¯”å¦‚æ‰§è¡Œ `fs.readdir` çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å°†å›è°ƒå‡½æ•°åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä»£ç ç»§ç»­æ‰§è¡Œï¼Œç›´è‡³ä¸»çº¿å®Œæˆåï¼Œæ‰ä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­é€‰æ‹©å·²ç»å®Œæˆçš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶åŠ å…¥æ ˆä¸­ï¼Œæ­¤æ—¶æ ˆä¸­åªæœ‰è¿™ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¦‚æœå›è°ƒæŠ¥é”™ï¼Œ
ä¹Ÿæ— æ³•è·å–è°ƒç”¨è¯¥å¼‚æ­¥æ“ä½œæ—¶çš„æ ˆä¸­çš„ä¿¡æ¯ï¼Œä¸å®¹æ˜“åˆ¤æ–­å“ªé‡Œå‡ºç°äº†é”™è¯¯ã€‚

æ­¤å¤–ï¼Œå› ä¸ºæ˜¯å¼‚æ­¥çš„ç¼˜æ•…ï¼Œä½¿ç”¨ `try catch` è¯­å¥ä¹Ÿæ— æ³•ç›´æ¥æ•è·é”™è¯¯ã€‚

ï¼ˆä¸è¿‡ Promise å¹¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼‰

**3. å€ŸåŠ©å¤–å±‚å˜é‡**

å½“å¤šä¸ªå¼‚æ­¥è®¡ç®—åŒæ—¶è¿›è¡Œæ—¶ï¼Œæ¯”å¦‚è¿™é‡Œéå†è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼Œç”±äºæ— æ³•é¢„æœŸå®Œæˆé¡ºåºï¼Œå¿…é¡»å€ŸåŠ©å¤–å±‚ä½œç”¨åŸŸçš„å˜é‡ï¼Œæ¯”å¦‚è¿™é‡Œçš„ countã€erroredã€stats ç­‰ï¼Œä¸ä»…å†™èµ·æ¥éº»çƒ¦ï¼Œè€Œä¸”å¦‚æœä½ å¿½ç•¥äº†æ–‡ä»¶è¯»å–é”™è¯¯çš„æƒ…å†µï¼Œä¸è®°å½•é”™è¯¯çŠ¶æ€ï¼Œ
å°±ä¼šæ¥ç€è¯»å–å…¶ä»–æ–‡ä»¶ï¼Œé€ æˆæ— è°“çš„æµªè´¹ã€‚æ­¤å¤–å¤–å±‚çš„å˜é‡ï¼Œä¹Ÿå¯èƒ½è¢«å…¶å®ƒåŒä¸€ä½œç”¨åŸŸçš„å‡½æ•°è®¿é—®å¹¶ä¸”ä¿®æ”¹ï¼Œå®¹æ˜“é€ æˆè¯¯æ“ä½œã€‚

**ä¹‹æ‰€ä»¥å•ç‹¬è®²è®²å›è°ƒåœ°ç‹±ï¼Œå…¶å®æ˜¯æƒ³è¯´åµŒå¥—å’Œç¼©è¿›åªæ˜¯å›è°ƒåœ°ç‹±çš„ä¸€ä¸ªæ¢—è€Œå·²ï¼Œå®ƒå¯¼è‡´çš„é—®é¢˜è¿œéåµŒå¥—å¯¼è‡´çš„å¯è¯»æ€§é™ä½è€Œå·²ã€‚**

## ä¸‰. Promise

Promise ä½¿å¾—ä»¥ä¸Šç»å¤§éƒ¨åˆ†çš„é—®é¢˜éƒ½å¾—åˆ°äº†è§£å†³ã€‚

### 1. åµŒå¥—é—®é¢˜

ä¸¾ä¸ªä¾‹å­ï¼š

```js
request(url, function(err, res, body) {
    if (err) handleError(err);
    fs.writeFile('1.txt', body, function(err) {
        request(url2, function(err, res, body) {
            if (err) handleError(err)
        })
    })
});
```

ä½¿ç”¨ Promise åï¼š

```js
request(url)
.then(function(result) {
    return writeFileAsynv('1.txt', result)
})
.then(function(result) {
    return request(url2)
})
.catch(function(e){
    handleError(e)
});
```

è€Œå¯¹äºè¯»å–æœ€å¤§æ–‡ä»¶çš„é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Promise å¯ä»¥ç®€åŒ–ä¸ºï¼š

```js
var fs = require('fs');
var path = require('path');

var readDir = function(dir) {
    return new Promise(function(resolve, reject) {
        fs.readdir(dir, function(err, files) {
            if (err) reject(err);
            resolve(files)
        })
    })
}

var stat = function(path) {
    return new Promise(function(resolve, reject) {
        fs.stat(path, function(err, stat) {
            if (err) reject(err)
            resolve(stat)
        })
    })
}

function findLargest(dir) {
    return readDir(dir)
        .then(function(files) {
            let promises = files.map(file => stat(path.join(dir, file)))
            return Promise.all(promises).then(function(stats) {
                return { stats, files }
            })
        })
        .then(data => {

            let largest = data.stats
                .filter(function(stat) { return stat.isFile() })
                .reduce((prev, next) => {
                    if (prev.size > next.size) return prev
                    return next
                })

            return data.files[data.stats.indexOf(largest)]
        })

}
```

### 2. æ§åˆ¶åè½¬å†åè½¬

å‰é¢æˆ‘ä»¬è®²åˆ°ä½¿ç”¨ç¬¬ä¸‰æ–¹å›è°ƒ API çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š

1. å›è°ƒå‡½æ•°æ‰§è¡Œå¤šæ¬¡ã€‚
2. å›è°ƒå‡½æ•°æ²¡æœ‰æ‰§è¡Œã€‚
3. å›è°ƒå‡½æ•°æœ‰æ—¶åŒæ­¥æ‰§è¡Œï¼Œæœ‰æ—¶å¼‚æ­¥æ‰§è¡Œã€‚

å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒPromise åªèƒ½ `resolve` ä¸€æ¬¡ï¼Œå‰©ä¸‹çš„è°ƒç”¨éƒ½ä¼šè¢«å¿½ç•¥ã€‚

å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Promise.race` å‡½æ•°æ¥è§£å†³ï¼š

```js
function timeoutPromise(delay) {
    return new Promise( function(resolve,reject){
        setTimeout( function(){
            reject( "Timeout!" );
        }, delay );
    } );
}

Promise.race( [
    foo(),
    timeoutPromise( 3000 )
] )
.then(function(){}, function(err){});
```

å¯¹äºç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæœ‰çš„æ—¶å€™ä¼šåŒæ­¥æ‰§è¡Œï¼Œæœ‰çš„æ—¶å€™ä¼šå¼‚æ­¥æ‰§è¡Œå‘¢ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š

```js
var cache = {...};
function downloadFile(url) {
      if(cache.has(url)) {
            // å¦‚æœå­˜åœ¨ cacheï¼Œè¿™é‡Œä¸ºåŒæ­¥è°ƒç”¨
           return Promise.resolve(cache.get(url));
      }
     return fetch(url).then(file => cache.set(url, file)); // è¿™é‡Œä¸ºå¼‚æ­¥è°ƒç”¨
}
console.log('1');
getValue.then(() => console.log('2'));
console.log('3');
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ `cache` çš„æƒ…å†µä¸‹ï¼Œæ‰“å°ç»“æœä¸º 1 2 3ï¼Œåœ¨æ²¡æœ‰ cache çš„æ—¶å€™ï¼Œæ‰“å°ç»“æœä¸º 1 3 2ã€‚

ç„¶è€Œå¦‚æœå°†è¿™ç§åŒæ­¥å’Œå¼‚æ­¥æ··ç”¨çš„ä»£ç  ä½œä¸ºå†…éƒ¨å®ç°ï¼Œåªæš´éœ²æ¥å£ç»™å¤–éƒ¨è°ƒç”¨ï¼Œè°ƒç”¨æ–¹ç”±äºæ— æ³•åˆ¤æ–­åˆ°åº•æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥çŠ¶æ€ï¼Œå½±å“ç¨‹åºçš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

ç®€å•æ¥è¯´å°±æ˜¯åŒæ­¥å’Œå¼‚æ­¥å…±å­˜çš„æƒ…å†µæ— æ³•ä¿è¯ç¨‹åºé€»è¾‘çš„ä¸€è‡´æ€§ã€‚

ç„¶è€Œ Promise è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š

```js
var promise = new Promise(function (resolve){
    resolve();
    console.log(1);
});
promise.then(function(){
    console.log(2);
});
console.log(3);

// 1 3 2
```

å³ä½¿ Promise å¯¹è±¡ç«‹åˆ»è¿›å…¥ resolved çŠ¶æ€ï¼Œå³åŒæ­¥è°ƒç”¨ resolve å‡½æ•°ï¼Œthen å‡½æ•°ä¸­æŒ‡å®šçš„æ–¹æ³•ä¾ç„¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ã€‚

PromiseA+ è§„èŒƒä¹Ÿæœ‰æ˜ç¡®çš„è§„å®šã€‚

> å®è·µä¸­è¦ç¡®ä¿ `onFulfilled` å’Œ `onRejected` æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ `then` æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚

## å››. Promise åæ¨¡å¼

**1. Promise åµŒå¥—**

```js
// bad
loadSomething().then(function(something) {
    loadAnotherthing().then(function(another) {
        DoSomethingOnThem(something, another);
    });
});
```

```js
// good
Promise.all([loadSomething(), loadAnotherthing()])
.then(function ([something, another]) {
    DoSomethingOnThem(...[something, another]);
});
```

**2. æ–­å¼€çš„ Promise é“¾**

```js
// bad
function anAsyncCall() {
    var promise = doSomethingAsync();
    promise.then(function() {
        somethingComplicated();
    });

    return promise;
}
```

```js
// good
function anAsyncCall() {
    var promise = doSomethingAsync();
    return promise.then(function() {
        somethingComplicated()
    });
}
```

**3. æ··ä¹±çš„é›†åˆ**

```js
// bad
function workMyCollection(arr) {
    var resultArr = [];
    function _recursive(idx) {
        if (idx >= resultArr.length) return resultArr;

        return doSomethingAsync(arr[idx]).then(function(res) {
            resultArr.push(res);
            return _recursive(idx + 1);
        });
    }

    return _recursive(0);
}
```

ä½ å¯ä»¥å†™æˆï¼š

```js
function workMyCollection(arr) {
    return Promise.all(arr.map(function(item) {
        return doSomethingAsync(item);
    }));
}
```

å¦‚æœä½ éè¦ä»¥é˜Ÿåˆ—çš„å½¢å¼æ‰§è¡Œï¼Œä½ å¯ä»¥å†™æˆï¼š

```js
function workMyCollection(arr) {
    return arr.reduce(function(promise, item) {
        return promise.then(function(result) {
            return doSomethingAsyncWithResult(item, result);
        });
    }, Promise.resolve());
}
```

**4. catch**

```js
// bad
somethingAync.then(function() {
    return somethingElseAsync();
}, function(err) {
    handleMyError(err);
});
```

å¦‚æœ `somethingElseAsync` æŠ›å‡ºé”™è¯¯ï¼Œæ˜¯æ— æ³•è¢«æ•è·çš„ã€‚ä½ å¯ä»¥å†™æˆï¼š

```js
// good
somethingAsync
.then(function() {
    return somethingElseAsync()
})
.then(null, function(err) {
    handleMyError(err);
});
```

```js
// good
somethingAsync()
.then(function() {
    return somethingElseAsync();
})
.catch(function(err) {
    handleMyError(err);
});
```

## äº”. çº¢ç»¿ç¯é—®é¢˜

é¢˜ç›®ï¼šçº¢ç¯ä¸‰ç§’äº®ä¸€æ¬¡ï¼Œç»¿ç¯ä¸€ç§’äº®ä¸€æ¬¡ï¼Œé»„ç¯2ç§’äº®ä¸€æ¬¡ï¼›å¦‚ä½•è®©ä¸‰ä¸ªç¯ä¸æ–­äº¤æ›¿é‡å¤äº®ç¯ï¼Ÿï¼ˆç”¨ Promise å®ç°ï¼‰

ä¸‰ä¸ªäº®ç¯å‡½æ•°å·²ç»å­˜åœ¨ï¼š

```js
function red(){
    console.log('red');
}
function green(){
    console.log('green');
}
function yellow(){
    console.log('yellow');
}
```

åˆ©ç”¨ then å’Œé€’å½’å®ç°ï¼š

```js
function red(){
    console.log('red');
}
function green(){
    console.log('green');
}
function yellow(){
    console.log('yellow');
}

var light = function(timmer, cb){
    return new Promise(function(resolve, reject) {
        setTimeout(function() {
            cb();
            resolve();
        }, timmer);
    });
};

var step = function() {
    Promise.resolve().then(function(){
        return light(3000, red);
    }).then(function(){
        return light(2000, green);
    }).then(function(){
        return light(1000, yellow);
    }).then(function(){
        step();
    });
}

step();
```

## å…­. promisify

æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°† callback è¯­æ³•çš„ API æ”¹é€ æˆ Promise è¯­æ³•ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ª promisify çš„æ–¹æ³•ã€‚

å› ä¸º callback è¯­æ³•ä¼ å‚æ¯”è¾ƒæ˜ç¡®ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œå°±æ˜¯ nullï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å†™å‡ºä¸€ä¸ªç®€å•çš„ promisify æ–¹æ³•ï¼š

```js
function promisify(original) {
    return function (...args) {
        return new Promise((resolve, reject) => {
            args.push(function callback(err, ...values) {
                if (err) {
                    return reject(err);
                }
                return resolve(...values)
            });
            original.call(this, ...args);
        });
    };
}
```

## ä¸ƒ. Promise çš„å±€é™æ€§

### 1. é”™è¯¯è¢«åƒæ‰

é¦–å…ˆæˆ‘ä»¬è¦ç†è§£ï¼Œä»€ä¹ˆæ˜¯é”™è¯¯è¢«åƒæ‰ï¼Œæ˜¯æŒ‡é”™è¯¯ä¿¡æ¯ä¸è¢«æ‰“å°å—ï¼Ÿ

å¹¶ä¸æ˜¯ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
throw new Error('error');
console.log(233333);
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå› ä¸º throw error çš„ç¼˜æ•…ï¼Œä»£ç è¢«é˜»æ–­æ‰§è¡Œï¼Œå¹¶ä¸ä¼šæ‰“å° 233333ï¼Œå†ä¸¾ä¸ªä¾‹å­ï¼š

```js
const promise = new Promise(null);
console.log(233333);
```

ä»¥ä¸Šä»£ç ä¾ç„¶ä¼šè¢«é˜»æ–­æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœé€šè¿‡æ— æ•ˆçš„æ–¹å¼ä½¿ç”¨ Promiseï¼Œå¹¶ä¸”å‡ºç°äº†ä¸€ä¸ªé”™è¯¯é˜»ç¢äº†æ­£å¸¸ Promise çš„æ„é€ ï¼Œç»“æœä¼šå¾—åˆ°ä¸€ä¸ªç«‹åˆ»è·‘å‡ºçš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¢«æ‹’ç»çš„ Promiseã€‚

ç„¶è€Œå†ä¸¾ä¸ªä¾‹å­ï¼š

```js
let promise = new Promise(() => {
    throw new Error('error')
});
console.log(2333333);
```

è¿™æ¬¡ä¼šæ­£å¸¸çš„æ‰“å° `233333`ï¼Œè¯´æ˜ Promise å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå½±å“åˆ° Promise å¤–éƒ¨çš„ä»£ç ï¼Œè€Œè¿™ç§æƒ…å†µæˆ‘ä»¬å°±é€šå¸¸ç§°ä¸º â€œåƒæ‰é”™è¯¯â€ã€‚

å…¶å®è¿™å¹¶ä¸æ˜¯ Promise ç‹¬æœ‰çš„å±€é™æ€§ï¼Œtry..catch ä¹Ÿæ˜¯è¿™æ ·ï¼ŒåŒæ ·ä¼šæ•è·ä¸€ä¸ªå¼‚å¸¸å¹¶ç®€å•çš„åƒæ‰é”™è¯¯ã€‚

è€Œæ­£æ˜¯å› ä¸ºé”™è¯¯è¢«åƒæ‰ï¼ŒPromise é“¾ä¸­çš„é”™è¯¯å¾ˆå®¹æ˜“è¢«å¿½ç•¥æ‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šä¸€èˆ¬æ¨èåœ¨ Promise é“¾çš„æœ€åæ·»åŠ ä¸€ä¸ª catch å‡½æ•°ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªæ²¡æœ‰é”™è¯¯å¤„ç†å‡½æ•°çš„ Promise é“¾ï¼Œä»»ä½•é”™è¯¯éƒ½ä¼šåœ¨é“¾ä¸­è¢«ä¼ æ’­ä¸‹å»ï¼Œç›´åˆ°ä½ æ³¨å†Œäº†é”™è¯¯å¤„ç†å‡½æ•°ã€‚

### 2. å•ä¸€å€¼

Promise åªèƒ½æœ‰ä¸€ä¸ªå®Œæˆå€¼æˆ–ä¸€ä¸ªæ‹’ç»åŸå› ï¼Œç„¶è€Œåœ¨çœŸå®ä½¿ç”¨çš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦ä¼ é€’å¤šä¸ªå€¼ï¼Œä¸€èˆ¬åšæ³•éƒ½æ˜¯æ„é€ ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ï¼Œç„¶åå†ä¼ é€’ï¼Œthen ä¸­è·å¾—è¿™ä¸ªå€¼åï¼Œåˆä¼šè¿›è¡Œå–å€¼èµ‹å€¼çš„æ“ä½œï¼Œæ¯æ¬¡å°è£…å’Œè§£å°éƒ½æ— ç–‘è®©ä»£ç å˜å¾—ç¬¨é‡ã€‚

è¯´çœŸçš„ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•ï¼Œå»ºè®®æ˜¯ä½¿ç”¨ ES6 çš„è§£æ„èµ‹å€¼ï¼š

```js
Promise.all([Promise.resolve(1), Promise.resolve(2)])
.then(([x, y]) => {
    console.log(x, y);
});
```

### 3. æ— æ³•å–æ¶ˆ

Promise ä¸€æ—¦æ–°å»ºå®ƒå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆã€‚

### 4. æ— æ³•å¾—çŸ¥ pending çŠ¶æ€

å½“å¤„äº pending çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°å“ªä¸€ä¸ªé˜¶æ®µï¼ˆåˆšåˆšå¼€å§‹è¿˜æ˜¯å³å°†å®Œæˆï¼‰ã€‚

## ğŸŒŸ. å‚è€ƒ

- ã€Šä½ ä¸çŸ¥é“çš„ JavaScript ä¸­å·ã€‹
- [Promise çš„ N ç§ç”¨æ³•](https://ke.segmentfault.com/l/1500000008757392)
- [JavaScript Promise è¿·ä½ ä¹¦](http://liubin.org/promises-book/#promise-done)
- [Promises/A+è§„èŒƒ](https://www.ituring.com.cn/article/66566)
- [Promise å¦‚ä½•ä½¿ç”¨](https://www.cnblogs.com/ZHONGZHENHUA/p/8486616.html)
- [ä¸€é“å…³äºPromiseåº”ç”¨çš„é¢è¯•é¢˜](https://www.cnblogs.com/dojo-lzz/p/5495671.html)
