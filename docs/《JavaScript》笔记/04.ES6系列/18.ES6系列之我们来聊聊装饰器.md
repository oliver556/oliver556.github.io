---
title: ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠè£…é¥°å™¨
date: 2021-12-06 14:18:03
permalink: /pages/5a833a/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠè£…é¥°å™¨

## ä¸€. Decorator

è£…é¥°å™¨ä¸»è¦ç”¨äº:

1. è£…é¥°ç±»
2. è£…é¥°æ–¹æ³•æˆ–å±æ€§

### 1. è£…é¥°å™¨

```js
@annotation
class MyClass { }

function annotation(target) {
   target.annotated = true;
}
```

### 2. è£…é¥°æ–¹æ³•æˆ–å±æ€§

```js
class MyClass {
  @readonly
  method() { }
}

function readonly(target, name, descriptor) {
  descriptor.writable = false;
  return descriptor;
}
```

## äºŒ. Babel

### 1. å®‰è£…ç¼–è¯‘

æˆ‘ä»¬å¯ä»¥åœ¨ Babel å®˜ç½‘çš„ [Try it out](https://babeljs.io/repl/build/8875/#?babili=false&browsers=&build=&builtIns=false&spec=false&loose=false&code_lz=GYVwdgxgLglg9mABAZzgWwKYBEMTgJwEMoCAKAawBtDlkAaRcjATwYBMNkIBKRAbwBQiRPgxQQ-JBy4BuAQF8BAqPmb8hiCNVqIAYnDjrhwgAKpMOPERL4NwgOZiU6DAEEIETqnylefRcKK8prEEAAWiKQY-Ph-GnhgqJQYAHTR-GTp3HLyQA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=true&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=es2015%2Creact%2Cstage-2&prettier=false&targets=&version=7.0.0-rc.1%2Bpr.8505&envVersion=)ï¼ŒæŸ¥çœ‹ Babel ç¼–è¯‘åçš„ä»£ç ã€‚

ä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©æœ¬åœ°ç¼–è¯‘ï¼š

```bash
npm init

npm install --save-dev @babel/core @babel/cli

npm install --save-dev @babel/plugin-proposal-decorators @babel/plugin-proposal-class-properties
```

æ–°å»º `.babelrc` æ–‡ä»¶

```json
{
  "plugins": [
    ["@babel/plugin-proposal-decorators", { "legacy": true }],
    ["@babel/plugin-proposal-class-properties", {"loose": true}]
  ]
}
```

å†ç¼–è¯‘æŒ‡å®šçš„æ–‡ä»¶

```bash
babel decorator.js --out-file decorator-compiled.js
```

### 2. è£…é¥°ç±»çš„ç¼–è¯‘

ç¼–è¯‘å‰ï¼š

```js
@annotation
class MyClass { }

function annotation(target) {
   target.annotated = true;
}
```

ç¼–è¯‘åï¼š

```js
var _class;

let MyClass = annotation(_class = class MyClass {}) || _class;

function annotation(target) {
  target.annotated = true;
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºç±»çš„è£…é¥°ï¼Œå…¶åŸç†å°±æ˜¯ï¼š

```js
@decorator
class A {}

// ç­‰åŒäº

class A {}
A = decorator(A) || A;
```

### 3. è£…é¥°æ–¹æ³•çš„ç¼–è¯‘

ç¼–è¯‘å‰ï¼š

```js
class MyClass {
  @unenumerable
  @readonly
  method() { }
}

function readonly(target, name, descriptor) {
  descriptor.writable = false;
  return descriptor;
}

function unenumerable(target, name, descriptor) {
  descriptor.enumerable = false;
  return descriptor;
}
```

ç¼–è¯‘åï¼š

```js
var _class;

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context ) {
	/**
	 * ç¬¬ä¸€éƒ¨åˆ†
	 * æ‹·è´å±æ€§
	 */
	var desc = {};
	Object["ke" + "ys"](descriptor).forEach(function(key) {
		desc[key] = descriptor[key];
	});
	desc.enumerable = !!desc.enumerable;
	desc.configurable = !!desc.configurable;

	if ("value" in desc || desc.initializer) {
		desc.writable = true;
	}

	/**
	 * ç¬¬äºŒéƒ¨åˆ†
	 * åº”ç”¨å¤šä¸ª decorators
	 */
	desc = decorators
		.slice()
		.reverse()
		.reduce(function(desc, decorator) {
			return decorator(target, property, desc) || desc;
		}, desc);

	/**
	 * ç¬¬ä¸‰éƒ¨åˆ†
	 * è®¾ç½®è¦ decorators çš„å±æ€§
	 */
	if (context && desc.initializer !== void 0) {
		desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
		desc.initializer = undefined;
	}

	if (desc.initializer === void 0) {
		Object["define" + "Property"](target, property, desc);
		desc = null;
	}

	return desc;
}

let MyClass = ((_class = class MyClass {
	method() {}
}),
_applyDecoratedDescriptor(
	_class.prototype,
	"method",
	[readonly],
	Object.getOwnPropertyDescriptor(_class.prototype, "method"),
	_class.prototype
),
_class);

function readonly(target, name, descriptor) {
	descriptor.writable = false;
	return descriptor;
}
```

### 4. è£…é¥°æ–¹æ³•çš„ç¼–è¯‘æºç è§£æ

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Babel æ„å»ºäº†ä¸€ä¸ª _applyDecoratedDescriptor å‡½æ•°ï¼Œç”¨äºç»™æ–¹æ³•è£…é¥°ã€‚

#### (1). Object.getOwnPropertyDescriptor()

åœ¨ä¼ å…¥å‚æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª `Object.getOwnPropertyDescriptor()` æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š

> Object.getOwnPropertyDescriptor() æ–¹æ³•è¿”å›æŒ‡å®šå¯¹è±¡ä¸Šçš„ä¸€ä¸ªè‡ªæœ‰å±æ€§å¯¹åº”çš„å±æ€§æè¿°ç¬¦ã€‚ï¼ˆè‡ªæœ‰å±æ€§æŒ‡çš„æ˜¯ç›´æ¥èµ‹äºˆè¯¥å¯¹è±¡çš„å±æ€§ï¼Œä¸éœ€è¦ä»åŸå‹é“¾ä¸Šè¿›è¡ŒæŸ¥æ‰¾çš„å±æ€§ï¼‰

é¡ºä¾¿æ³¨æ„è¿™æ˜¯ä¸€ä¸ª ES5 çš„æ–¹æ³•ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
const foo = { value: 1 };
const bar = Object.getOwnPropertyDescriptor(foo, "value");
// bar {
//   value: 1,
//   writable: true
//   enumerable: true,
//   configurable: true,
// }

const foo = { get value() { return 1; } };
const bar = Object.getOwnPropertyDescriptor(foo, "value");
// bar {
//   get: /*the getter function*/,
//   set: undefined
//   enumerable: true,
//   configurable: true,
// }
```

#### (2). ç¬¬ä¸€éƒ¨åˆ†æºç è§£æ

åœ¨ _`applyDecoratedDescriptor` å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬é¦–å…ˆå°† `Object.getOwnPropertyDescriptor()` è¿”å›çš„å±æ€§æè¿°ç¬¦å¯¹è±¡åšäº†ä¸€ä»½æ‹·è´ï¼š

```js
// æ‹·è´ä¸€ä»½ descriptor
var desc = {};
Object["ke" + "ys"](descriptor).forEach(function(key) {
	desc[key] = descriptor[key];
});
desc.enumerable = !!desc.enumerable;
desc.configurable = !!desc.configurable;

// å¦‚æœæ²¡æœ‰ value å±æ€§æˆ–è€…æ²¡æœ‰ initializer å±æ€§ï¼Œè¡¨æ˜æ˜¯ getter å’Œ setter
if ("value" in desc || desc.initializer) {
	desc.writable = true;
}
```

é‚£ä¹ˆ `initializer` å±æ€§æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ`Object.getOwnPropertyDescriptor()` è¿”å›çš„å¯¹è±¡å¹¶ä¸å…·æœ‰è¿™ä¸ªå±æ€§å‘€ï¼Œç¡®å®ï¼Œè¿™æ˜¯ Babel çš„ Class ä¸ºäº†ä¸ `decorator` é…åˆè€Œäº§ç”Ÿçš„ä¸€ä¸ªå±æ€§ï¼Œæ¯”å¦‚è¯´å¯¹äºä¸‹é¢è¿™ç§ä»£ç ï¼š

```js
class MyClass {
  @readonly
  born = Date.now();
}

function readonly(target, name, descriptor) {
  descriptor.writable = false;
  return descriptor;
}

var foo = new MyClass();
console.log(foo.born);
```

Babel å°±ä¼šç¼–è¯‘ä¸ºï¼š

```js
// ...
(_descriptor = _applyDecoratedDescriptor(_class.prototype, "born", [readonly], {
	configurable: true,
	enumerable: true,
	writable: true,
	initializer: function() {
		return Date.now();
	}
}))
// ...
```

æ­¤æ—¶ä¼ å…¥ _`applyDecoratedDescriptor` å‡½æ•°çš„ `descriptor` å°±å…·æœ‰ `initializer` å±æ€§ã€‚

#### (3). ç¬¬äºŒéƒ¨åˆ†æºç è§£æ

æ¥ä¸‹æ˜¯åº”ç”¨å¤šä¸ª decoratorsï¼š

```js
/**
 * ç¬¬äºŒéƒ¨åˆ†
 * @type {[type]}
 */
desc = decorators
	.slice()
	.reverse()
	.reduce(function(desc, decorator) {
		return decorator(target, property, desc) || desc;
	}, desc);
```

å¯¹äºä¸€ä¸ªæ–¹æ³•åº”ç”¨äº†å¤šä¸ª `decorator`ï¼Œæ¯”å¦‚ï¼š

```js
class MyClass {
  @unenumerable
  @readonly
  method() { }
}
```

Babel ä¼šç¼–è¯‘ä¸ºï¼š

```js
_applyDecoratedDescriptor(
	_class.prototype,
	"method",
	[unenumerable, readonly],
	Object.getOwnPropertyDescriptor(_class.prototype, "method"),
	_class.prototype
)
```

åœ¨ç¬¬äºŒéƒ¨åˆ†çš„æºç ä¸­ï¼Œæ‰§è¡Œäº† `reverse()` å’Œ `reduce()` æ“ä½œï¼Œç”±æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œå¦‚æœåŒä¸€ä¸ªæ–¹æ³•æœ‰å¤šä¸ªè£…é¥°å™¨ï¼Œä¼šç”±å†…å‘å¤–æ‰§è¡Œã€‚

#### (4). ç¬¬ä¸‰éƒ¨åˆ†æºç è§£æ

```js
/**
 * ç¬¬ä¸‰éƒ¨åˆ†
 * è®¾ç½®è¦ decorators çš„å±æ€§
 */
if (context && desc.initializer !== void 0) {
	desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
	desc.initializer = undefined;
}

if (desc.initializer === void 0) {
	Object["define" + "Property"](target, property, desc);
	desc = null;
}

return desc;
```

å¦‚æœ `desc` æœ‰ `initializer` å±æ€§ï¼Œæ„å‘³ç€å½“è£…é¥°çš„æ˜¯ç±»çš„å±æ€§æ—¶ï¼Œä¼šå°† value çš„å€¼è®¾ç½®ä¸º:

```js
desc.initializer.call(context);
```

è€Œ context çš„å€¼ä¸º `_class.prototype`ï¼Œä¹‹æ‰€ä»¥è¦ `call(context)`ï¼Œè¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæœ‰å¯èƒ½

```js
class MyClass {
  @readonly
  value = this.getNum() + 1;

  getNum() {
    return 1;
  }
}
```

æœ€åæ— è®ºæ˜¯è£…é¥°æ–¹æ³•è¿˜æ˜¯å±æ€§ï¼Œéƒ½ä¼šæ‰§è¡Œï¼š

```js
Object["define" + "Property"](target, property, desc);
```

ç”±æ­¤å¯è§ï¼Œè£…é¥°æ–¹æ³•æœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨ `Object.defineProperty()` æ¥å®ç°çš„ã€‚

## ä¸‰. åº”ç”¨

### 1. log

ä¸ºä¸€ä¸ªæ–¹æ³•æ·»åŠ  log å‡½æ•°ï¼Œæ£€æŸ¥è¾“å…¥çš„å‚æ•°ï¼š

```js
class Math {
  @log
  add(a, b) {
    return a + b;
  }
}

function log(target, name, descriptor) {
  var oldValue = descriptor.value;

  descriptor.value = function(...args) {
    console.log(`Calling ${name} with`, args);
    return oldValue.apply(this, args);
  };

  return descriptor;
}

const math = new Math();

// Calling add with [2, 4]
math.add(2, 4);
```

å†å®Œå–„ç‚¹ï¼š

```js
let log = (type) => {
  return (target, name, descriptor) => {
    const method = descriptor.value;
    descriptor.value =  (...args) => {
      console.info(`(${type}) æ­£åœ¨æ‰§è¡Œ: ${name}(${args}) = ?`);
      let ret;
      try {
        ret = method.apply(target, args);
        console.info(`(${type}) æˆåŠŸ : ${name}(${args}) => ${ret}`);
      } catch (error) {
        console.error(`(${type}) å¤±è´¥: ${name}(${args}) => ${error}`);
      }
      return ret;
    }
  }
};
```

### 2. autobind

```js
class Person {
  @autobind
  getPerson() {
  	return this;
  }
}

let person = new Person();
let { getPerson } = person;

getPerson() === person;
// true
```

æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªåœºæ™¯æ˜¯ React ç»‘å®šäº‹ä»¶çš„æ—¶å€™ï¼š

```js
class Toggle extends React.Component {

  @autobind
  handleClick() {
	  console.log(this)
  }

  render() {
    return (
      <button onClick={this.handleClick}>
        button
      </button>
    );
  }
}
```

æˆ‘ä»¬æ¥å†™è¿™æ ·ä¸€ä¸ª autobind å‡½æ•°ï¼š

```js
const { defineProperty, getPrototypeOf} = Object;

function bind(fn, context) {
  if (fn.bind) {
    return fn.bind(context);
  } else {
    return function __autobind__() {
      return fn.apply(context, arguments);
    };
  }
}

function createDefaultSetter(key) {
  return function set(newValue) {
    Object.defineProperty(this, key, {
      configurable: true,
      writable: true,
      enumerable: true,
      value: newValue
    });

    return newValue;
  };
}

function autobind(target, key, { value: fn, configurable, enumerable }) {
  if (typeof fn !== 'function') {
    throw new SyntaxError(`@autobind can only be used on functions, not: ${fn}`);
  }

  const { constructor } = target;

  return {
    configurable,
    enumerable,

    get() {

      /**
       * ä½¿ç”¨è¿™ç§æ–¹å¼ç›¸å½“äºæ›¿æ¢äº†è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å½“æ¯”å¦‚
       * Class.prototype.hasOwnProperty(key) çš„æ—¶å€™ï¼Œä¸ºäº†æ­£ç¡®è¿”å›
       * æ‰€ä»¥è¿™é‡Œåšäº† this çš„åˆ¤æ–­
       */
      if (this === target) {
        return fn;
      }

      const boundFn = bind(fn, this);

      defineProperty(this, key, {
        configurable: true,
        writable: true,
        enumerable: false,
        value: boundFn
      });

      return boundFn;
    },
    set: createDefaultSetter(key)
  };
}
```

### 3. debounce

æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ‰§è¡Œçš„æ–¹æ³•è¿›è¡Œé˜²æŠ–å¤„ç†:

```js
class Toggle extends React.Component {

  @debounce(500, true)
  handleClick() {
    console.log('toggle')
  }

  render() {
    return (
      <button onClick={this.handleClick}>
        button
      </button>
    );
  }
}
```

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ï¼š

```js
function _debounce(func, wait, immediate) {

    var timeout;

    return function () {
        var context = this;
        var args = arguments;

        if (timeout) clearTimeout(timeout);
        if (immediate) {
            var callNow = !timeout;
            timeout = setTimeout(function(){
                timeout = null;
            }, wait)
            if (callNow) func.apply(context, args)
        }
        else {
            timeout = setTimeout(function(){
                func.apply(context, args)
            }, wait);
        }
    }
}

function debounce(wait, immediate) {
  return function handleDescriptor(target, key, descriptor) {
    const callback = descriptor.value;

    if (typeof callback !== 'function') {
      throw new SyntaxError('Only functions can be debounced');
    }

    var fn = _debounce(callback, wait, immediate)

    return {
      ...descriptor,
      value() {
        fn()
      }
    };
  }
}
```

### 4. time

ç”¨äºç»Ÿè®¡æ–¹æ³•æ‰§è¡Œçš„æ—¶é—´:

```js
function time(prefix) {
  let count = 0;
  return function handleDescriptor(target, key, descriptor) {

    const fn = descriptor.value;

    if (prefix == null) {
      prefix = `${target.constructor.name}.${key}`;
    }

    if (typeof fn !== 'function') {
      throw new SyntaxError(`@time can only be used on functions, not: ${fn}`);
    }

    return {
      ...descriptor,
      value() {
        const label = `${prefix}-${count}`;
        count++;
        console.time(label);

        try {
          return fn.apply(this, arguments);
        } finally {
          console.timeEnd(label);
        }
      }
    }
  }
}
```

### 5. mixin

ç”¨äºå°†å¯¹è±¡çš„æ–¹æ³•æ··å…¥ Class ä¸­ï¼š

```js
const SingerMixin = {
  sing(sound) {
    alert(sound);
  }
};

const FlyMixin = {
  // All types of property descriptors are supported
  get speed() {},
  fly() {},
  land() {}
};

@mixin(SingerMixin, FlyMixin)
class Bird {
  singMatingCall() {
    this.sing('tweet tweet');
  }
}

var bird = new Bird();
bird.singMatingCall();
// alerts "tweet tweet"
```

mixin çš„ä¸€ä¸ªç®€å•å®ç°å¦‚ä¸‹ï¼š

```js
function mixin(...mixins) {
  return target => {
    if (!mixins.length) {
      throw new SyntaxError(`@mixin() class ${target.name} requires at least one mixin as an argument`);
    }

    for (let i = 0, l = mixins.length; i < l; i++) {
      const descs = Object.getOwnPropertyDescriptors(mixins[i]);
      const keys = Object.getOwnPropertyNames(descs);

      for (let j = 0, k = keys.length; j < k; j++) {
        const key = keys[j];

        if (!target.prototype.hasOwnProperty(key)) {
          Object.defineProperty(target.prototype, key, descs[key]);
        }
      }
    }
  };
}
```

### 6. redux

å®é™…å¼€å‘ä¸­ï¼ŒReact ä¸ Redux åº“ç»“åˆä½¿ç”¨æ—¶ï¼Œå¸¸å¸¸éœ€è¦å†™æˆä¸‹é¢è¿™æ ·ã€‚

```js
class MyReactComponent extends React.Component {}

export default connect(mapStateToProps, mapDispatchToProps)(MyReactComponent);
```

æœ‰äº†è£…é¥°å™¨ï¼Œå°±å¯ä»¥æ”¹å†™ä¸Šé¢çš„ä»£ç ã€‚

```js
@connect(mapStateToProps, mapDispatchToProps)
export default class MyReactComponent extends React.Component {};
```

ç›¸å¯¹æ¥è¯´ï¼Œåä¸€ç§å†™æ³•çœ‹ä¸Šå»æ›´å®¹æ˜“ç†è§£ã€‚

### 7. æ³¨æ„

ä»¥ä¸Šæˆ‘ä»¬éƒ½æ˜¯ç”¨äºä¿®é¥°ç±»æ–¹æ³•ï¼Œæˆ‘ä»¬è·å–å€¼çš„æ–¹å¼ä¸ºï¼š

```js
const method = descriptor.value;
```

ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®é¥°çš„æ˜¯ç±»çš„å®ä¾‹å±æ€§ï¼Œå› ä¸º Babel çš„ç¼˜æ•…ï¼Œé€šè¿‡ value å±æ€§å¹¶ä¸èƒ½è·å–å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å†™æˆï¼š

```js
const value = descriptor.initializer && descriptor.initializer();
```

## ğŸŒŸ. å‚è€ƒ
- [ECMAScript 6 å…¥é—¨](http://es6.ruanyifeng.com/#docs/decorator)
- [core-decorators](https://github.com/jayphelps/core-decorators#mixin-alias-mixins)
- [ES7 Decorator è£…é¥°è€…æ¨¡å¼](http://taobaofed.org/blog/2015/11/16/es7-decorator/)
- [JS è£…é¥°å™¨ï¼ˆDecoratorï¼‰åœºæ™¯å®æˆ˜](https://juejin.im/post/59f1c484f265da431c6f8940#heading-2)
