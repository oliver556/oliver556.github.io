---
title: ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠ Async
date: 2021-11-28 18:02:51
permalink: /pages/0c736a/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹æˆ‘ä»¬æ¥èŠèŠ Async

## ä¸€. async

ES2017 æ ‡å‡†å¼•å…¥äº† `async` å‡½æ•°ï¼Œä½¿å¾—å¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚

åœ¨å¼‚æ­¥å¤„ç†ä¸Šï¼Œ`async` å‡½æ•°å°±æ˜¯ `Generator` å‡½æ•°çš„è¯­æ³•ç³–ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
// ä½¿ç”¨ generator
var fetch = require('node-fetch');
var co = require('co');

function* gen() {
    var r1 = yield fetch('https://api.github.com/users/github');
    var json1 = yield r1.json();
    console.log(json1.bio);
}

co(gen);
```

å½“ä½ ä½¿ç”¨ async æ—¶ï¼š

```js
// ä½¿ç”¨ async
var fetch = require('node-fetch');

var fetchData = async function () {
    var r1 = await fetch('https://api.github.com/users/github');
    var json1 = await r1.json();
    console.log(json1.bio);
};

fetchData();
```

å…¶å® `async` å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°† `Generator` å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚

```js
async function fn(args) {
  // ...
}

// ç­‰åŒäº

function fn(args) {
  return spawn(function* () {
    // ...
  });
}
```

`spawn` å‡½æ•°æŒ‡çš„æ˜¯è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œå°±æ¯”å¦‚è¯´ `co`ã€‚

å†åŠ ä¸Š async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸º `async` å‡½æ•°æ˜¯åŸºäº Promise å’Œ `Generator` çš„ä¸€å±‚å°è£…ã€‚

## äºŒ. async ä¸ Promise

ä¸¥è°¨çš„è¯´ï¼Œ`async` æ˜¯ä¸€ç§è¯­æ³•ï¼ŒPromise æ˜¯ä¸€ä¸ªå†…ç½®å¯¹è±¡ï¼Œä¸¤è€…å¹¶ä¸å…·å¤‡å¯æ¯”æ€§ï¼Œæ›´ä½•å†µ `async` å‡½æ•°ä¹Ÿè¿”å›ä¸€ä¸ª Promise å¯¹è±¡â€¦â€¦

è¿™é‡Œä¸»è¦æ˜¯å±•ç¤ºä¸€äº›åœºæ™¯ï¼Œä½¿ç”¨ `async` ä¼šæ¯”ä½¿ç”¨ Promise æ›´ä¼˜é›…çš„å¤„ç†å¼‚æ­¥æµç¨‹ã€‚

### 1. ä»£ç æ›´åŠ ç®€æ´

```js
/**
 * ç¤ºä¾‹ä¸€
 */
function fetch() {
  return (
    fetchData()
    .then(() => {
      return "done"
    });
  )
}

async function fetch() {
  await fetchData()
  return "done"
};
```

```js
/**
 * ç¤ºä¾‹äºŒ
 */
function fetch() {
  return fetchData()
  .then(data => {
    if (data.moreData) {
        return fetchAnotherData(data)
        .then(moreData => {
          return moreData
        })
    } else {
      return data
    }
  });
}

async function fetch() {
  const data = await fetchData()
  if (data.moreData) {
    const moreData = await fetchAnotherData(data);
    return moreData
  } else {
    return data
  }
};
```

```js
/**
 * ç¤ºä¾‹ä¸‰
 */
function fetch() {
  return (
    fetchData()
    .then(value1 => {
      return fetchMoreData(value1)
    })
    .then(value2 => {
      return fetchMoreData2(value2)
    })
  )
}

async function fetch() {
  const value1 = await fetchData()
  const value2 = await fetchMoreData(value1)
  return fetchMoreData2(value2)
};
```

### 2. é”™è¯¯å¤„ç†

```js
function fetch() {
  try {
    fetchData()
      .then(result => {
        const data = JSON.parse(result)
      })
      .catch((err) => {
        console.log(err)
      })
  } catch (err) {
    console.log(err)
  }
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ`try/catch` èƒ½æ•è· `fetchData()` ä¸­çš„ä¸€äº› Promise æ„é€ é”™è¯¯ï¼Œä½†æ˜¯ä¸èƒ½æ•è· `JSON.parse` æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦‚æœè¦å¤„ç† `JSON.parse` æŠ›å‡ºçš„å¼‚å¸¸ï¼Œéœ€è¦æ·»åŠ  `catch` å‡½æ•°é‡å¤ä¸€éå¼‚å¸¸å¤„ç†çš„é€»è¾‘ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé”™è¯¯å¤„ç†é€»è¾‘å¯èƒ½ä¼šå¾ˆå¤æ‚ï¼Œè¿™ä¼šå¯¼è‡´å†—ä½™çš„ä»£ç ã€‚

```js
async function fetch() {
  try {
    const data = JSON.parse(await fetchData())
  } catch (err) {
    console.log(err)
  }
};
```

`async/await` çš„å‡ºç°ä½¿å¾— `try/catch` å°±å¯ä»¥æ•è·åŒæ­¥å’Œå¼‚æ­¥çš„é”™è¯¯ã€‚

### 3. è°ƒè¯•

```js
const fetchData = () => new Promise((resolve) => setTimeout(resolve, 1000, 1))
const fetchMoreData = (value) => new Promise((resolve) => setTimeout(resolve, 1000, value + 1))
const fetchMoreData2 = (value) => new Promise((resolve) => setTimeout(resolve, 1000, value + 2))

function fetch() {
  return (
    fetchData()
    .then((value1) => {
      console.log(value1)
      return fetchMoreData(value1)
    })
    .then(value2 => {
      return fetchMoreData2(value2)
    })
  )
}

const res = fetch();
console.log(res);
```

![javascript_05-18_01](https://fastly.jsdelivr.net/gh/oliver556/image-hosting@master/20220518/javascript_05-18_01.2nnzpb2pixs0.gif)

å› ä¸º `then` ä¸­çš„ä»£ç æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥å½“ä½ æ‰“æ–­ç‚¹çš„æ—¶å€™ï¼Œä»£ç ä¸ä¼šé¡ºåºæ‰§è¡Œï¼Œå°¤å…¶å½“ä½ ä½¿ç”¨ `step over` çš„æ—¶å€™ï¼Œ`then` å‡½æ•°ä¼šç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ª `then` å‡½æ•°ã€‚

```js
const fetchData = () => new Promise((resolve) => setTimeout(resolve, 1000, 1))
const fetchMoreData = () => new Promise((resolve) => setTimeout(resolve, 1000, 2))
const fetchMoreData2 = () => new Promise((resolve) => setTimeout(resolve, 1000, 3))

async function fetch() {
  const value1 = await fetchData()
  const value2 = await fetchMoreData(value1)
  return fetchMoreData2(value2)
};

const res = fetch();
console.log(res);
```

![javascript_05-18_02](https://fastly.jsdelivr.net/gh/oliver556/image-hosting@master/20220518/javascript_05-18_02.uyq6jc816rk.gif)

è€Œä½¿ç”¨ async çš„æ—¶å€™ï¼Œåˆ™å¯ä»¥åƒè°ƒè¯•åŒæ­¥ä»£ç ä¸€æ ·è°ƒè¯•ã€‚

## ä¸‰. async åœ°ç‹±

async åœ°ç‹±ä¸»è¦æ˜¯æŒ‡å¼€å‘è€…è´ªå›¾è¯­æ³•ä¸Šçš„ç®€æ´è€Œè®©åŸæœ¬å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„å†…å®¹å˜æˆäº†é¡ºåºæ‰§è¡Œï¼Œä»è€Œå½±å“äº†æ€§èƒ½ï¼Œä½†ç”¨åœ°ç‹±å½¢å®¹æœ‰ç‚¹å¤¸å¼ äº†ç‚¹â€¦â€¦

### 1. ä¾‹å­ä¸€

ä¸¾ä¸ªä¾‹å­ï¼š

```js
(async () => {
  const getList = await getList();
  const getAnotherList = await getAnotherList();
})();
```

getList() å’Œ getAnotherList() å…¶å®å¹¶æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ç°åœ¨çš„è¿™ç§å†™æ³•ï¼Œè™½ç„¶ç®€æ´ï¼Œå´å¯¼è‡´äº† getAnotherList() åªèƒ½åœ¨ getList() è¿”å›åæ‰ä¼šæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´äº†å¤šä¸€å€çš„è¯·æ±‚æ—¶é—´ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æˆè¿™æ ·ï¼š

```js
(async () => {
  const listPromise = getList();
  const anotherListPromise = getAnotherList();
  await listPromise;
  await anotherListPromise;
})();
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ Promise.all()ï¼š

```js
(async () => {
  Promise.all([getList(), getAnotherList()]).then(...);
})();
```

### 2. ä¾‹å­äºŒ

å½“ç„¶ä¸Šé¢è¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å†æ¥æ‰©å……ä¸€ä¸‹ï¼š

```js
(async () => {
  const listPromise = await getList();
  const anotherListPromise = await getAnotherList();

  // do something

  await submit(listData);
  await submit(anotherListData);

})();
```

å› ä¸º `await` çš„ç‰¹æ€§ï¼Œæ•´ä¸ªä¾‹å­æœ‰æ˜æ˜¾çš„å…ˆåé¡ºåºï¼Œç„¶è€Œ getList() å’Œ getAnotherList() å…¶å®å¹¶æ— ä¾èµ–ï¼Œsubmit(listData) å’Œ submit(anotherListData) ä¹Ÿæ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆå¯¹äºè¿™ç§ä¾‹å­ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆæ”¹å†™å‘¢ï¼Ÿ

åŸºæœ¬åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

**1. æ‰¾å‡ºä¾èµ–å…³ç³»**

åœ¨è¿™é‡Œï¼Œsubmit(listData) éœ€è¦åœ¨ getList() ä¹‹åï¼Œsubmit(anotherListData) éœ€è¦åœ¨ anotherListPromise() ä¹‹åã€‚

**2. å°†äº’ç›¸ä¾èµ–çš„è¯­å¥åŒ…è£¹åœ¨ async å‡½æ•°ä¸­**

```js
async function handleList() {
  const listPromise = await getList();
  // ...
  await submit(listData);
}

async function handleAnotherList() {
  const anotherListPromise = await getAnotherList()
  // ...
  await submit(anotherListData)
}
```

**3.å¹¶å‘æ‰§è¡Œ async å‡½æ•°**

```js
async function handleList() {
  const listPromise = await getList();
  // ...
  await submit(listData);
}

async function handleAnotherList() {
  const anotherListPromise = await getAnotherList()
  // ...
  await submit(anotherListData)
}

// æ–¹æ³•ä¸€
(async () => {
  const handleListPromise = handleList()
  const handleAnotherListPromise = handleAnotherList()
  await handleListPromise
  await handleAnotherListPromise
})()

// æ–¹æ³•äºŒ
(async () => {
  Promise.all([handleList(), handleAnotherList()]).then()
})()
```

## å››. ç»§å‘ä¸å¹¶å‘

**é—®é¢˜ï¼šç»™å®šä¸€ä¸ª URL æ•°ç»„ï¼Œå¦‚ä½•å®ç°æ¥å£çš„ç»§å‘å’Œå¹¶å‘ï¼Ÿ**

async ç»§å‘å®ç°ï¼š

```js
// ç»§å‘ä¸€
async function loadData() {
  var res1 = await fetch(url1);
  var res2 = await fetch(url2);
  var res3 = await fetch(url3);
  return "whew all done";
}
```

```js
// ç»§å‘äºŒ
async function loadData(urls) {
  for (const url of urls) {
    const response = await fetch(url);
    console.log(await response.text());
  }
}
```

async å¹¶å‘å®ç°ï¼š

```js
// å¹¶å‘ä¸€
async function loadData() {
  var res = await Promise.all([fetch(url1), fetch(url2), fetch(url3)]);
  return "whew all done";
}
```

```js
// å¹¶å‘äºŒ
async function loadData(urls) {
  // å¹¶å‘è¯»å– url
  const textPromises = urls.map(async url => {
    const response = await fetch(url);
    return response.text();
  });

  // æŒ‰æ¬¡åºè¾“å‡º
  for (const textPromise of textPromises) {
    console.log(await textPromise);
  }
}
```

## äº”. async é”™è¯¯æ•è·

å°½ç®¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `try catch` æ•è·é”™è¯¯ï¼Œä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦æ•è·å¤šä¸ªé”™è¯¯å¹¶åšä¸åŒçš„å¤„ç†æ—¶ï¼Œå¾ˆå¿« `try catch` å°±ä¼šå¯¼è‡´ä»£ç æ‚ä¹±ï¼Œå°±æ¯”å¦‚ï¼š

```js
async function asyncTask(cb) {
    try {
       const user = await UserModel.findById(1);
       if(!user) return cb('No user found');
    } catch(e) {
        return cb('Unexpected error occurred');
    }

    try {
       const savedTask = await TaskModel({userId: user.id, name: 'Demo Task'});
    } catch(e) {
        return cb('Error occurred while saving task');
    }

    if(user.notificationsEnabled) {
        try {
            await NotificationService.sendNotification(user.id, 'Task Created');
        } catch(e) {
            return cb('Error while sending notification');
        }
    }

    if(savedTask.assignedUser.id !== user.id) {
        try {
            await NotificationService.sendNotification(savedTask.assignedUser.id, 'Task was created for you');
        } catch(e) {
            return cb('Error while sending notification');
        }
    }

    cb(null, savedTask);
}
```

ä¸ºäº†ç®€åŒ–è¿™ç§é”™è¯¯çš„æ•è·ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ `await` åçš„ promise å¯¹è±¡æ·»åŠ  `catch` å‡½æ•°ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ª `helper`:

```js
// to.js
export default function to(promise) {
   return promise.then(data => {
      return [null, data];
   })
   .catch(err => [err]);
}
```

æ•´ä¸ªé”™è¯¯æ•è·çš„ä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š

```js
import to from './to.js';

async function asyncTask() {
     let err, user, savedTask;

     [err, user] = await to(UserModel.findById(1));
     if(!user) throw new CustomerError('No user found');

     [err, savedTask] = await to(TaskModel({userId: user.id, name: 'Demo Task'}));
     if(err) throw new CustomError('Error occurred while saving task');

    if(user.notificationsEnabled) {
       const [err] = await to(NotificationService.sendNotification(user.id, 'Task Created'));
       if (err) console.error('Just log the error and continue flow');
    }
}
```

## å…­. async çš„ä¸€äº›è®¨è®º

### 1. async ä¼šå–ä»£ Generator å—ï¼Ÿ

Generator æœ¬æ¥æ˜¯ç”¨ä½œç”Ÿæˆå™¨ï¼Œä½¿ç”¨ Generator å¤„ç†å¼‚æ­¥è¯·æ±‚åªæ˜¯ä¸€ä¸ªæ¯”è¾ƒ `hack` çš„ç”¨æ³•ï¼Œåœ¨å¼‚æ­¥æ–¹é¢ï¼Œ`async` å¯ä»¥å–ä»£ Generatorï¼Œä½†æ˜¯ `async` å’Œ Generator ä¸¤ä¸ªè¯­æ³•æœ¬èº«æ˜¯ç”¨æ¥è§£å†³ä¸åŒçš„é—®é¢˜çš„ã€‚

### 2. async ä¼šå–ä»£ Promise å—ï¼Ÿ

1. async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡
2. é¢å¯¹å¤æ‚çš„å¼‚æ­¥æµç¨‹ï¼ŒPromise æä¾›çš„ all å’Œ race ä¼šæ›´åŠ å¥½ç”¨
3. Promise æœ¬èº«æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»£ç ä¸­ä»»æ„ä¼ é€’
4. async çš„æ”¯æŒç‡è¿˜å¾ˆä½ï¼Œå³ä½¿æœ‰ Babelï¼Œç¼–è¯‘åä¹Ÿè¦å¢åŠ  1000 è¡Œå·¦å³ã€‚

## ğŸŒŸ. å‚è€ƒ
- [[è¯‘] 6 ä¸ª Async/Await ä¼˜äº Promise çš„æ–¹é¢](https://zhuanlan.zhihu.com/p/26260061)
- [[è¯‘] å¦‚ä½•é€ƒç¦» async/await åœ°ç‹±](https://juejin.im/post/5aefbb48f265da0b9b073c40)
- [ç²¾è¯»ã€Šasync/await æ˜¯æŠŠåŒåˆƒå‰‘ã€‹](https://segmentfault.com/a/1190000014753495)
- [ECMAScript 6 å…¥é—¨](http://es6.ruanyifeng.com/#docs/async)
- [How to write async await without try-catch blocks in Javascript](https://blog.grossman.io/how-to-write-async-await-without-try-catch-blocks-in-javascript/)
