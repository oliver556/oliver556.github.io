---
title: ES6 ç³»åˆ—ä¹‹ Babel å°† Async ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­
date: 2021-12-01 16:40:31
permalink: /pages/849e7c/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - ES6ç³»åˆ—
---

# ES6 ç³»åˆ—ä¹‹ Babel å°† Async ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­

## ğŸ“–. å‰è¨€

æœ¬æ–‡å°±æ˜¯ç®€å•ä»‹ç»ä¸‹ Async è¯­æ³•ç¼–è¯‘åçš„ä»£ç ã€‚

## ä¸€. Async

```js
const fetchData = (data) => new Promise((resolve) => setTimeout(resolve, 1000, data + 1))

const fetchValue = async function () {
    var value1 = await fetchData(1);
    var value2 = await fetchData(value1);
    var value3 = await fetchData(value2);
    console.log(value3)
};

fetchValue();
// å¤§çº¦ 3s åè¾“å‡º 4
```

## äºŒ. Babel

æˆ‘ä»¬ç›´æ¥åœ¨ Babel å®˜ç½‘çš„ [Try it out](https://babeljs.io/repl) ç²˜è´´ä¸Šè¿°ä»£ç ï¼Œç„¶åæŸ¥çœ‹ä»£ç ç¼–è¯‘æˆä»€ä¹ˆæ ·å­ï¼š

```js
"use strict";

function _asyncToGenerator(fn) {
  return function() {
    var gen = fn.apply(this, arguments);
    return new Promise(function(resolve, reject) {
      function step(key, arg) {
        try {
          var info = gen[key](arg);
          var value = info.value;
        } catch (error) {
          reject(error);
          return;
        }
        if (info.done) {
          resolve(value);
        } else {
          return Promise.resolve(value).then(
            function(value) {
              step("next", value);
            },
            function(err) {
              step("throw", err);
            }
          );
        }
      }
      return step("next");
    });
  };
}

var fetchData = function fetchData(data) {
  return new Promise(function(resolve) {
    return setTimeout(resolve, 1000, data + 1);
  });
};

var fetchValue = (function() {
  var _ref = _asyncToGenerator(
    /*#__PURE__*/ regeneratorRuntime.mark(function _callee() {
      var value1, value2, value3;
      return regeneratorRuntime.wrap(
        function _callee$(_context) {
          while (1) {
            switch ((_context.prev = _context.next)) {
              case 0:
                _context.next = 2;
                return fetchData(1);

              case 2:
                value1 = _context.sent;
                _context.next = 5;
                return fetchData(value1);

              case 5:
                value2 = _context.sent;
                _context.next = 8;
                return fetchData(value2);

              case 8:
                value3 = _context.sent;

                console.log(value3);

              case 10:
              case "end":
                return _context.stop();
            }
          }
        },
        _callee,
        this
      );
    })
  );

  return function fetchValue() {
    return _ref.apply(this, arguments);
  };
})();

fetchValue();
```

## ä¸‰. _asyncToGenerator

regeneratorRuntime ç›¸å…³çš„ä»£ç æˆ‘ä»¬åœ¨ [ã€ŠES6 ç³»åˆ—ä¹‹ Babel å°† Generator ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­ã€‹](12.ES6ç³»åˆ—ä¹‹Babelå°†Generatorç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·å­.md) ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™æ¬¡æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹ _asyncToGenerator å‡½æ•°ï¼š

```js
function _asyncToGenerator(fn) {
  return function() {
    var gen = fn.apply(this, arguments);
    return new Promise(function(resolve, reject) {
      function step(key, arg) {
        try {
          var info = gen[key](arg);
          var value = info.value;
        } catch (error) {
          reject(error);
          return;
        }
        if (info.done) {
          resolve(value);
        } else {
          return Promise.resolve(value).then(
            function(value) {
              step("next", value);
            },
            function(err) {
              step("throw", err);
            }
          );
        }
      }
      return step("next");
    });
  };
}
```

ä»¥ä¸Šè¿™æ®µä»£ç ä¸»è¦æ˜¯ç”¨æ¥å®ç° generator çš„è‡ªåŠ¨æ‰§è¡Œä»¥åŠè¿”å› Promiseã€‚

å½“æˆ‘ä»¬æ‰§è¡Œ `fetchValue()` çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å…¶å®å°±æ˜¯ _`asyncToGenerator` è¿”å›çš„è¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œåœ¨åŒ¿åå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†

```js
var gen = fn.apply(this, arguments);
```

è¿™ä¸€æ­¥å°±ç›¸å½“äºæ‰§è¡Œ Generator å‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
function* helloWorldGenerator() {
  yield 'hello';
  yield 'world';
  return 'ending';
}

var hw = helloWorldGenerator();
```

`var gen = fn.apply(this, arguments)` å°±ç›¸å½“äº `var hw = helloWorldGenerator();`ï¼Œè¿”å›çš„ gen æ˜¯ä¸€ä¸ªå…·æœ‰ `next()`ã€`throw()`ã€`return()` æ–¹æ³•çš„å¯¹è±¡ã€‚

ç„¶åæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ª Promise å¯¹è±¡ï¼Œåœ¨ Promise ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œäº† step("next")ï¼Œstep å‡½æ•°ä¸­ä¼šæ‰§è¡Œï¼š

```js
try {
  var info = gen[key](arg);
  var value = info.value;
} catch (error) {
  reject(error);
  return;
}
```

step("next") å°±ç›¸å½“äº `var info = gen.next()`ï¼Œè¿”å›çš„ info å¯¹è±¡æ˜¯ä¸€ä¸ªå…·æœ‰ value å’Œ done å±æ€§çš„å¯¹è±¡ï¼š

```
{ value: Promise, done: false }
```

æ¥ä¸‹æ¥åˆä¼šæ‰§è¡Œï¼š

```js
if (info.done) {
  resolve(value);
} else {
  return Promise.resolve(value).then(
    function(value) {
      step("next", value);
    },
    function(err) {
      step("throw", err);
    }
  );
}
```

value æ­¤æ—¶æ˜¯ä¸€ä¸ª Promiseï¼ŒPromise.resolve(value) ä¾ç„¶ä¼šè¿”å›è¿™ä¸ª Promiseï¼Œæˆ‘ä»¬ç»™è¿™ä¸ª Promise æ·»åŠ äº†ä¸€ä¸ª then å‡½æ•°ï¼Œç”¨äºåœ¨ Promise æœ‰ç»“æœæ—¶æ‰§è¡Œï¼Œæœ‰ç»“æœæ—¶åˆä¼šæ‰§è¡Œ `step("next", value)`ï¼Œ
ä»è€Œä½¿å¾— Generator ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ° `info.done` ä¸º trueï¼Œæ‰ä¼š `resolve(value)`ã€‚

## å››. ä¸å®Œæ•´ä½†å¯ç”¨çš„ä»£ç 

```js
(function() {
    var ContinueSentinel = {};

    var mark = function(genFun) {
        var generator = Object.create({
            next: function(arg) {
                return this._invoke("next", arg);
            }
        });
        genFun.prototype = generator;
        return genFun;
    };

    function wrap(innerFn, outerFn, self) {
        var generator = Object.create(outerFn.prototype);

        var context = {
            done: false,
            method: "next",
            next: 0,
            prev: 0,
            sent: undefined,
            abrupt: function(type, arg) {
                var record = {};
                record.type = type;
                record.arg = arg;

                return this.complete(record);
            },
            complete: function(record, afterLoc) {
                if (record.type === "return") {
                    this.rval = this.arg = record.arg;
                    this.method = "return";
                    this.next = "end";
                }

                return ContinueSentinel;
            },
            stop: function() {
                this.done = true;
                return this.rval;
            }
        };

        generator._invoke = makeInvokeMethod(innerFn, context);

        return generator;
    }

    function makeInvokeMethod(innerFn, context) {
        var state = "start";

        return function invoke(method, arg) {
            if (state === "completed") {
                return { value: undefined, done: true };
            }

            context.method = method;
            context.arg = arg;

            while (true) {
                state = "executing";

                if (context.method === "next") {
                    context.sent = context._sent = context.arg;
                }

                var record = {
                    type: "normal",
                    arg: innerFn.call(self, context)
                };

                if (record.type === "normal") {
                    state = context.done ? "completed" : "yield";

                    if (record.arg === ContinueSentinel) {
                        continue;
                    }

                    return {
                        value: record.arg,
                        done: context.done
                    };
                }
            }
        };
    }

    window.regeneratorRuntime = {};

    regeneratorRuntime.wrap = wrap;
    regeneratorRuntime.mark = mark;
})();

"use strict";

function _asyncToGenerator(fn) {
    return function() {
        var gen = fn.apply(this, arguments);
        return new Promise(function(resolve, reject) {
            function step(key, arg) {
                try {
                    var info = gen[key](arg);
                    var value = info.value;
                } catch (error) {
                    reject(error);
                    return;
                }
                if (info.done) {
                    resolve(value);
                } else {
                    return Promise.resolve(value).then(
                        function(value) {
                            step("next", value);
                        },
                        function(err) {
                            step("throw", err);
                        }
                    );
                }
            }
            return step("next");
        });
    };
}

var fetchData = function fetchData(data) {
    return new Promise(function(resolve) {
        return setTimeout(resolve, 1000, data + 1);
    });
};

var fetchValue = (function() {
    var _ref = _asyncToGenerator(
        /*#__PURE__*/
        regeneratorRuntime.mark(function _callee() {
            var value1, value2, value3;
            return regeneratorRuntime.wrap(
                function _callee$(_context) {
                    while (1) {
                        switch ((_context.prev = _context.next)) {
                            case 0:
                                _context.next = 2;
                                return fetchData(1);

                            case 2:
                                value1 = _context.sent;
                                _context.next = 5;
                                return fetchData(value1);

                            case 5:
                                value2 = _context.sent;
                                _context.next = 8;
                                return fetchData(value2);

                            case 8:
                                value3 = _context.sent;

                                console.log(value3);

                            case 10:
                            case "end":
                                return _context.stop();
                        }
                    }
                },
                _callee,
                this
            );
        })
    );

    return function fetchValue() {
        return _ref.apply(this, arguments);
    };
})();

fetchValue();
```
