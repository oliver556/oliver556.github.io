---
title: underscore ç³»åˆ—ä¹‹å†…éƒ¨å‡½æ•° cb å’Œ optimizeCb
date: 2021-11-11 13:20:17
permalink: /pages/ccc62b/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - underscoreç³»åˆ—
author:
  name: Jamison
  link: https://github.com/oliver556
---

# underscore ç³»åˆ—ä¹‹å†…éƒ¨å‡½æ•° cb å’Œ optimizeCb

## ğŸ“–. å‰è¨€

ä»…çœ‹ cb å’Œ optimizeCb ä¸¤ä¸ªå‡½æ•°çš„åå­—ï¼Œä½ å¯èƒ½æƒ³ä¸åˆ°è¿™æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Œå°½ç®¡ä½ å¯èƒ½æƒ³åˆ° cb æ˜¯ callback çš„ç¼©å†™ã€‚

å¦‚æœç›´æ¥è®²è§£æºç ï¼Œä½ å¯èƒ½æƒ³ä¸æ˜ç™½ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä» _.map å‡½æ•°å¼€å§‹è®²èµ·ã€‚

## ä¸€. _.map

_.map ç±»ä¼¼äº `Array.prototype.map`ï¼Œä½†æ›´åŠ å¥å£®å’Œå®Œå–„ã€‚æˆ‘ä»¬çœ‹ä¸‹ _.map çš„æºç ï¼š

```js
// ç®€åŒ–è¿‡ï¼Œè¿™é‡Œä»…å‡è®¾ obj æ˜¯æ•°ç»„
_.map = function (obj, iteratee, context) {
  iteratee = cb(iteratee, context);
  
  var length = obj.length, results = Array(length);
  for (var index = 0; index < length; index++) {
    results[index] = iteratee(obj[index], index, obj);
  }
  
  return results;
};
```

map æ–¹æ³•é™¤äº†ä¼ å…¥è¦å¤„ç†çš„æ•°ç»„ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªå‚æ•° iteratee å’Œ contextï¼Œç±»ä¼¼äº `Array.prototype.map` ä¸­çš„å…¶ä»–ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ iteratee è¡¨ç¤ºå¤„ç†å‡½æ•°ï¼Œcontext è¡¨ç¤ºæŒ‡å®šçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå³ this çš„å€¼ã€‚

ç„¶ååœ¨æºç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬å°† iteratee å’Œ context ä¼ å…¥ä¸€ä¸ª cb å‡½æ•°ï¼Œç„¶åè¦†ç›–æ‰ iteratee å‡½æ•°ï¼Œç„¶åå°†è¿™ä¸ªå‡½æ•°ç”¨ä½œæœ€ç»ˆçš„å¤„ç†å‡½æ•°ã€‚

å®é™…ä¸Šï¼Œéœ€è¦è¿™ä¹ˆéº»çƒ¦å—ï¼Ÿä¸å°±æ˜¯ä½¿ç”¨ iteratee å‡½æ•°å¤„ç†æ¯æ¬¡è¿­ä»£çš„å€¼å—ï¼Ÿä¸å°±æ˜¯é€šè¿‡ context æŒ‡å®š this çš„å€¼å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿™æ ·å†™å‘ï¼š

```js
_.map = function (obj, iteratee, context) {
  var length = obj.length, results = Array(length);
  for (var index = 0; index < length; index++) {
    results[index] = iteratee.call(context, obj[index], index, obj);
  }
  return results;
};

// [2, 3, 4]
console.log(_.map([1, 2, 3], function(item){
  return item + 1;
})) 

// [2, 3, 4]
console.log(_.map([1, 2, 3], function(item){
  return item + this.value;
}, {value: 1})) 
```

ä½ çœ‹çœ‹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜å‘ï¼Œå¯æ˜¯ï¼Œä¸‡ä¸€ iteratee æˆ‘ä»¬ä¸ä¼ å…¥ä¸€ä¸ªå‡½æ•°å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬ä»€ä¹ˆä¹Ÿä¸ä¼ ï¼Œæˆ–è€…ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œåˆæˆ–è€…ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ã€æ•°å­—å‘¢ï¼Ÿ

å¦‚æœç”¨æˆ‘ä»¬çš„æ–¹æ³•è‡ªç„¶æ˜¯ä¼šæŠ¥é”™çš„ï¼Œé‚£ underscore å‘¢ï¼Ÿ

```js
// ä½¿ç”¨ underscore

// ä»€ä¹ˆä¹Ÿä¸ä¼ 
var result = _.map([1,2,3]); // [1, 2, 3]

// ä¼ å…¥ä¸€ä¸ªå¯¹è±¡
var result = _.map([{name:'Kevin'}, {name: 'Daisy', age: 18}], {name: 'Daisy'}); // [false, true]

var result = _.map([{name: 'Kevin'}, {name: 'Daisy'}], 'name'); // ['Kevin', 'daisy']
```

æˆ‘ä»¬ä¼šå‘ç°ï¼Œunderscore ç«Ÿç„¶è¿˜èƒ½æ ¹æ®ä¼ å…¥çš„å€¼çš„ç±»å‹ä¸åŒï¼Œå®ç°çš„æ•ˆæœä¸åŒã€‚æˆ‘ä»¬æ€»ç»“ä¸‹ï¼š

1. å½“ iteratee ä¸ä¼ æ—¶ï¼Œè¿”å›ä¸€ä¸ªç›¸åŒçš„æ•°ç»„ã€‚
2. å½“ iteratee ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæ­£å¸¸å¤„ç†ã€‚
3. å½“ iteratee ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›å…ƒç´ æ˜¯å¦åŒ¹é…æŒ‡å®šçš„å¯¹è±¡ã€‚
4. å½“ iteratee ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›å…ƒç´ å¯¹åº”çš„å±æ€§å€¼çš„é›†åˆã€‚

ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹åœ¨ underscore çš„ cb å‡½æ•°ä¸­ï¼Œæœ‰å¯¹ iteratee å€¼ç±»å‹çš„åˆ¤æ–­ï¼Œç„¶åæ ¹æ®ä¸åŒçš„ç±»å‹ï¼Œè¿”å›ä¸åŒçš„ iteratee å‡½æ•°ã€‚

## äºŒ. cb

æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹ cb å‡½æ•°çš„æºç ï¼š

```js
var cb = function(value, context, argCount) {
    
  if (_.iteratee !== builtinIteratee) return _.iteratee(value, context);

  if (value == null) return _.identity;

  if (_.isFunction(value)) return optimizeCb(value, context, argCount);

  if (_.isObject(value) && !_.isArray(value)) return _.matcher(value);

  return _.property(value);
};
```

è¿™ä¸€çœ‹å°±ç‰µæ‰¯åˆ°äº† 8 ä¸ªå‡½æ•°ï¼ä¸è¦å®³æ€•ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹ã€‚

## ä¸‰. _.iteratee

```js
if (_.iteratee !== builtinIteratee) return _.iteratee(value, context);
```

æˆ‘ä»¬çœ‹çœ‹ _.iteratee çš„æºç ï¼š

```js
_.iteratee = builtinIteratee = function(value, context) {
  return cb(value, context, Infinity);
};
```

å› ä¸º `_.iteratee = builtinIteratee` çš„ç¼˜æ•…ï¼Œ`_.iteratee !== builtinIteratee` å€¼ä¸º falseï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ `_.iteratee(value, context)` å¹¶ä¸ä¼šæ‰§è¡Œã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨å¤–éƒ¨ä¿®æ”¹äº† _.iteratee å‡½æ•°ï¼Œç»“æœä¾¿ä¼šä¸º trueï¼Œcb å‡½æ•°ç›´æ¥è¿”å› `_.iteratee(value, context)`ã€‚

è¿™ä¸ªæ„æ€å…¶å®æ˜¯è¯´ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ _.iteratee å‡½æ•°æ¥å¤„ç† value å’Œ contextã€‚

è¯•æƒ³æˆ‘ä»¬å¹¶ä¸éœ€è¦ç°åœ¨ _.map è¿™ä¹ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œæˆ‘åªå¸Œæœ›å½“ value æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±ç”¨è¯¥å‡½æ•°å¤„ç†æ•°ç»„å…ƒç´ ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°ï¼Œå°±ç›´æ¥è¿”å›å½“å‰å…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä¿®æ”¹ï¼š

```html
<html>
  <head>
    <title>underscore map</title>
  </head>
<body>
  <script src="../vender/underscore.js"></script>
  <script type="text/javascript">
    _.iteratee = function(value, context) {
      if (typeof value === 'function') {
        return function(...rest) {
          return value.call(context, ...rest)
        };
      }
      return function(value) {
        return value;
      };
    };

    // å¦‚æœ map çš„ç¬¬äºŒä¸ªå‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå°±è¿”å›è¯¥å…ƒç´ 
    console.log(_.map([1, 2, 3], 'name')); // [1, 2, 3]

    // å¦‚æœ map çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°ï¼Œå°±ä½¿ç”¨è¯¥å‡½æ•°å¤„ç†æ•°ç»„å…ƒç´ 
    var result = _.map([1, 2, 3], function(item) {
      return item + 1;
    });

    console.log(result); // [2, 3, 4]
    </script>
</body>
</html>
```

å½“ç„¶æ›´å¤šçš„æƒ…å†µæ˜¯è‡ªå®šä¹‰å¯¹ä¸åŒçš„ value ä½¿ç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œunderscore ä¸­çš„å¤šä¸ªå‡½æ•°éƒ½æ˜¯ç”¨äº† cb å‡½æ•°ï¼Œè€Œå› ä¸º cb å‡½æ•°ä½¿ç”¨äº† _.iteratee å‡½æ•°ï¼Œå¦‚æœä½ ä¿®æ”¹è¿™ä¸ªå‡½æ•°ï¼Œå…¶å®ä¼šå½±å“å¤šä¸ªå‡½æ•°ï¼Œ
è¿™äº›å‡½æ•°åŸºæœ¬éƒ½å±äºé›†åˆå‡½æ•°ï¼Œå…·ä½“åŒ…æ‹¬ mapã€findã€filterã€rejectã€everyã€someã€maxã€minã€sortByã€groupByã€indexByã€countByã€sortedIndexã€partitionã€å’Œ uniqueã€‚

## å››. _.identity

```js
if (value == null) return _.identity;
```

è®©æˆ‘ä»¬çœ‹çœ‹ _.identity çš„æºç ï¼š

```js
_.identity = function(value) {
  return value;
};
```

è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå½“ map çš„ç¬¬äºŒä¸ªå‚æ•°ä»€ä¹ˆéƒ½ä¸ä¼ çš„æ—¶å€™ï¼Œç»“æœä¼šæ˜¯ä¸€ä¸ªç›¸åŒæ•°ç»„çš„åŸå› ã€‚

```js
_.map([1,2,3]); // [1, 2, 3]
```

å¦‚æœç›´æ¥çœ‹è¿™ä¸ªå‡½æ•°ï¼Œå¯èƒ½è§‰å¾—æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä½†ç”¨åœ¨è¿™é‡Œï¼Œå´åˆååˆ†çš„åˆé€‚ã€‚

## äº”. optimizeCb

```js
if (_.isFunction(value)) return optimizeCb(value, context, argCount);
```

å½“ value æ˜¯ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¼ å…¥ optimizeCb å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ optimizeCb å‡½æ•°ï¼š

```js
var optimizeCb = function(func, context, argCount) {
  // å¦‚æœæ²¡æœ‰ä¼ å…¥ contextï¼Œå°±è¿”å› func å‡½æ•°
  if (context === void 0) return func;
  switch (argCount) {
    case 1:
      return function(value) {
        return func.call(context, value);
      };
    case null:
    case 3:
      return function(value, index, collection) {
        return func.call(context, value, index, collection);
      };
    case 4:
      return function(accumulator, value, index, collection) {
        return func.call(context, accumulator, value, index, collection);
      };
  }
  return function() {
    return func.apply(context, arguments);
  };
};
```

ä¹Ÿè®¸ä½ ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆæˆ‘è¦å¯¹ argCount è¿›è¡Œåˆ¤æ–­å‘¢ï¼Ÿå°±ä¸èƒ½ç›´æ¥è¿”å›å—ï¼Ÿæ¯”å¦‚è¿™æ ·ï¼š

```js
var optimizeCb = function(func, context) {
  // å¦‚æœæ²¡æœ‰ä¼ å…¥ contextï¼Œå°±è¿”å› func å‡½æ•°
  if (context === void 0) return func;
  return function() {
    return func.apply(context, arguments);
  };
};
```

å½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†ä¸ºä»€ä¹ˆ underscore è¦è¿™æ ·åšå‘¢ï¼Ÿå…¶å®å°±æ˜¯ä¸ºäº†é¿å…ä½¿ç”¨ argumentsï¼Œæé«˜ä¸€ç‚¹æ€§èƒ½è€Œå·²ï¼Œå¦‚æœä¸æ˜¯å†™ä¸€ä¸ªåº“ï¼Œå…¶å®è¿˜çœŸæ˜¯æ²¡æœ‰å¿…è¦åšåˆ°è¿™ç‚¹ã€‚

è€Œä¸ºä»€ä¹ˆå½“å‚æ•°æ˜¯ 3 ä¸ªæ—¶å€™ï¼Œå‚æ•°åç§°åˆ†åˆ«æ˜¯ value, index, collection ï¼Œåˆä¸ºä»€ä¹ˆæ²¡æœ‰å‚æ•°ä¸º 2 çš„æƒ…å†µå‘¢ï¼Ÿå…¶å®è¿™éƒ½æ˜¯æ ¹æ® underscore å‡½æ•°ç”¨åˆ°çš„æƒ…å†µï¼Œæ²¡æœ‰å‡½æ•°ç”¨åˆ°ä¸¤ä¸ªå‚æ•°ï¼Œäºæ˜¯å°±çœç•¥äº†ï¼Œ
åƒ map å‡½æ•°å°±ä¼šç”¨åˆ° 3 ä¸ªå‚æ•°ï¼Œå°±æ ¹æ®è¿™ä¸‰ä¸ªå‚æ•°çš„åå­—èµ·äº†è¿™é‡Œçš„å˜é‡åå•¦ã€‚

## å…­. _.matcher

```js
if (_.isObject(value) && !_.isArray(value)) return _.matcher(value);
```

è¿™æ®µå°±æ˜¯ç”¨æ¥å¤„ç†å½“ map çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯¹è±¡çš„æƒ…å†µï¼š

```js
// ä¼ å…¥ä¸€ä¸ªå¯¹è±¡
var result = _.map([{name:'Kevin'}, {name: 'Daisy', age: 18}], {name: 'Daisy'}); // [false, true]
```

å¦‚æœ value æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ä¸æ˜¯æ•°ç»„ï¼Œå°±ä½¿ç”¨ _.matcher å‡½æ•°ã€‚çœ‹çœ‹å„ä¸ªå‡½æ•°çš„æºç ï¼š

```js
var nativeIsArray = Array.isArray;

_.isArray = nativeIsArray || function(obj) {
  return Object.prototype.toString.call(obj) === '[object Array]';
};

_.isObject = function(obj) {
  var type = typeof obj;
  return type === 'function' || type === 'object' && !!obj;
};


// extend å‡½æ•°å¯ä»¥å‚è€ƒ ã€ŠJavaScript ä¸“é¢˜ä¹‹æ‰‹å†™ä¸€ä¸ª jQuery çš„ extendã€‹
_.matcher = function(attrs) {
  attrs = _.extend({}, attrs);
  return function(obj) {
    return _.isMatch(obj, attrs);
  };
};

// è¯¥å‡½æ•°åˆ¤æ–­ attr å¯¹è±¡ä¸­çš„é”®å€¼æ˜¯å¦åœ¨ object ä¸­æœ‰å¹¶ä¸”ç›¸ç­‰

// var stooge = {name: 'moe', age: 32};
// _.isMatch(stooge, {age: 32}); => true

// å…¶ä¸­ _.keys ç›¸å½“äº Object.keys
_.isMatch = function(object, attrs) {
  var keys = _.keys(attrs), length = keys.length;
  if (object == null) return !length;
  var obj = Object(object);
  for (var i = 0; i < length; i++) {
    var key = keys[i];
    if (attrs[key] !== obj[key] || !(key in obj)) return false;
  }
  return true;
};
```

## ä¸ƒ. _.property

```js
return _.property(value);
```

è¿™ä¸ªå°±æ˜¯å¤„ç†å½“ value æ˜¯åŸºæœ¬ç±»å‹çš„å€¼çš„æ—¶å€™ï¼Œè¿”å›å…ƒç´ å¯¹åº”çš„å±æ€§å€¼çš„æƒ…å†µï¼š

```js
var result = _.map([{name: 'Kevin'}, {name: 'Daisy'}], 'name'); // ['Kevin', 'daisy']
```

æˆ‘ä»¬çœ‹ä¸‹æºç ï¼š

```js
_.property = function(path) {
  // å¦‚æœä¸æ˜¯æ•°ç»„
  if (!_.isArray(path)) {
    return shallowProperty(path);
  }
  return function(obj) {
    return deepGet(obj, path);
  };
};

var shallowProperty = function(key) {
  return function(obj) {
    return obj == null ? void 0 : obj[key];
  };
};

// æ ¹æ®è·¯å¾„å–å‡ºæ·±å±‚æ¬¡çš„å€¼
var deepGet = function(obj, path) {
  var length = path.length;
  for (var i = 0; i < length; i++) {
    if (obj == null) return void 0;
    obj = obj[path[i]];
  }
  return length ? obj : void 0;
};
```

æˆ‘ä»¬å¥½åƒå‘ç°äº†æ–°å¤§é™†ï¼ŒåŸæ¥ value è¿˜å¯ä»¥ä¼ ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥å–æ·±å±‚æ¬¡çš„å€¼ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
var person1 = {
  child: {
    nickName: 'Kevin'
  }
}

var person2 = {
  child: {
    nickName: 'Daisy'
  }
}

var result = _.map([person1, person2], ['child', 'nickName']); 
console.log(result); // ['Kevin', 'daisy']
```

## å…«. æœ€å

å¦‚æœä½ æƒ³å­¦ä¹  underscore çš„æºç ï¼Œåœ¨åˆ†æé›†åˆç›¸å…³çš„å‡½æ•°æ—¶ä¸€å®šä¼šæ¥è§¦ cb å’Œ optimizeCb å‡½æ•°ï¼Œå…ˆæŒæ¡è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¼šå¸®åŠ©ä½ æ›´å¥½æ›´å¿«çš„è§£è¯»æºç ã€‚
