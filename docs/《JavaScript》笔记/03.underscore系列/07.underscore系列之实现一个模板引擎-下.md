---
title: underscore ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“(ä¸‹)
date: 2021-11-15 11:39:53
permalink: /pages/1f30c5/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - JavaScript underscore
---

# underscore ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“(ä¸‹)

## ğŸ“–. å‰è¨€

æœ¬ç¯‡æ¥ç€ä¸Šç¯‡ [ã€Šunderscore ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“(ä¸Š)ã€‹](06.underscoreç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“-ä¸Š.md)

é‰´äºæœ¬ç¯‡æ¶‰åŠçš„çŸ¥è¯†ç‚¹å¤ªå¤šï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸‹ä¼šç”¨åˆ°çš„çŸ¥è¯†ç‚¹ã€‚

## ä¸€. åæ–œæ çš„ä½œç”¨

```js
var txt = "We are the so-called "Vikings" from the north.";
console.log(txt);
```

æˆ‘ä»¬çš„æœ¬æ„æ˜¯æƒ³æ‰“å°å¸¦ `""` åŒ…è£¹çš„ `Vikings` å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åœ¨ JavaScript ä¸­ï¼Œå­—ç¬¦ä¸²ä½¿ç”¨å•å¼•å·æˆ–è€…åŒå¼•å·æ¥è¡¨ç¤ºèµ·å§‹æˆ–è€…ç»“æŸï¼Œè¿™æ®µä»£ç ä¼šæŠ¥ `Unexpected identifier` é”™è¯¯ã€‚

å¦‚æœæˆ‘ä»¬å°±æ˜¯æƒ³è¦åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨å•å¼•å·æˆ–è€…åŒå¼•å·å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åæ–œæ ç”¨æ¥åœ¨æ–‡æœ¬å­—ç¬¦ä¸²ä¸­æ’å…¥çœç•¥å·ã€æ¢è¡Œç¬¦ã€å¼•å·å’Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼š

```js
var txt = "We are the so-called \"Vikings\" from the north.";
console.log(txt);
```

ç°åœ¨ JavaScript å°±å¯ä»¥è¾“å‡ºæ­£ç¡®çš„æ–‡æœ¬å­—ç¬¦ä¸²äº†ã€‚

**è¿™ç§ç”±åæ–œæ åæ¥å­—æ¯æˆ–æ•°å­—ç»„åˆæ„æˆçš„å­—ç¬¦ç»„åˆå°±å«åšâ€œè½¬ä¹‰åºåˆ—â€ã€‚**

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè½¬ä¹‰åºåˆ—ä¼šè¢«è§†ä¸ºå•ä¸ªå­—ç¬¦ã€‚

æˆ‘ä»¬å¸¸è§çš„è½¬ä¹‰åºåˆ—è¿˜æœ‰ `\n` è¡¨ç¤ºæ¢è¡Œã€`\t` è¡¨ç¤ºåˆ¶è¡¨ç¬¦ã€`\r` è¡¨ç¤ºå›è½¦ç­‰ç­‰ã€‚

## äºŒ. è½¬ä¹‰åºåˆ—

åœ¨ JavaScript ä¸­ï¼Œå­—ç¬¦ä¸²å€¼æ˜¯ä¸€ä¸ªç”±é›¶æˆ–å¤šä¸ª Unicode å­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—å’Œå…¶ä»–å­—ç¬¦ï¼‰ç»„æˆçš„åºåˆ—ã€‚

å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦å‡å¯ç”±ä¸€ä¸ªè½¬ä¹‰åºåˆ—è¡¨ç¤ºã€‚æ¯”å¦‚å­—æ¯ `a`ï¼Œä¹Ÿå¯ä»¥ç”¨è½¬ä¹‰åºåˆ— `\u0061` è¡¨ç¤ºã€‚

> è½¬ä¹‰åºåˆ—ä»¥åæ–œæ  `\` å¼€å¤´ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘ŠçŸ¥ JavaScript è§£é‡Šå™¨ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯ç‰¹æ®Šå­—ç¬¦ã€‚

> è½¬ä¹‰åºåˆ—çš„è¯­æ³•ä¸º `\uhhhh`ï¼Œå…¶ä¸­ hhhh æ˜¯å››ä½åå…­è¿›åˆ¶æ•°ã€‚

æ ¹æ®è¿™ä¸ªè§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºå¸¸è§å­—ç¬¦çš„è½¬ä¹‰åºåˆ—ï¼Œä»¥å­—æ¯ `m` ä¸ºä¾‹ï¼š

```js
// 1. æ±‚å‡ºå­—ç¬¦ `m` å¯¹åº”çš„ unicode å€¼
var unicode = 'm'.charCodeAt(0); // 109
// 2. è½¬æˆåå…­è¿›åˆ¶
var result = unicode.toString(16); // "6d"
```

æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `\u006d` è¡¨ç¤º `m`ï¼Œä¸ä¿¡ä½ å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥å­—ç¬¦ä¸² `'\u006d'`ï¼Œçœ‹ä¸‹æ‰“å°ç»“æœã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯: `\n` è™½ç„¶ä¹Ÿæ˜¯ä¸€ç§è½¬ä¹‰åºåˆ—ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼ï¼š

```js
var unicode = '\n'.charCodeAt(0); // 10
var result = unicode.toString(16); // "a"
```

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ `\u000A` æ¥è¡¨ç¤ºæ¢è¡Œç¬¦ `\n`ï¼Œæ¯”å¦‚åœ¨æµè§ˆå™¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥ `'a \n b'` å’Œ `'a \u000A b'` æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

è®²äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›å¸¸ç”¨å­—ç¬¦çš„è½¬ä¹‰åºåˆ—ä»¥åŠå«ä¹‰ï¼š

| Unicode å­—ç¬¦å€¼ | è½¬ä¹‰åºåˆ— | å«ä¹‰      |
|:--------------|:-------|:---------|
| \u0009        | \t     | åˆ¶è¡¨ç¬¦     |
| \u000A        | \n     | æ¢è¡Œ      |
| \u000D        | \r     | å›è½¦      |
| \u0022        | \"     | åŒå¼•å·     |
| \u0027        | \'     | å•å¼•å·     |
| \u005C        | \\     | åæ–œæ      |
| \u2028        |        | è¡Œåˆ†éš”ç¬¦   |
| \u2029        |        | æ®µè½åˆ†éš”ç¬¦ |

## ä¸‰. Line Terminators

Line Terminatorsï¼Œä¸­æ–‡è¯‘æ–‡ `è¡Œç»ˆç»“ç¬¦`ã€‚åƒç©ºç™½å­—ç¬¦ä¸€æ ·ï¼Œ`è¡Œç»ˆç»“ç¬¦` å¯ç”¨äºæ”¹å–„æºæ–‡æœ¬çš„å¯è¯»æ€§ã€‚

åœ¨ ES5 ä¸­ï¼Œæœ‰å››ä¸ªå­—ç¬¦è¢«è®¤ä¸ºæ˜¯ `è¡Œç»ˆç»“ç¬¦`ï¼Œå…¶ä»–çš„æŠ˜è¡Œå­—ç¬¦éƒ½ä¼šè¢«è§†ä¸ºç©ºç™½ã€‚

è¿™å››ä¸ªå­—ç¬¦å¦‚ä¸‹æ‰€ç¤ºï¼š

| å­—ç¬¦ç¼–ç å€¼ | åç§°      |
|:---------|:---------|
| \u000A   | æ¢è¡Œç¬¦    |
| \u000D   | å›è½¦ç¬¦    |
| \u2028   | è¡Œåˆ†éš”ç¬¦   |
| \u2029   | æ®µè½åˆ†éš”ç¬¦ |

## å››. Function

è¯•æƒ³æˆ‘ä»¬å†™è¿™æ ·ä¸€æ®µä»£ç ï¼Œèƒ½å¦æ­£ç¡®è¿è¡Œï¼š

```js
var log = new Function("var a = '1\t23';console.log(a)");
log();
```

ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œé‚£ä¸‹é¢è¿™æ®µå‘¢ï¼š

```js
var log = new Function("var a = '1\n23';console.log(a)");
log();
```

ç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œä¼šæŠ¥é”™ `Uncaught SyntaxError: Invalid or unexpected token`ã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºåœ¨ Function æ„é€ å‡½æ•°çš„å®ç°ä¸­ï¼Œé¦–å…ˆä¼šå°†å‡½æ•°ä½“ä»£ç å­—ç¬¦ä¸²è¿›è¡Œä¸€æ¬¡ `ToString` æ“ä½œï¼Œè¿™æ—¶å€™å­—ç¬¦ä¸²å˜æˆäº†ï¼š

```
var a = '1
23';console.log(a)
```

ç„¶åå†æ£€æµ‹ä»£ç å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆä»£ç è§„èŒƒï¼Œåœ¨ JavaScript ä¸­ï¼Œ**å­—ç¬¦ä¸²è¡¨è¾¾å¼ä¸­æ˜¯ä¸å…è®¸æ¢è¡Œçš„**ï¼Œè¿™å°±å¯¼è‡´äº†æŠ¥é”™ã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»£ç ä¿®æ”¹ä¸ºï¼š

```js
var log = new Function("var a = '1\\n23';console.log(a)");
log();
```

å…¶å®ä¸æ­¢ `\n`ï¼Œå…¶ä»–ä¸‰ç§ `è¡Œç»ˆç»“ç¬¦`ï¼Œå¦‚æœä½ åœ¨å­—ç¬¦ä¸²è¡¨è¾¾å¼ä¸­ç›´æ¥ä½¿ç”¨ï¼Œéƒ½ä¼šå¯¼è‡´æŠ¥é”™ï¼

ä¹‹æ‰€ä»¥è®²è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºåœ¨æ¨¡æ¿å¼•æ“çš„å®ç°ä¸­ï¼Œå°±æ˜¯ä½¿ç”¨äº† Function æ„é€ å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ä½¿ç”¨äº† `è¡Œç»ˆç»“ç¬¦`ï¼Œä¾¿æœ‰å¯èƒ½ä¼šå‡ºç°ä¸€æ ·çš„é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦å¯¹è¿™å››ç§ `è¡Œç»ˆç»“ç¬¦` è¿›è¡Œç‰¹æ®Šçš„å¤„ç†ã€‚

## äº”. ç‰¹æ®Šå­—ç¬¦

é™¤äº†è¿™å››ç§ `è¡Œç»ˆç»“ç¬¦` ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜è¦å¯¹ä¸¤ä¸ªå­—ç¬¦è¿›è¡Œå¤„ç†ã€‚

ä¸€ä¸ªæ˜¯ `\`ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬çš„æ¨¡æ¿å†…å®¹ä¸­ä½¿ç”¨äº† `\`:

```js
var log = new Function("var a = '1\23';console.log(a)");
log(); // 1
```

å…¶å®æˆ‘ä»¬æ˜¯æƒ³æ‰“å° `'1\23'`ï¼Œä½†æ˜¯å› ä¸ºæŠŠ `\` å½“æˆäº†ç‰¹æ®Šå­—ç¬¦çš„æ ‡è®°è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å°äº† 1ã€‚

åŒæ ·çš„é“ç†ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨æ¨¡æ¿å¼•æ“çš„æ—¶å€™ï¼Œä½¿ç”¨äº† `\` å­—ç¬¦ä¸²ï¼Œä¹Ÿä¼šå¯¼è‡´é”™è¯¯çš„å¤„ç†ã€‚

ç¬¬äºŒä¸ªæ˜¯ `'`ã€‚

å¦‚æœæˆ‘ä»¬åœ¨æ¨¡æ¿å¼•æ“ä¸­ä½¿ç”¨äº† `'`ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šæ‹¼æ¥è¯¸å¦‚ `p.push(' ')` ç­‰å­—ç¬¦ä¸²ï¼Œå› ä¸º `'` çš„åŸå› ï¼Œå­—ç¬¦ä¸²ä¼šè¢«é”™è¯¯æ‹¼æ¥ï¼Œä¹Ÿä¼šå¯¼è‡´é”™è¯¯ã€‚

æ‰€ä»¥æ€»å…±æˆ‘ä»¬éœ€è¦å¯¹å…­ç§å­—ç¬¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå¤„ç†çš„æ–¹å¼ï¼Œå°±æ˜¯æ­£åˆ™åŒ¹é…å‡ºè¿™äº›ç‰¹æ®Šå­—ç¬¦ï¼Œç„¶åæ¯”å¦‚å°† `\n` æ›¿æ¢æˆ `\\n`ï¼Œ`\` æ›¿æ¢æˆ `\\`ï¼Œ`'` æ›¿æ¢æˆ `\\'`ï¼Œå¤„ç†çš„ä»£ç ä¸ºï¼š

```js
var escapes = {
    "'": "'",
    '\\': '\\',
    '\r': 'r',
    '\n': 'n',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
};

var escapeRegExp = /\\|'|\r|\n|\u2028|\u2029/g;

var escapeChar = function(match) {
    return '\\' + escapes[match];
};
```

æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š

```js
var str = 'console.log("I am \n Kevin");';
var newStr = str.replace(escapeRegExp, escapeChar);

eval(newStr);
// I am 
// Kevin
```

## å…­. replace

æˆ‘ä»¬æ¥è®²ä¸€è®²å­—ç¬¦ä¸²çš„ replace å‡½æ•°ï¼š

è¯­æ³•ä¸ºï¼š

```js
str.replace(regexp|substr, newSubStr|function);
```

replace çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯ä»¥ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¼ ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚

ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥ä¼ ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¼ ä¸€ä¸ªå‡½æ•°ã€‚

æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ä¼ å…¥å‡½æ•°çš„æƒ…å†µï¼Œç®€å•ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

```js
var str = 'hello world';
var newStr = str.replace('world', function(match){
  return match + '!';
})
console.log(newStr); // hello world!
```

match è¡¨ç¤ºåŒ¹é…åˆ°çš„å­—ç¬¦ä¸²ï¼Œä½†å‡½æ•°çš„å‚æ•°å…¶å®ä¸æ­¢æœ‰ matchï¼Œæˆ‘ä»¬çœ‹ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼š

```js
function replacer(match, p1, p2, p3, offset, string) {
    // matchï¼Œè¡¨ç¤ºåŒ¹é…çš„å­ä¸² abc12345#$*%
    // p1ï¼Œç¬¬ 1 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² abc
    // p2ï¼Œç¬¬ 2 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² 12345
    // p3ï¼Œç¬¬ 3 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² #$*%
    // offsetï¼ŒåŒ¹é…åˆ°çš„å­å­—ç¬¦ä¸²åœ¨åŸå­—ç¬¦ä¸²ä¸­çš„åç§»é‡ 0
    // stringï¼Œè¢«åŒ¹é…çš„åŸå­—ç¬¦ä¸² abc12345#$*%
    return [p1, p2, p3].join(' - ');
}
var newString = 'abc12345#$*%'.replace(/([^\d]*)(\d*)([^\w]*)/, replacer); // abc - 12345 - #$*%
```

å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”å…¶ä¸ºå…¨å±€åŒ¹é…æ¨¡å¼ï¼Œ é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°†è¢«å¤šæ¬¡è°ƒç”¨ï¼Œæ¯æ¬¡åŒ¹é…éƒ½ä¼šè¢«è°ƒç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨ä¸€æ®µå­—ç¬¦ä¸²ä¸­åŒ¹é…å‡º `<%=xxx%>` ä¸­çš„å€¼ï¼š

```js
var str = '<li><a href="<%=www.baidu.com%>"><%=baidu%></a></li>'

str.replace(/<%=(.+?)%>/g, function(match, p1, offset, string){
    console.log(match);
    console.log(p1);
    console.log(offset);
    console.log(string);
})
```

ä¼ å…¥çš„å‡½æ•°ä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡çš„æ‰“å°ç»“æœä¸ºï¼š

```
<%=www.baidu.com%>
www.baidu.com
13
<li><a href="<%=www.baidu.com%>"><%=baidu%></a></li>
```

ç¬¬äºŒæ¬¡çš„æ‰“å°ç»“æœä¸ºï¼š

```
<%=baidu%>
'baidu'
33
<li><a href="<%=www.baidu.com%>"><%=baidu%></a></li>
```

## ä¸ƒ. æ­£åˆ™è¡¨è¾¾å¼çš„åˆ›å»º

å½“æˆ‘ä»¬è¦å»ºç«‹ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºï¼š

```js
var reg = /ab+c/i;
```

ä¹Ÿå¯ä»¥ä½¿ç”¨æ„é€ å‡½æ•°çš„æ–¹å¼ï¼š

```js
new RegExp('ab+c', 'i');
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼šæ¯ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª source å±æ€§ï¼Œè¿”å›å½“å‰æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡çš„æ¨¡å¼æ–‡æœ¬çš„å­—ç¬¦ä¸²ï¼š

```js
var regex = /fooBar/ig;
console.log(regex.source); // "fooBar"ï¼Œä¸åŒ…å« /.../ å’Œ "ig"ã€‚
```

## å…«. æ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šå­—ç¬¦

æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œæ¯”å¦‚ `\d` å°±è¡¨ç¤ºäº†åŒ¹é…ä¸€ä¸ªæ•°å­—ï¼Œç­‰ä»·äº [0-9]ã€‚

åœ¨ä¸ŠèŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ `/<%=(.+?)%>/g` æ¥åŒ¹é… `<%=xxx%>`ï¼Œç„¶è€Œåœ¨ underscore çš„å®ç°ä¸­ï¼Œç”¨çš„å´æ˜¯ `/<%=([\s\S]+?)%>/g`ã€‚

æˆ‘ä»¬çŸ¥é“ \s è¡¨ç¤ºåŒ¹é…ä¸€ä¸ªç©ºç™½ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦ã€æ¢è¡Œç¬¦å’Œå…¶ä»– Unicode ç©ºæ ¼ï¼Œ\S
åŒ¹é…ä¸€ä¸ªéç©ºç™½ç¬¦ï¼Œ[\s\S]å°±è¡¨ç¤ºåŒ¹é…æ‰€æœ‰çš„å†…å®¹ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥ä½¿ç”¨ `.` å‘¢ï¼Ÿ

æˆ‘ä»¬å¯èƒ½ä»¥ä¸º `.` åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦ï¼Œå®é™…ä¸Šï¼Œå¹¶ä¸æ˜¯å¦‚æ­¤ï¼Œ `.` åŒ¹é…é™¤ `è¡Œç»ˆç»“ç¬¦` ä¹‹å¤–çš„ä»»ä½•å•ä¸ªå­—ç¬¦ï¼Œä¸ä¿¡æˆ‘ä»¬åšä¸ªè¯•éªŒï¼š

```js
var str = '<%=hello world%>';

str.replace(/<%=(.+?)%>/g, function(match){
  console.log(match); // <%=hello world%>
})
```

ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨ hello world ä¹‹é—´åŠ ä¸Šä¸€ä¸ª `è¡Œç»ˆç»“ç¬¦`ï¼Œæ¯”å¦‚è¯´ `'\u2029'`ï¼š

```js
var str = '<%=hello \u2029 world%>';

str.replace(/<%=(.+?)%>/g, function(match){
  console.log(match);
})
```

å› ä¸ºåŒ¹é…ä¸åˆ°ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæ‰§è¡Œ console.log å‡½æ•°ã€‚

ä½†æ˜¯æ”¹æˆ `/<%=([\s\S]+?)%>/g` å°±å¯ä»¥æ­£å¸¸åŒ¹é…ï¼š

```js
var str = '<%=hello \u2029 world%>';

str.replace(/<%=([\s\S]+?)%>/g, function(match){
  console.log(match); // <%=hello world%>
})
```

## ä¹. æƒ°æ€§åŒ¹é…

ä»”ç»†çœ‹ `/<%=([\s\S]+?)%>/g` è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬çŸ¥é“ `x+` è¡¨ç¤ºåŒ¹é… `x` 1 æ¬¡æˆ–å¤šæ¬¡ã€‚`x?` è¡¨ç¤ºåŒ¹é… `x` 0 æ¬¡æˆ– 1 æ¬¡ï¼Œä½†æ˜¯ `+?` æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿ

å®é™…ä¸Šï¼Œå¦‚æœåœ¨æ•°é‡è¯ *ã€+ã€? æˆ– {}, ä»»æ„ä¸€ä¸ªåé¢ç´§è·Ÿè¯¥ç¬¦å·ï¼ˆ?ï¼‰ï¼Œä¼šä½¿æ•°é‡è¯å˜ä¸ºéè´ªå©ªï¼ˆ non-greedyï¼‰ ï¼Œå³åŒ¹é…æ¬¡æ•°æœ€å°åŒ–ã€‚åä¹‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯è´ªå©ªçš„ï¼ˆgreedyï¼‰ï¼Œå³åŒ¹é…æ¬¡æ•°æœ€å¤§åŒ–ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
console.log("aaabc".replace(/a+/g, "d")); // dbc

console.log("aaabc".replace(/a+?/g, "d")); // dddbc
```

åœ¨è¿™é‡Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨éæƒ°æ€§åŒ¹é…ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
var str = '<li><a href="<%=www.baidu.com%>"><%=baidu%></a></li>';

str.replace(/<%=(.+?)%>/g, function(match){
    console.log(match);
})

// <%=www.baidu.com%>
// <%=baidu%>
```

å¦‚æœæˆ‘ä»¬ä½¿ç”¨æƒ°æ€§åŒ¹é…ï¼š

```js
var str = '<li><a href="<%=www.baidu.com%>"><%=baidu%></a></li>';

str.replace(/<%=(.+)%>/g, function(match){
  console.log(match);
})

// <%=www.baidu.com%>"><%=baidu%>
```

## å. template

è®²å®Œéœ€è¦çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬å¼€å§‹è®² underscore æ¨¡æ¿å¼•æ“çš„å®ç°ã€‚

ä¸æˆ‘ä»¬ä¸Šç¯‡ä½¿ç”¨æ•°ç»„çš„ push ï¼Œæœ€åå† join çš„æ–¹æ³•ä¸åŒï¼Œunderscore ä½¿ç”¨çš„æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ã€‚

æ¯”å¦‚ä¸‹é¢è¿™æ ·ä¸€æ®µæ¨¡æ¿å­—ç¬¦ä¸²ï¼š

```
<%for ( var i = 0; i < users.length; i++ ) { %>
    <li>
        <a href="<%=users[i].url%>">
            <%=users[i].name%>
        </a>
    </li>
<% } %>
```

æˆ‘ä»¬å…ˆå°† `<%=xxx%>` æ›¿æ¢æˆ `'+ xxx +'`ï¼Œå†å°† `<%xxx%>` æ›¿æ¢æˆ `'; xxx __p+='`:

```
';for ( var i = 0; i < users.length; i++ ) { __p+='
    <li>
        <a href="'+ users[i].url + '">
            '+ users[i].name +'
        </a>
    </li>
';  } __p+='
```

è¿™æ®µä»£ç è‚¯å®šä¼šè¿è¡Œé”™è¯¯çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ·»åŠ äº›å¤´å°¾ä»£ç ï¼Œç„¶åç»„æˆä¸€ä¸ªå®Œæ•´çš„ä»£ç å­—ç¬¦ä¸²ï¼š

```
var __p='';
with(obj){
__p+='

';for ( var i = 0; i < users.length; i++ ) { __p+='
    <li>
        <a href="'+ users[i].url + '">
            '+ users[i].name +'
        </a>
    </li>
';  } __p+='

';
};
return __p;
```

æ•´ç†ä¸‹ä»£ç å°±æ˜¯ï¼š

```js
var __p='';
with(obj){
    __p+='';
    for ( var i = 0; i < users.length; i++ ) { 
        __p+='<li><a href="'+ users[i].url + '"> '+ users[i].name +'</a></li>';
    }
    __p+='';
};
return __p
```

ç„¶åæˆ‘ä»¬å°† `__p` è¿™æ®µä»£ç å­—ç¬¦ä¸²ä¼ å…¥ Function æ„é€ å‡½æ•°ä¸­ï¼š

```js
var render = new Function(data, __p);
```

æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ª render å‡½æ•°ï¼Œä¼ å…¥éœ€è¦çš„ data æ•°æ®ï¼Œå°±å¯ä»¥è¿”å›ä¸€æ®µ HTML å­—ç¬¦ä¸²ï¼š

```js
render(data);
```

## åä¸€. ç¬¬äº”ç‰ˆ - ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†

<!--æˆ‘ä»¬æ¥ç€ä¸Šç¯‡çš„ [ç¬¬å››ç‰ˆ](06.underscore%20ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“%28ä¸Š%29.md#ä¸ƒ-ç¬¬å››ç‰ˆ) è¿›è¡Œä¹¦å†™ï¼Œä¸è¿‡åŠ å…¥å¯¹ç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰ä»¥åŠä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼š-->
æˆ‘ä»¬æ¥ç€ä¸Šç¯‡çš„ [ç¬¬å››ç‰ˆ](06.underscoreç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“-ä¸Š.md#ä¸ƒ-ç¬¬å››ç‰ˆ) è¿›è¡Œä¹¦å†™ï¼Œä¸è¿‡åŠ å…¥å¯¹ç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰ä»¥åŠä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼š

```js
// ç¬¬äº”ç‰ˆ
var settings = {
    // æ±‚å€¼
    evaluate: /<%([\s\S]+?)%>/g,
    // æ’å…¥
    interpolate: /<%=([\s\S]+?)%>/g,
};

var escapes = {
    "'": "'",
    '\\': '\\',
    '\r': 'r',
    '\n': 'n',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
};

var escapeRegExp = /\\|'|\r|\n|\u2028|\u2029/g;

var template = function(text) {

    var source = "var __p='';\n";
    source = source + "with(obj){\n"
    source = source + "__p+='";

    var main = text
    .replace(escapeRegExp, function(match) {
        return '\\' + escapes[match];
    })
    .replace(settings.interpolate, function(match, interpolate){
        return "'+\n" + interpolate + "+\n'"
    })
    .replace(settings.evaluate, function(match, evaluate){
        return "';\n " + evaluate + "\n__p+='"
    })

    source = source + main + "';\n }; \n return __p;";

    console.log(source)

    var render = new Function('obj',  source);

    return render;
};
```

## åäºŒ. ç¬¬å…­ç‰ˆ - ç‰¹æ®Šå€¼çš„å¤„ç†

ä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

å¦‚æœæ•°æ®ä¸­ `users[i].url` ä¸å­˜åœ¨æ€ä¹ˆåŠï¼Ÿæ­¤æ—¶å–å€¼çš„ç»“æœä¸º undefinedï¼Œæˆ‘ä»¬çŸ¥é“ï¼š

```js
'1' + undefined // "1undefined"
```

å°±ç›¸å½“äºæ‹¼æ¥äº† undefined å­—ç¬¦ä¸²ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥ä¸€ç‚¹åˆ¤æ–­ï¼š

```js
.replace(settings.interpolate, function(match, interpolate){
    return "'+\n" + (interpolate == null ? '' : interpolate) + "+\n'"
})
```

ä½†æ˜¯å§ï¼Œæˆ‘å°±æ˜¯ä¸å–œæ¬¢å†™ä¸¤é interpolate â€¦â€¦ å—¯ï¼Ÿé‚£å°±è¿™æ ·å§ï¼š

```js
var source = "var __t, __p='';\n";

...

.replace(settings.interpolate, function(match, interpolate){
    return "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'"
})
```

å…¶å®å°±ç›¸å½“äºï¼š

```js
var __t;

var result = (__t = interpolate) == null ? '' : __t;
```

## åä¸‰. ç¬¬ä¸ƒç‰ˆ

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼æ˜¯å°†æ¨¡æ¿å­—ç¬¦ä¸²è¿›è¡Œå¤šæ¬¡æ›¿æ¢ï¼Œç„¶è€Œåœ¨ underscore çš„å®ç°ä¸­ï¼Œåªè¿›è¡Œäº†ä¸€æ¬¡æ›¿æ¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ underscore æ˜¯æ€ä¹ˆå®ç°çš„ï¼š

```js
var template = function(text) {
    var matcher = RegExp([
        (settings.interpolate).source,
        (settings.evaluate).source
    ].join('|') + '|$', 'g');

    var index = 0;
    var source = "__p+='";

    text.replace(matcher, function(match, interpolate, evaluate, offset) {
        source += text.slice(index, offset).replace(escapeRegExp, function(match) {
            return '\\' + escapes[match];
        });

        index = offset + match.length;

        if (interpolate) {
            source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
        } else if (evaluate) {
            source += "';\n" + evaluate + "\n__p+='";
        }

        return match;
    });

    source += "';\n";

    source = 'with(obj||{}){\n' + source + '}\n'

    source = "var __t, __p='';" +
        source + 'return __p;\n';

    var render = new Function('obj', source);

    return render;
};
```

å…¶å®åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œå¤šæ¬¡åŒ¹é…å‡½æ•°çš„æ—¶å€™ï¼Œä¸æ–­å¤åˆ¶å­—ç¬¦ä¸²ï¼Œå¤„ç†å­—ç¬¦ä¸²ï¼Œæ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæœ€åæ‹¼æ¥é¦–å°¾ä»£ç ï¼Œå¾—åˆ°æœ€ç»ˆçš„ä»£ç å­—ç¬¦ä¸²ã€‚

ä¸è¿‡å€¼å¾—ä¸€æçš„æ˜¯ï¼šåœ¨è¿™æ®µä»£ç é‡Œï¼Œmatcher çš„è¡¨è¾¾å¼æœ€åä¸ºï¼š`/<%=([\s\S]+?)%>|<%([\s\S]+?)%>|$/g`

é—®é¢˜æ˜¯ä¸ºä»€ä¹ˆè¿˜è¦åŠ ä¸ª `|$` å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ $ï¼š

```js
var str = "abc";
str.replace(/$/g, function(match, offset){
    console.log(typeof match) // ç©ºå­—ç¬¦ä¸²
    console.log(offset) // 3
    return match
})
```

æˆ‘ä»¬ä¹‹æ‰€ä»¥åŒ¹é… $ï¼Œæ˜¯ä¸ºäº†è·å–æœ€åä¸€ä¸ªå­—ç¬¦ä¸²çš„ä½ç½®ï¼Œè¿™æ ·å½“æˆ‘ä»¬ text.slice(index, offset)çš„æ—¶å€™ï¼Œå°±å¯ä»¥æˆªå–åˆ°æœ€åä¸€ä¸ªå­—ç¬¦ã€‚

## åå››. æœ€ç»ˆç‰ˆ

å…¶å®ä»£ç å†™åˆ°è¿™é‡Œï¼Œå°±å·²ç»è·Ÿ underscore çš„å®ç°å¾ˆæ¥è¿‘äº†ï¼Œåªæ˜¯ underscore åŠ å…¥äº†æ›´å¤šç»†èŠ‚çš„å¤„ç†ï¼Œæ¯”å¦‚ï¼š

1. å¯¹æ•°æ®çš„è½¬ä¹‰åŠŸèƒ½
2. å¯ä¼ å…¥é…ç½®é¡¹
3. å¯¹é”™è¯¯çš„å¤„ç†
4. æ·»åŠ  source å±æ€§ï¼Œä»¥æ–¹ä¾¿æŸ¥çœ‹ä»£ç å­—ç¬¦ä¸²
5. æ·»åŠ äº†æ–¹ä¾¿è°ƒè¯•çš„ print å‡½æ•°
6. ...

ä½†æ˜¯è¿™äº›å†…å®¹éƒ½è¿˜ç®—ç®€å•ï¼Œå°±ä¸ä¸€ç‰ˆä¸€ç‰ˆå†™äº†ï¼Œ

```js
/**
 * æ¨¡æ¿å¼•æ“ç¬¬å…«ç‰ˆ
 */
var _ = {};

_.templateSettings = {
    // æ±‚å€¼
    evaluate: /<%([\s\S]+?)%>/g,
    // æ’å…¥
    interpolate: /<%=([\s\S]+?)%>/g,
    // è½¬ä¹‰
    escape: /<%-([\s\S]+?)%>/g
};

var noMatch = /(.)^/;

var escapes = {
    "'": "'",
    '\\': '\\',
    '\r': 'r',
    '\n': 'n',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
};

var escapeRegExp = /\\|'|\r|\n|\u2028|\u2029/g;

var escapeChar = function(match) {
    return '\\' + escapes[match];
};

_.template = function(text, settings) {

    settings = Object.assign({}, _.templateSettings, settings);

    var matcher = RegExp([
        (settings.escape || noMatch).source,
        (settings.interpolate || noMatch).source,
        (settings.evaluate || noMatch).source
    ].join('|') + '|$', 'g');

    var index = 0;
    var source = "__p+='";
    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {

        source += text.slice(index, offset).replace(escapeRegExp, escapeChar);

        index = offset + match.length;

        if (escape) {
            source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
        } else if (interpolate) {
            source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
        } else if (evaluate) {
            source += "';\n" + evaluate + "\n__p+='";
        }

        return match;
    });
    source += "';\n";

    if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';

    source = "var __t,__p='',__j=Array.prototype.join," +
        "print=function(){__p+=__j.call(arguments,'');};\n" +
        source + 'return __p;\n';

    var render;
    try {
        render = new Function(settings.variable || 'obj', '_', source);
    } catch (e) {
        e.source = source;
        throw e;
    }

    var template = function(data) {
        return render.call(this, data, _);
    };

    var argument = settings.variable || 'obj';
    template.source = 'function(' + argument + '){\n' + source + '}';

    return template;
};

var results = document.getElementById("container");

var data = {
    users: [
        { "name": "Byron", "url": "http://localhost" },
        { "name": "Casper", "url": "http://localhost" },
        { "name": "Frank", "url": "http://localhost" }
    ]
}

var text = document.getElementById("user_tmpl").innerHTML
var compiled = _.template(text);

console.log(compiled.source)
results.innerHTML = compiled(data);
```
