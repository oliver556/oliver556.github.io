---
title: underscore ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“(ä¸Š)
date: 2021-11-14 11:17:25
permalink: /pages/5d25f3/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - underscoreç³»åˆ—
author:
  name: Jamison
  link: https://github.com/oliver556
---

# underscore ç³»åˆ—ä¹‹å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“(ä¸Š)

## ğŸ“–. å‰è¨€

underscore æä¾›äº†æ¨¡æ¿å¼•æ“çš„åŠŸèƒ½ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
var tpl = "hello: <%= name %>";

var compiled = _.template(tpl);
compiled({name: 'Kevin'}); // "hello: Kevin"
```

æ„Ÿè§‰å¥½åƒæ²¡æœ‰ä»€ä¹ˆå¼ºå¤§çš„åœ°æ–¹ï¼Œå†æ¥ä¸¾ä¸ªä¾‹å­ï¼š

åœ¨ HTML æ–‡ä»¶ä¸­ï¼š

```html
<ul id="name_list"></ul>

<script type="text/html" id="user_tmpl">
    <%for ( var i = 0; i < users.length; i++ ) { %>
        <li>
            <a href="<%=users[i].url%>">
                <%=users[i].name%>
            </a>
        </li>
    <% } %>
</script>
```

JavaScript æ–‡ä»¶ä¸­ï¼š

```js
var container = document.getElementById("name_list");

var data = {
    users: [
      { "name": "Kevin", "url": "http://localhost" },
      { "name": "Daisy", "url": "http://localhost" },
      { "name": "Kelly", "url": "http://localhost" }
    ]
}
var precompile = _.template(document.getElementById("user_tmpl").innerHTML);
var html = precompile(data);

container.innerHTML = html;
```

æ•ˆæœä¸ºï¼š

![javascript_05-06_01](https://cdn.jsdelivr.net/gh/oliver556/image-hosting@master/20220506/javascript_05-06_01.10qdyn3k4mf4.webp)

é‚£ä¹ˆè¯¥å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ª _.template å‡½æ•°å‘¢ï¼Ÿ

## ä¸€. å®ç°æ€è·¯

underscore çš„ template å‡½æ•°å‚è€ƒäº† jQuery çš„ä½œè€… John Resig åœ¨ 2008 å¹´å‘è¡¨çš„ä¸€ç¯‡æ–‡ç«  [JavaScript Micro-Templating](https://johnresig.com/blog/javascript-micro-templating/#postcomment) ï¼Œ  
æˆ‘ä»¬å…ˆä»è¿™ç¯‡æ–‡ç« çš„æ€è·¯å‡ºå‘ï¼Œæ€è€ƒä¸€ä¸‹å¦‚ä½•å†™ä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“ã€‚

ä¾ç„¶æ˜¯ä»¥è¿™æ®µæ¨¡æ¿å­—ç¬¦ä¸²ä¸ºä¾‹ï¼š

```html
<%for ( var i = 0; i < users.length; i++ ) { %>
    <li>
        <a href="<%=users[i].url%>">
            <%=users[i].name%>
        </a>
    </li>
<% } %>
```

John Resig çš„æ€è·¯æ˜¯å°†è¿™æ®µä»£ç è½¬æ¢ä¸ºè¿™æ ·ä¸€æ®µç¨‹åºï¼š

```js
// æ¨¡æ‹Ÿæ•°æ®
var users = [{"name": "Kevin", "url": "http://localhost"}];

var p = [];
for (var i = 0; i < users.length; i++) {
    p.push('<li><a href="');
    p.push(users[i].url);
    p.push('">');
    p.push(users[i].name);
    p.push('</a></li>');
}

// æœ€å join ä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆæ‹¼æ¥å¥½çš„æ¨¡æ¿å­—ç¬¦ä¸²
console.log(p.join('')) // <li><a href="http://localhost">Kevin</a></li>
```

æˆ‘ä»¬æ³¨æ„ï¼Œæ¨¡æ¿å…¶å®æ˜¯ä¸€æ®µå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬æ€ä¹ˆæ ¹æ®ä¸€æ®µå­—ç¬¦ä¸²ç”Ÿæˆä¸€æ®µä»£ç å‘¢ï¼Ÿå¾ˆå®¹æ˜“å°±æƒ³åˆ°ç”¨ evalï¼Œé‚£æˆ‘ä»¬å°±å…ˆç”¨ eval å§ã€‚

ç„¶åæˆ‘ä»¬ä¼šå‘ç°ï¼Œä¸ºäº†è½¬æ¢æˆè¿™æ ·ä¸€æ®µä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å°† `<%xxx%>` è½¬æ¢ä¸º `xxx`ï¼Œå…¶å®å°±æ˜¯å»æ‰åŒ…è£¹çš„ç¬¦å·ï¼Œè¿˜è¦å°† `<%=xxx%>` è½¬åŒ–æˆ `p.push(xxx)`ï¼Œè¿™äº›éƒ½å¯ä»¥ç”¨æ­£åˆ™å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å†™
`p.push('<li><a href="');` ã€`p.push('">');` å‘ï¼Œè¿™äº›è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

é‚£æˆ‘ä»¬æ¢ä¸ªæ€è·¯ï¼Œä¾ç„¶æ˜¯ç”¨æ­£åˆ™ï¼Œä½†æ˜¯æˆ‘ä»¬

1. å°† `%>` æ›¿æ¢æˆ `p.push('`
2. å°† `<%` æ›¿æ¢æˆ `');`
3. å°† `<%=xxx%>` æ›¿æ¢æˆ `');p.push(xxx);p.push('`

æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼š

```html
<%for ( var i = 0; i < users.length; i++ ) { %>
    <li>
        <a href="<%=users[i].url%>">
            <%=users[i].name%>
        </a>
    </li>
<% } %>
```

æŒ‰ç…§è¿™ä¸ªæ›¿æ¢è§„åˆ™ä¼šè¢«æ›¿æ¢ä¸ºï¼š

```html
');for ( var i = 0; i < users.length; i++ ) { p.push('
    <li>
        <a href="');p.push(users[i].url);p.push('">
            ');p.push(users[i].name);p.push('
        </a>
    </li>
'); } p.push('
```

è¿™æ ·è‚¯å®šä¼šæŠ¥é”™ï¼Œæ¯•ç«Ÿä»£ç éƒ½æ²¡æœ‰å†™å…¨ï¼Œæˆ‘ä»¬åœ¨é¦–å’Œå°¾åŠ ä¸Šéƒ¨åˆ†ä»£ç ï¼Œå˜æˆï¼š

```html
// æ·»åŠ çš„é¦–éƒ¨ä»£ç 
var p = []; p.push('

');for ( var i = 0; i < users.length; i++ ) { p.push('
    <li>
        <a href="');p.push(users[i].url);p.push('">
            ');p.push(users[i].name);p.push('
        </a>
    </li>
'); } p.push('

// æ·»åŠ çš„å°¾éƒ¨ä»£ç 
');
```

æˆ‘ä»¬æ•´ç†ä¸‹è¿™æ®µä»£ç ï¼š

```js
var p = []; p.push('');
for ( var i = 0; i < users.length; i++ ) { 
    p.push('<li><a href="');
    p.push(users[i].url);
    p.push('">');
    p.push(users[i].name);
    p.push('</a></li>'); 
}
    p.push('');
```

æ°å¥½å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä¸è¿‡è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¦å°†æ¢è¡Œç¬¦æ›¿æ¢æˆç©ºæ ¼ï¼Œé˜²æ­¢è§£ææˆä»£ç çš„æ—¶å€™æŠ¥é”™ï¼Œä¸è¿‡åœ¨è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç†è§£åŸç†ï¼Œå°±åªåœ¨ä»£ç é‡Œå®ç°ã€‚

## äºŒ. ç¬¬ä¸€ç‰ˆ

æˆ‘ä»¬æ¥å°è¯•å®ç°ç¬¬ä¸€ç‰ˆï¼š

```js
// ç¬¬ä¸€ç‰ˆ
function tmpl(str, data) {
    var str = document.getElementById(str).innerHTML;

    var string = "var p = []; p.push('" +
    str
    .replace(/[\r\t\n]/g, "")
    .replace(/<%=(.*?)%>/g, "');p.push($1);p.push('")
    .replace(/<%/g, "');")
    .replace(/%>/g,"p.push('")
    + "');"

    eval(string)

    return p.join('');
};
```

ä¸ºäº†éªŒè¯æ˜¯å¦æœ‰ç”¨ï¼š

HTML æ–‡ä»¶ï¼š

```html
<script type="text/html" id="user_tmpl">
    <%for ( var i = 0; i < users.length; i++ ) { %>
        <li>
            <a href="<%=users[i].url%>">
                <%=users[i].name%>
            </a>
        </li>
    <% } %>
</script>
```

JavaScript æ–‡ä»¶ï¼š

```js
var users = [
    { "name": "Byron", "url": "http://localhost" },
    { "name": "Casper", "url": "http://localhost" },
    { "name": "Frank", "url": "http://localhost" }
]
tmpl("user_tmpl", users)
```

## ä¸‰. Function

åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† eval ï¼Œå®é™…ä¸Š John Resig åœ¨æ–‡ç« ä¸­ä½¿ç”¨çš„æ˜¯ Function æ„é€ å‡½æ•°ã€‚

Function æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ Function å¯¹è±¡ã€‚ åœ¨ JavaScript ä¸­, æ¯ä¸ªå‡½æ•°å®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ª Function å¯¹è±¡ã€‚

ä½¿ç”¨æ–¹æ³•ä¸ºï¼š

```js
new Function ([arg1[, arg2[, ...argN]],] functionBody);
```

arg1, arg2, ... argN è¡¨ç¤ºå‡½æ•°ç”¨åˆ°çš„å‚æ•°ï¼ŒfunctionBody è¡¨ç¤ºä¸€ä¸ªå«æœ‰åŒ…æ‹¬å‡½æ•°å®šä¹‰çš„ JavaScript è¯­å¥çš„å­—ç¬¦ä¸²ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
var adder = new Function("a", "b", "return a + b");

adder(2, 6); // 8
```

é‚£ä¹ˆ John Resig åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

## å››. ç¬¬äºŒç‰ˆ

ä½¿ç”¨ Function æ„é€ å‡½æ•°ï¼š

```js
// ç¬¬äºŒç‰ˆ
function tmpl(str, data) {
    var str = document.getElementById(str).innerHTML;

    var fn = new Function("obj",

    "var p = []; p.push('" +

    str
    .replace(/[\r\t\n]/g, "")
    .replace(/<%=(.*?)%>/g, "');p.push($1);p.push('")
    .replace(/<%/g, "');")
    .replace(/%>/g,"p.push('")
    + "');return p.join('');");

    return fn(data);
};
```

ä½¿ç”¨æ–¹æ³•ä¾ç„¶è·Ÿç¬¬ä¸€ç‰ˆç›¸åŒã€‚

ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå…¶å® tmpl å‡½æ•°æ²¡æœ‰å¿…è¦ä¼ å…¥ data å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦åœ¨æœ€å return çš„æ—¶å€™ï¼Œä¼ å…¥ data å‚æ•°ï¼Œå³ä½¿ä½ æŠŠè¿™ä¸¤ä¸ªå‚æ•°éƒ½å»æ‰ï¼Œä»£ç è¿˜æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„ã€‚

è¿™æ˜¯å› ä¸º:

> ä½¿ç”¨Functionæ„é€ å™¨ç”Ÿæˆçš„å‡½æ•°ï¼Œå¹¶ä¸ä¼šåœ¨åˆ›å»ºå®ƒä»¬çš„ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºé—­åŒ…ï¼›å®ƒä»¬ä¸€èˆ¬åœ¨å…¨å±€ä½œç”¨åŸŸä¸­è¢«åˆ›å»ºã€‚å½“è¿è¡Œè¿™äº›å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒä»¬åªèƒ½è®¿é—®è‡ªå·±çš„æœ¬åœ°å˜é‡å’Œå…¨å±€å˜é‡ï¼Œ
> ä¸èƒ½è®¿é—®Functionæ„é€ å™¨è¢«è°ƒç”¨ç”Ÿæˆçš„ä¸Šä¸‹æ–‡çš„ä½œç”¨åŸŸã€‚è¿™å’Œä½¿ç”¨å¸¦æœ‰å‡½æ•°è¡¨è¾¾å¼ä»£ç çš„ eval ä¸åŒã€‚

è¿™é‡Œä¹‹æ‰€ä»¥ä¾ç„¶ä¼ å…¥äº† data å‚æ•°ï¼Œæ˜¯ä¸ºäº†ä¸‹ä¸€ç‰ˆåšå‡†å¤‡ã€‚

## äº”. with

ç°åœ¨æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯å®é™…ä¸Šæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ç»“æ„å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚ï¼š

```js
var data = {
    status: 200,
    name: 'kevin',
    friends: [...]
}
```

å¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ•°æ®ç»“æ„ä¼ å…¥ tmpl å‡½æ•°ä¸­ï¼Œåœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ï¼Œå¦‚æœè¦ç”¨åˆ°æŸä¸ªæ•°æ®ï¼Œæ€»æ˜¯éœ€è¦ä½¿ç”¨ `data.name`ã€`data.friends` çš„å½¢å¼æ¥è·å–ï¼Œéº»çƒ¦å°±éº»çƒ¦åœ¨æˆ‘æƒ³ç›´æ¥ä½¿ç”¨ nameã€friends ç­‰å˜é‡ï¼Œè€Œä¸æ˜¯ç¹ççš„ä½¿ç”¨ `data.` æ¥è·å–ã€‚

è¿™åˆè¯¥å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ withã€‚

with è¯­å¥å¯ä»¥æ‰©å±•ä¸€ä¸ªè¯­å¥çš„ä½œç”¨åŸŸé“¾(scope chain)ã€‚å½“éœ€è¦å¤šæ¬¡è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ with åšç®€åŒ–ã€‚æ¯”å¦‚ï¼š

```js
var hostName = location.hostname;
var url = location.href;

// ä½¿ç”¨ with
with(location){
    var hostname = hostname;
    var url = href;
}
```

```js
function Person(){
    this.name = 'Kevin';
    this.age = '18';
}

var person = new Person();

with(person) {
    console.log('my name is ' + name + ', age is ' + age + '.')
}
// my name is Kevin, age is 18.
```

æœ€åï¼šä¸å»ºè®®ä½¿ç”¨ with è¯­å¥ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯æ··æ·†é”™è¯¯å’Œå…¼å®¹æ€§é—®é¢˜çš„æ ¹æºï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿä¼šé€ æˆæ€§èƒ½ä½ä¸‹

## å…­. ç¬¬ä¸‰ç‰ˆ

ä½¿ç”¨ with ï¼Œæˆ‘ä»¬å†å†™ä¸€ç‰ˆä»£ç ï¼š

```js
// ç¬¬ä¸‰ç‰ˆ
function tmpl(str, data) {
    var str = document.getElementById(str).innerHTML;

    var fn = new Function("obj",

    // å…¶å®å°±æ˜¯è¿™é‡Œå¤šæ·»åŠ äº†ä¸€å¥ with(obj){...}
    "var p = []; with(obj){p.push('" +

    str
    .replace(/[\r\t\n]/g, "")
    .replace(/<%=(.*?)%>/g, "');p.push($1);p.push('")
    .replace(/<%/g, "');")
    .replace(/%>/g,"p.push('")
    + "');}return p.join('');");

    return fn(data);
};
```

## ä¸ƒ. ç¬¬å››ç‰ˆ

å¦‚æœæˆ‘ä»¬çš„æ¨¡æ¿ä¸å˜ï¼Œæ•°æ®å´å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœä½¿ç”¨æˆ‘ä»¬çš„ä¹‹å‰å†™çš„ tmpl å‡½æ•°ï¼Œæ¯æ¬¡éƒ½ä¼š new Functionï¼Œè¿™å…¶å®æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå¦‚æœæˆ‘ä»¬èƒ½åœ¨ä½¿ç”¨ tmpl çš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åä½¿ç”¨è¯¥å‡½æ•°ï¼Œä¼ å…¥ä¸åŒçš„æ•°æ®ï¼Œ
åªæ ¹æ®æ•°æ®ä¸åŒæ¸²æŸ“ä¸åŒçš„ html å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥é¿å…è¿™ç§æ— è°“çš„æŸå¤±ã€‚

```js
// ç¬¬å››ç‰ˆ
function tmpl(str, data) {
    var str = document.getElementById(str).innerHTML;

    var fn = new Function("obj",

    "var p = []; with(obj){p.push('" +

    str
    .replace(/[\r\t\n]/g, "")
    .replace(/<%=(.*?)%>/g, "');p.push($1);p.push('")
    .replace(/<%/g, "');")
    .replace(/%>/g,"p.push('")
    + "');}return p.join('');");

    var template = function(data) {
        return fn.call(this, data)
    }
    return template;
};

// ä½¿ç”¨æ—¶
var compiled = tmpl("user_tmpl");
results.innerHTML = compiled(data);
```